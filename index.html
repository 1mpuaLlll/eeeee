<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#020617">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="img/logo.png">
<title>Mini — Messenger</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<style>
:root {
  --bg: #0e0e0e;
  --surface: #1a1a1a;
  --surface2: #242424;
  --surface3: #2d2d2d;
  --accent: #0088cc;
  --accent-light: #2ba0d9;
  --accent-glow: rgba(0, 136, 204, 0.25);
  --accent-rgb: 0, 136, 204;
  --green: #4caf50;
  --red: #e53935;
  --yellow: #ff9800;
  --pink: #e91e63;
  --cyan: #00bcd4;
  --text: #ffffff;
  --text2: #e0e0e0;
  --text3: #9e9e9e;
  --text4: #757575;
  --border: rgba(255,255,255,0.08);
  --border2: rgba(255,255,255,0.12);
  --glass: rgba(26,26,26,0.95);
  --glass2: rgba(26,26,26,0.98);
  --radius: 10px;
  --radius-lg: 14px;
  --shadow: 0 4px 20px rgba(0,0,0,0.3);
  --shadow-glow: 0 0 15px var(--accent-glow);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
  --safe-top: env(safe-area-inset-top,0);
  --safe-bottom: env(safe-area-inset-bottom,0);
  --ease: cubic-bezier(0.4,0,0.2,1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{font-size:16px}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh;overflow:hidden;line-height:1.5;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(99,102,241,0.3);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(99,102,241,0.5)}
::selection{background:var(--accent);color:#fff}
input,textarea,button{font-family:inherit}
a{color:var(--accent);text-decoration:none}
.glass{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--border)}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideRight{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
@keyframes glow{0%,100%{box-shadow:0 0 20px var(--accent-glow)}50%{box-shadow:0 0 40px var(--accent-glow),0 0 60px var(--accent-glow)}}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
@keyframes msgIn{from{opacity:0;transform:translateY(10px) scale(0.98)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-5px)}40%,80%{transform:translateX(5px)}}
@keyframes confetti{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(-400px) rotate(720deg);opacity:0}}
@keyframes ripple{to{transform:scale(4);opacity:0}}
@keyframes gradient{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

.screen{display:none;position:fixed;inset:0;flex-direction:column;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom)}
.screen.active{display:flex;animation:fadeIn 0.4s var(--ease)}

/* Splash - Clean */
#splash{background:var(--bg);align-items:center;justify-content:center;z-index:1000}
.splash-bg{display:none}
.splash-orb{display:none}
.splash-content{position:relative;z-index:1;text-align:center}
.splash-logo{width:80px;height:80px;background:var(--accent);border-radius:20px;display:flex;align-items:center;justify-content:center;margin:0 auto 24px}
.splash-logo svg{width:40px;height:40px;color:#fff}
.splash-title{font-size:48px;font-weight:800;letter-spacing:-2px;margin-bottom:8px;background:linear-gradient(135deg,var(--text),var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.splash-sub{font-size:16px;color:var(--text3);font-weight:500}
.splash-dots{display:flex;gap:8px;justify-content:center;margin-top:48px}
.splash-dots span{width:8px;height:8px;background:var(--accent);border-radius:50%;animation:typing 1.4s infinite}
.splash-dots span:nth-child(2){animation-delay:0.1s}
.splash-dots span:nth-child(3){animation-delay:0.2s}

/* Welcome */
#welcome{background:var(--bg);align-items:center;justify-content:center;padding:24px;text-align:center;overflow-y:auto}
.welcome-bg{position:absolute;inset:0;overflow:hidden}
.welcome-orb{position:absolute;border-radius:50%;filter:blur(100px);opacity:0.2}
.welcome-orb-1{width:500px;height:500px;background:var(--accent);top:-150px;left:-150px;animation:float 10s ease-in-out infinite}
.welcome-orb-2{width:400px;height:400px;background:var(--pink);bottom:-100px;right:-100px;animation:float 10s ease-in-out infinite 3s}
.welcome-orb-3{width:300px;height:300px;background:var(--cyan);top:50%;left:50%;animation:float 10s ease-in-out infinite 6s}
.welcome-content{position:relative;z-index:1;max-width:420px;width:100%}
.welcome-logo{width:100px;height:100px;background:linear-gradient(135deg,var(--accent),var(--accent-light));border-radius:32px;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;box-shadow:var(--shadow-glow);transition:transform 0.3s var(--ease)}
.welcome-logo:hover{transform:scale(1.05) rotate(-3deg)}
.welcome-logo svg{width:50px;height:50px;color:#fff}
.welcome-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:var(--surface);border:1px solid var(--border2);border-radius:100px;font-size:13px;color:var(--text3);margin-bottom:20px}
.welcome-badge-dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
.welcome-title{font-size:56px;font-weight:800;letter-spacing:-3px;margin-bottom:12px;background:linear-gradient(135deg,var(--text) 0%,var(--accent-light) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.welcome-sub{font-size:17px;color:var(--text3);line-height:1.6;margin-bottom:40px}
.welcome-features{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:40px}
.welcome-feature{display:flex;align-items:center;gap:12px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);font-size:14px;font-weight:500;color:var(--text2);transition:all 0.3s var(--ease)}
.welcome-feature:hover{border-color:var(--accent);background:rgba(99,102,241,0.1);transform:translateY(-2px)}
.welcome-feature-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.welcome-buttons{display:flex;flex-direction:column;gap:10px}

/* Buttons - Clean */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border:none;border-radius:12px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.15s var(--ease)}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{filter:brightness(1.1)}
.btn-secondary{background:var(--surface2);color:var(--text)}
.btn-secondary:hover{background:var(--surface3)}
.btn-ghost{background:transparent;color:var(--text3)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-icon{width:40px;height:40px;padding:0;border-radius:10px}
.btn-sm{padding:8px 14px;font-size:13px}
.ripple{display:none}

/* Auth - Clean */
#register,#login,#verify{background:var(--bg);padding:20px;overflow-y:auto}
.auth-container{max-width:380px;margin:0 auto;width:100%}
.auth-back{width:40px;height:40px;background:var(--surface);border:none;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background 0.15s;margin-bottom:24px}
.auth-back:hover{background:var(--surface2)}
.auth-back svg{width:18px;height:18px;color:var(--text)}
.auth-header{text-align:center;margin-bottom:32px}
.auth-icon{width:64px;height:64px;background:var(--accent);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 20px}
.auth-icon svg{width:32px;height:32px;color:#fff}
.auth-title{font-size:24px;font-weight:600;margin-bottom:6px}
.auth-sub{font-size:14px;color:var(--text3)}
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:500;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px}
.form-input{width:100%;padding:14px 16px;background:var(--surface2);border:1.5px solid transparent;border-radius:12px;color:var(--text);font-size:15px;transition:all 0.15s;outline:none}
.form-input:focus{border-color:var(--accent);background:var(--surface3)}
.form-input::placeholder{color:var(--text4)}
.form-prefix-wrap{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:8px;transition:all 0.15s}
.form-prefix-wrap:focus-within{border-color:var(--accent);background:var(--surface3)}
.form-prefix{padding-left:14px;color:var(--text4);font-weight:500;font-size:14px}
.form-prefix-wrap input{flex:1;padding:12px 14px 12px 4px;background:transparent;border:none;color:var(--text);font-size:14px;outline:none}
.auth-footer{text-align:center;margin-top:24px;font-size:13px;color:var(--text3)}
.auth-footer a{color:var(--accent);font-weight:500}

/* Code inputs */
.code-inputs{display:flex;gap:8px;justify-content:center;margin:24px 0}
.code-input{width:44px;height:52px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;text-align:center;font-size:20px;font-weight:600;color:var(--text);transition:all 0.15s;outline:none}
.code-input:focus{border-color:var(--accent);background:var(--surface2)}
.code-input.filled{border-color:var(--green);background:rgba(34,197,94,0.1)}
.code-input.error{border-color:var(--red);animation:shake 0.4s}
.code-timer{text-align:center;font-size:14px;color:var(--text3)}
.code-timer span{color:var(--accent);font-weight:600}
.code-timer.expired span{color:var(--red)}
.resend-btn{display:block;margin:12px auto 0;background:none;border:none;color:var(--accent);font-size:14px;font-weight:600;cursor:pointer;opacity:0.7;transition:opacity 0.2s}
.resend-btn:hover{opacity:1}
.resend-btn:disabled{opacity:0.3;cursor:not-allowed}

/* Main App */
#main{background:var(--bg)}
.app{display:flex;height:100%;width:100%}

/* Sidebar */
.sidebar{width:380px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:16px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.sidebar-menu{width:44px;height:44px;background:transparent;border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all 0.2s var(--ease)}
.sidebar-menu:hover{background:var(--surface2);color:var(--text)}
.sidebar-logo{display:flex;align-items:center;gap:10px;flex:1}
.sidebar-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),var(--accent-light));border-radius:12px;display:flex;align-items:center;justify-content:center}
.sidebar-logo-icon svg{width:22px;height:22px;color:#fff}
.sidebar-logo-text{font-size:22px;font-weight:700;letter-spacing:-0.5px}
.sidebar-new{width:44px;height:44px;background:var(--accent);border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;transition:all 0.2s var(--ease)}
.sidebar-new:hover{background:var(--accent-light);transform:scale(1.05)}

/* Search */
.search-wrap{padding:12px 20px}
.search-box{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;transition:all 0.2s var(--ease)}
.search-box:focus-within{border-color:var(--accent);background:var(--bg)}
.search-box svg{width:18px;height:18px;color:var(--text4);flex-shrink:0}
.search-box input{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;outline:none}
.search-box input::placeholder{color:var(--text4)}

/* Tabs */
.tabs{display:flex;padding:0 20px;gap:4px;border-bottom:1px solid var(--border)}
.tab{flex:1;padding:14px 12px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text3);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s var(--ease)}
.tab:hover{color:var(--text);background:var(--surface2)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab svg{width:18px;height:18px}

/* Chat list */
.chat-list{flex:1;overflow-y:auto;padding:6px 8px}
.chat-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;cursor:pointer;transition:all 0.15s;margin-bottom:2px;position:relative}
.chat-item:hover{background:var(--surface2)}
.chat-item:active{background:var(--surface3);transform:scale(0.99)}
.chat-item.active{background:var(--accent)}
.chat-item.active *{color:#fff !important}
.chat-item.active .avatar::after{border-color:var(--accent)}
.chat-item.unread::before{content:'';position:absolute;left:4px;top:50%;transform:translateY(-50%);width:4px;height:4px;background:var(--accent);border-radius:50%}

/* Avatar - Telegram Style */
.avatar{width:52px;height:52px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:#fff;flex-shrink:0;position:relative;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover}
.avatar.online::after{content:'';position:absolute;bottom:2px;right:2px;width:14px;height:14px;background:var(--green);border:2.5px solid var(--surface);border-radius:50%}
.avatar.channel{border-radius:16px}
.avatar.premium{background:linear-gradient(135deg,#ff9800,#ff5722)}

/* Chat info */
.chat-info{flex:1;min-width:0}
.chat-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}
.chat-name{font-size:14px;font-weight:600;display:flex;align-items:center;gap:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-verified{color:var(--accent);font-size:12px}
.chat-premium{font-size:12px}
.chat-time{font-size:11px;color:var(--text4);flex-shrink:0}
.chat-bottom{display:flex;align-items:center;gap:6px}
.chat-preview{font-size:13px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.chat-badge{min-width:18px;height:18px;padding:0 5px;background:var(--accent);border-radius:9px;font-size:11px;font-weight:600;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Main area */
.main-area{flex:1;display:flex;flex-direction:column;background:var(--bg);position:relative}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:32px}
.empty-icon{width:80px;height:80px;background:var(--surface2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:16px}
.empty-icon svg{width:40px;height:40px;color:var(--text4)}
.empty-state h2{font-size:18px;font-weight:600;margin-bottom:6px}
.empty-state p{color:var(--text3);font-size:14px}

/* Chat view */
.chat-view{display:none;flex-direction:column;height:100%;position:absolute;inset:0;background:var(--bg);z-index:10}
.chat-view.active{display:flex}
.chat-header{padding:10px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.chat-header-back{width:36px;height:36px;background:transparent;border:none;border-radius:8px;cursor:pointer;display:none;align-items:center;justify-content:center;color:var(--text)}
.chat-header-back:hover{background:var(--surface2)}
.chat-header .avatar{width:40px;height:40px;font-size:14px;cursor:pointer}
.chat-header-info{flex:1;min-width:0;cursor:pointer}
.chat-header-name{font-size:15px;font-weight:600;display:flex;align-items:center;gap:4px}
.chat-header-status{font-size:12px;color:var(--green);display:flex;align-items:center;gap:4px}
.chat-header-status.offline{color:var(--text4)}
.chat-header-actions{display:flex;gap:4px}
.chat-header-actions button{width:40px;height:40px;background:transparent;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all 0.15s}
.chat-header-actions button:hover{background:var(--surface2);color:var(--text)}
.chat-header-actions button:active{background:var(--surface3)}
.chat-search{display:flex;align-items:center;margin-left:12px}

/* Channel View (Telegram-style) */
.channel-view{display:none;flex-direction:column;height:100%;position:absolute;inset:0;background:var(--bg);z-index:10}
.channel-view.active{display:flex;animation:fadeIn 0.25s var(--ease)}
.channel-header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--glass2);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.channel-header .back-btn{width:36px;height:36px;background:transparent;border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all 0.2s}
.channel-header .back-btn:hover{background:var(--surface2);color:var(--text)}
.channel-header-name{font-size:16px;font-weight:700}
.channel-menu-btn{width:36px;height:36px;background:transparent;border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all 0.2s}
.channel-menu-btn:hover{background:var(--surface2);color:var(--text)}
.channel-tabs{display:flex;padding:8px 16px;gap:8px;border-bottom:1px solid var(--border)}
.channel-tab{flex:1;padding:10px;background:var(--surface);border:none;border-radius:10px;color:var(--text3);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s}
.channel-tab:hover{background:var(--surface2)}
.channel-tab.active{background:var(--accent);color:#fff}
.channel-post{background:var(--surface);border-radius:16px;margin:12px;padding:16px;animation:fadeIn 0.3s var(--ease)}
.channel-post-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.channel-post-avatar{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#ec4899,#f472b6);display:flex;align-items:center;justify-content:center;font-size:16px}
.channel-post-info{flex:1}
.channel-post-name{font-weight:600;font-size:15px}
.channel-post-time{font-size:12px;color:var(--text3)}
.channel-post-text{font-size:15px;line-height:1.6;white-space:pre-wrap}
.channel-post-image{max-width:100%;border-radius:12px;margin-top:12px}
.channel-post-actions{display:flex;gap:16px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.channel-post-action{display:flex;align-items:center;gap:6px;color:var(--text3);font-size:13px;cursor:pointer;transition:color 0.2s}
.channel-post-action:hover{color:var(--text)}

/* Voice Overlay */
.voice-overlay{display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px 20px;min-width:300px;z-index:100;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.voice-overlay.active{display:block;animation:slideUp 0.3s var(--ease)}
.voice-overlay-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.voice-channel-name{font-size:14px;font-weight:600}
.voice-status{font-size:12px;color:var(--green)}
.voice-users{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.voice-user-item{display:flex;flex-direction:column;align-items:center;gap:4px}
.voice-user-item .avatar{width:48px;height:48px;font-size:16px;border-radius:14px;border:3px solid var(--green)}
.voice-user-item.speaking .avatar{border-color:var(--green);box-shadow:0 0 15px rgba(34,197,94,0.5);animation:speaking 0.5s infinite alternate}
.voice-user-item.muted .avatar{border-color:var(--text4);opacity:0.7}
.voice-user-name{font-size:11px;color:var(--text3);max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.voice-controls{display:flex;justify-content:center;gap:12px}
.voice-control-btn{width:48px;height:48px;background:var(--surface2);border:none;border-radius:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text);transition:all 0.2s}
.voice-control-btn:hover{background:var(--surface3);transform:scale(1.05)}
.voice-control-btn.danger{background:var(--red);color:#fff}
.voice-control-btn.danger:hover{background:#dc2626}
.voice-control-btn.active{background:var(--accent);color:#fff}
@keyframes speaking{from{box-shadow:0 0 5px rgba(34,197,94,0.3)}to{box-shadow:0 0 20px rgba(34,197,94,0.6)}}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;background-size:cover;background-position:center}
.messages.has-wallpaper .msg.in{background:rgba(15,23,42,0.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-color:rgba(255,255,255,0.1)}
.messages.has-wallpaper .msg.out{background:linear-gradient(135deg,rgba(var(--accent-rgb),0.9),rgba(var(--accent-rgb),0.7));backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.messages.has-wallpaper .date-sep span{background:rgba(15,23,42,0.8);backdrop-filter:blur(10px);border-color:rgba(255,255,255,0.1)}
.messages-inner{display:flex;flex-direction:column;min-height:100%;justify-content:flex-end;gap:2px}
.date-sep{display:flex;align-items:center;justify-content:center;padding:16px 0}
.date-sep span{padding:6px 14px;background:rgba(0,0,0,0.4);border-radius:16px;font-size:12px;font-weight:500;color:var(--text3)}

/* Messages - Clean Design */
.msg{max-width:70%;padding:8px 12px;border-radius:12px;margin-bottom:2px;position:relative;animation:msgIn 0.2s var(--ease)}
.msg.out{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px;margin-left:auto}
.msg.in{align-self:flex-start;background:var(--surface2);border-bottom-left-radius:4px;margin-right:auto}
.msg+.msg.out{border-top-right-radius:6px}
.msg+.msg.in{border-top-left-radius:6px}

/* Message groups */
.msg-group{display:flex;flex-direction:column;gap:1px;margin-bottom:6px}
.msg-group .msg{margin-bottom:0}
.msg-group .msg:first-child{border-radius:12px 12px 12px 4px}
.msg-group .msg:last-child{border-radius:4px 12px 12px 12px}
.msg-group .msg:only-child{border-radius:12px 12px 12px 4px}
.msg-group.out .msg:first-child{border-radius:12px 12px 4px 12px}
.msg-group.out .msg:last-child{border-radius:12px 4px 12px 12px}
.msg-group.out .msg:only-child{border-radius:12px 12px 4px 12px}

.msg-reply{padding:8px 10px;background:rgba(255,255,255,0.1);border-left:2px solid rgba(255,255,255,0.4);border-radius:6px;margin-bottom:6px;font-size:13px;cursor:pointer}
.msg.in .msg-reply{background:var(--surface3);border-left-color:var(--accent)}
.msg-reply-name{font-weight:600;margin-bottom:2px;font-size:12px;color:rgba(255,255,255,0.85)}
.msg.in .msg-reply-name{color:var(--accent)}
.msg-reply-text{opacity:0.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px}
.msg-text{font-size:14px;line-height:1.45;word-wrap:break-word;white-space:pre-wrap}
.msg-text a{color:inherit;text-decoration:underline;text-underline-offset:2px}
.msg-image{max-width:280px;border-radius:8px;margin-bottom:4px;cursor:pointer;display:block}
.msg-voice{display:flex;align-items:center;gap:10px;padding:4px 0}
.voice-play{width:36px;height:36px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.voice-play:hover{background:rgba(255,255,255,0.3)}
.voice-play svg{width:16px;height:16px;fill:#fff;margin-left:2px}
.msg.in .voice-play{background:var(--accent)}
.voice-waves{display:flex;align-items:center;gap:2px;height:28px;flex:1}
.voice-wave{width:2px;background:rgba(255,255,255,0.4);border-radius:1px}
.msg.in .voice-wave{background:var(--text4)}
.voice-dur{font-size:11px;opacity:0.7;font-variant-numeric:tabular-nums}
.msg-meta{display:flex;align-items:center;justify-content:flex-end;gap:4px;margin-top:2px}
.msg-time{font-size:11px;opacity:0.55}
.msg-status{font-size:12px;opacity:0.55}
.msg-status.read{color:#64b5f6;opacity:1}
.msg-actions{position:absolute;top:50%;right:calc(100% + 6px);transform:translateY(-50%);display:none;gap:4px;flex-direction:row-reverse}
.msg.out .msg-actions{right:auto;left:calc(100% + 6px);flex-direction:row}
.msg:hover .msg-actions{display:flex}
.msg-action{width:28px;height:28px;background:var(--surface);border:1px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.msg-action:hover{background:var(--surface2)}
.msg-action svg{width:14px;height:14px;color:var(--text3)}
.msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.reaction{display:flex;align-items:center;gap:3px;padding:3px 8px;background:rgba(255,255,255,0.1);border-radius:10px;font-size:12px;cursor:pointer;transition:all 0.15s}
.reaction:hover{background:rgba(255,255,255,0.15)}
.msg.in .reaction{background:var(--surface3)}
.reaction.active{background:rgba(0,136,204,0.3)}
.typing-ind{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surface2);border-radius:12px;border-bottom-left-radius:4px;align-self:flex-start;margin-bottom:4px}
.typing-dots{display:flex;gap:3px}
.typing-dots span{width:6px;height:6px;background:var(--text4);border-radius:50%;animation:typing 1.4s infinite}
.typing-dots span:nth-child(2){animation-delay:0.15s}
.typing-dots span:nth-child(3){animation-delay:0.3s}

/* Composer - Clean */
.composer{padding:10px 16px;padding-bottom:calc(10px + var(--safe-bottom));background:var(--surface);border-top:1px solid var(--border)}
.composer-reply{display:none;align-items:center;gap:10px;padding:10px 12px;background:var(--surface2);border-radius:10px;margin-bottom:10px;border-left:2px solid var(--accent)}
.composer-reply.active{display:flex}
.composer-reply-content{flex:1;min-width:0}
.composer-reply-name{font-size:12px;font-weight:600;color:var(--accent)}
.composer-reply-text{font-size:12px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.composer-reply-close{width:24px;height:24px;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:50%;color:var(--text3)}
.composer-reply-close:hover{background:var(--surface3)}
.composer-row{display:flex;align-items:flex-end;gap:8px}
.composer-attach{width:40px;height:40px;background:transparent;border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all 0.15s}
.composer-attach:hover{background:var(--surface2);color:var(--accent)}
.composer-input-wrap{flex:1;display:flex;align-items:flex-end;background:var(--surface2);border-radius:20px;padding:8px 14px;transition:background 0.15s}
.composer-input-wrap:focus-within{background:var(--surface3)}
.composer-input-wrap textarea{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;resize:none;outline:none;max-height:100px;min-height:20px;line-height:1.4;padding:2px 0;font-family:inherit}
.composer-input-wrap textarea::placeholder{color:var(--text4)}
.composer-emoji{width:32px;height:32px;background:transparent;border:none;border-radius:50%;cursor:pointer;font-size:18px}
.composer-send{width:40px;height:40px;background:var(--accent);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;transition:all 0.15s}
.composer-send:hover{filter:brightness(1.1)}
.composer-send svg{width:18px;height:18px;margin-left:2px}
.composer-send.voice{background:var(--surface2);color:var(--text3)}
.composer-send.voice:hover{background:var(--surface3)}
.composer-send.recording{background:var(--red)}
.recording-ind{display:none;align-items:center;gap:10px;flex:1;padding:0 6px}
.recording-ind.active{display:flex}
.recording-dot{width:8px;height:8px;background:var(--red);border-radius:50%;animation:pulse 1s infinite}
.recording-time{font-size:14px;color:var(--text);font-weight:500;font-variant-numeric:tabular-nums}
.recording-waves{display:flex;align-items:center;gap:2px;flex:1;height:24px}
.recording-wave{width:2px;background:var(--accent);border-radius:1px;animation:typing 0.5s infinite}
.recording-wave:nth-child(2){animation-delay:0.1s;height:14px}
.recording-wave:nth-child(3){animation-delay:0.2s;height:20px}
.recording-wave:nth-child(4){animation-delay:0.3s;height:12px}
.recording-wave:nth-child(5){animation-delay:0.4s;height:16px}
.recording-cancel{padding:6px 12px;background:transparent;border:none;color:var(--text3);font-size:13px;cursor:pointer}
.recording-cancel:hover{color:var(--red)}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center;z-index:200;padding-top:var(--safe-top)}
.modal.active{display:flex;animation:fadeIn 0.2s}
.modal.center{align-items:center;padding:20px}
.modal-content{width:100%;max-width:420px;max-height:calc(100vh - var(--safe-top) - var(--safe-bottom));background:var(--surface);border-radius:20px 20px 0 0;overflow:hidden;animation:slideUp 0.3s var(--ease);display:flex;flex-direction:column}
.modal.center .modal-content{border-radius:20px;max-height:85vh;animation:scaleIn 0.25s var(--ease)}
.modal-handle{width:36px;height:4px;background:var(--surface3);border-radius:2px;margin:10px auto}
.modal-header{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:17px;font-weight:600}
.modal-close{width:32px;height:32px;background:var(--surface2);border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3);transition:all 0.2s}
.modal-close:hover{background:var(--surface3);color:var(--text)}
.modal-body{flex:1;overflow-y:auto}

/* Settings */
.settings-cover{height:140px;background:linear-gradient(135deg,var(--accent),var(--accent-light),var(--pink));background-size:200% 200%;animation:gradient 8s ease infinite;position:relative}
.settings-avatar{width:90px;height:90px;border-radius:28px;background:var(--surface);border:4px solid var(--surface);position:absolute;bottom:-45px;left:24px;display:flex;align-items:center;justify-content:center;font-size:36px;color:var(--accent);cursor:pointer;overflow:hidden;transition:transform 0.2s;box-shadow:var(--shadow)}
.settings-avatar:hover{transform:scale(1.05)}
.settings-avatar img{width:100%;height:100%;object-fit:cover}
.settings-form{padding:60px 24px 24px}
.settings-section{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
.settings-section-title{font-size:12px;font-weight:600;text-transform:uppercase;color:var(--text4);margin-bottom:12px;letter-spacing:0.5px;display:flex;align-items:center;gap:8px}
.settings-item{display:flex;align-items:center;gap:14px;padding:12px 4px;cursor:pointer;transition:all 0.15s;border-radius:12px;margin:0 -4px}
.settings-item:hover{background:var(--surface2)}
.settings-item:active{transform:scale(0.99)}
.settings-item-icon{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.settings-item-icon svg{width:20px;height:20px}
.settings-item-info{flex:1;min-width:0}
.settings-item-title{font-size:15px;font-weight:500}
.settings-item-desc{font-size:12px;color:var(--text3);margin-top:2px}
.toggle{width:50px;height:30px;background:var(--surface3);border-radius:15px;position:relative;cursor:pointer;transition:all 0.25s;flex-shrink:0}
.toggle::after{content:'';width:26px;height:26px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:all 0.25s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.toggle.active{background:var(--accent)}
.toggle.active::after{left:22px}
.theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:12px}
.theme-opt{aspect-ratio:1;border-radius:12px;border:3px solid transparent;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.theme-opt:hover{transform:scale(1.08)}
.theme-opt.active{border-color:#fff}
.theme-opt.active::after{content:'✓';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3);color:#fff;font-size:14px;font-weight:bold}
.theme-indigo{background:linear-gradient(135deg,#6366f1,#818cf8)}
.theme-purple{background:linear-gradient(135deg,#a855f7,#c084fc)}
.theme-emerald{background:linear-gradient(135deg,#10b981,#34d399)}
.theme-rose{background:linear-gradient(135deg,#f43f5e,#fb7185)}
.theme-amber{background:linear-gradient(135deg,#f59e0b,#fbbf24)}
.theme-cyan{background:linear-gradient(135deg,#06b6d4,#22d3ee)}
.theme-pink{background:linear-gradient(135deg,#ec4899,#f472b6)}
.theme-ocean{background:linear-gradient(135deg,#0ea5e9,#38bdf8)}
.theme-sunset{background:linear-gradient(135deg,#f97316,#fb923c)}
.theme-neon{background:linear-gradient(135deg,#22d3ee,#a78bfa,#f472b6)}
.theme-light-btn{grid-column:span 5;height:40px;aspect-ratio:auto;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);display:flex;align-items:center;justify-content:center;font-size:13px;color:#1e293b;font-weight:600;gap:6px;margin-top:4px}
.menu-item{display:flex;align-items:center;gap:14px;padding:14px 20px;cursor:pointer;transition:all 0.15s}
.menu-item:hover{background:var(--surface2)}
.menu-item:active{background:var(--surface3)}
.menu-item .avatar{width:48px;height:48px;font-size:20px}
.menu-item-info{flex:1}
.menu-item-title{font-size:15px;font-weight:600}
.menu-item-desc{font-size:12px;color:var(--text3);margin-top:2px}

/* Profile - Telegram Style */
.profile-banner{height:200px;background:linear-gradient(135deg,var(--accent),var(--accent-light),var(--pink));background-size:200% 200%;animation:gradient 8s ease infinite;position:relative;cursor:pointer}
.profile-banner.custom{background-size:cover;background-position:center;animation:none}
.profile-banner-edit{position:absolute;bottom:12px;right:12px;width:36px;height:36px;background:rgba(0,0,0,0.5);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;opacity:0;transition:opacity 0.2s}
.profile-banner:hover .profile-banner-edit{opacity:1}
.profile-close{position:absolute;top:16px;left:16px;width:36px;height:36px;background:rgba(0,0,0,0.4);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;z-index:5}
.profile-avatar{width:120px;height:120px;border-radius:50%;background:var(--surface);border:4px solid var(--bg);position:absolute;bottom:-60px;left:24px;display:flex;align-items:center;justify-content:center;font-size:48px;color:var(--accent);overflow:hidden;box-shadow:var(--shadow)}
.profile-avatar img{width:100%;height:100%;object-fit:cover}
.profile-content{padding:70px 20px 20px}
.profile-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px}
.profile-name{font-size:24px;font-weight:700;display:flex;align-items:center;gap:6px}
.profile-username{font-size:15px;color:var(--accent);margin-top:2px;font-weight:500}
.profile-online{font-size:13px;color:var(--green);margin-top:4px;display:flex;align-items:center;gap:6px}
.profile-online::before{content:'';width:8px;height:8px;background:var(--green);border-radius:50%}
.profile-offline{font-size:13px;color:var(--text3);margin-top:4px}
.profile-bio{font-size:14px;color:var(--text2);line-height:1.6;margin-top:16px;padding:16px;background:var(--surface2);border-radius:12px}
.profile-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;padding:16px;background:var(--surface2);border-radius:12px}
.profile-stat{text-align:center}
.profile-stat-value{font-size:20px;font-weight:700;color:var(--accent)}
.profile-stat-label{font-size:12px;color:var(--text3);margin-top:2px}
.profile-actions{display:flex;gap:12px;margin-top:20px}
.profile-actions .btn{flex:1}
.profile-section{margin-top:20px}
.profile-section-title{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:10px;padding-left:16px}
.profile-items{background:var(--surface2);border-radius:16px;overflow:hidden;margin:0 4px}
.profile-item{display:flex;align-items:center;gap:14px;padding:14px 16px;cursor:pointer;transition:all 0.15s}
.profile-item:hover{background:var(--surface3)}
.profile-item:active{background:var(--surface3);transform:scale(0.99)}
.profile-item:not(:last-child){border-bottom:1px solid var(--border)}
.profile-item-icon{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
.profile-item-info{flex:1}
.profile-item-title{font-size:15px;font-weight:500}
.profile-item-desc{font-size:12px;color:var(--text3);margin-top:2px}

/* Chat Info Modal - Telegram Style */
.chat-info-banner{height:160px;background:linear-gradient(135deg,var(--accent),var(--accent-light));position:relative}
.chat-info-banner.custom{background-size:cover;background-position:center}
.chat-info-avatar{width:90px;height:90px;border-radius:50%;background:var(--surface);border:4px solid var(--surface);position:absolute;bottom:-45px;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;font-size:36px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.chat-info-avatar img{width:100%;height:100%;object-fit:cover}
.chat-info-content{padding:55px 20px 20px;text-align:center}
.chat-info-name{font-size:20px;font-weight:600}
.chat-info-status{font-size:13px;color:var(--text3);margin-top:4px}
.chat-info-actions{display:flex;justify-content:center;gap:32px;margin-top:20px;padding:0 16px}
.chat-info-action{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;border-radius:16px;transition:all 0.2s}
.chat-info-action:hover{background:var(--surface2)}
.chat-info-action:active{transform:scale(0.95)}
.chat-info-action-icon{width:52px;height:52px;border-radius:50%;background:rgba(var(--accent-rgb),0.12);display:flex;align-items:center;justify-content:center;font-size:22px;transition:all 0.2s}
.chat-info-action:hover .chat-info-action-icon{background:rgba(var(--accent-rgb),0.2)}
.chat-info-action-label{font-size:12px;color:var(--text3);font-weight:500}
.chat-info-section{margin-top:16px;text-align:left;padding:0 4px}
.chat-info-section-title{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:8px;padding:0 12px}

/* Call - Modern Design with Video Support */
.call-overlay{position:fixed;inset:0;background:#0a0a0f;z-index:300;display:none;flex-direction:column;align-items:center;justify-content:center}
.call-overlay.active{display:flex;animation:fadeIn 0.3s}
.call-overlay.video-mode{background:#000}
.call-bg{position:absolute;inset:0;overflow:hidden;background:linear-gradient(135deg,#0f0f1a 0%,#1a1a2e 50%,#0f0f1a 100%)}
.call-orb{position:absolute;border-radius:50%;filter:blur(120px);opacity:0.4;animation:callOrb 10s ease-in-out infinite}
.call-orb-1{width:500px;height:500px;background:linear-gradient(135deg,var(--accent),#ec4899);top:-150px;left:-150px}
.call-orb-2{width:400px;height:400px;background:linear-gradient(135deg,#06b6d4,var(--accent));bottom:-100px;right:-100px;animation-delay:3s}
.call-orb-3{width:300px;height:300px;background:linear-gradient(135deg,#a855f7,#ec4899);top:50%;left:50%;transform:translate(-50%,-50%);animation-delay:5s}
@keyframes callOrb{0%,100%{transform:scale(1) translate(0,0)}25%{transform:scale(1.1) translate(20px,-20px)}50%{transform:scale(0.9) translate(-10px,30px)}75%{transform:scale(1.05) translate(30px,10px)}}

.call-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;padding:40px;width:100%;max-width:500px}

/* Video containers */
.call-videos{position:absolute;inset:0;z-index:0;display:none}
.call-overlay.video-mode .call-videos{display:block}
.call-video-remote{width:100%;height:100%;object-fit:cover;background:#000}
.call-video-local{position:absolute;bottom:120px;right:20px;width:140px;height:200px;border-radius:16px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.1);z-index:5;cursor:move}
.call-video-local video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
.call-video-local.minimized{width:80px;height:110px;bottom:140px}
.call-video-local.hidden{display:none}

/* Screen share indicator */
.call-screen-share{position:absolute;top:20px;left:50%;transform:translateX(-50%);background:rgba(239,68,68,0.9);color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;display:none;align-items:center;gap:8px;z-index:10;animation:pulse 2s infinite}
.call-screen-share.active{display:flex}
.call-screen-share svg{width:18px;height:18px}

/* Avatar with pulse effect */
.call-avatar{width:160px;height:160px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-light));display:flex;align-items:center;justify-content:center;font-size:64px;color:#fff;margin-bottom:32px;overflow:hidden;box-shadow:0 0 60px rgba(99,102,241,0.4);position:relative}
.call-avatar::before{content:'';position:absolute;inset:-4px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#ec4899,#06b6d4);animation:avatarGlow 3s linear infinite;z-index:-1}
.call-avatar::after{content:'';position:absolute;inset:0;border-radius:50%;background:inherit}
.call-avatar img{width:100%;height:100%;object-fit:cover;position:relative;z-index:1}
.call-avatar.ringing{animation:callRing 1.5s ease-in-out infinite}
@keyframes avatarGlow{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes callRing{0%,100%{transform:scale(1);box-shadow:0 0 60px rgba(99,102,241,0.4)}50%{transform:scale(1.05);box-shadow:0 0 80px rgba(99,102,241,0.6),0 0 120px rgba(236,72,153,0.3)}}
.call-overlay.video-mode .call-content{position:absolute;bottom:0;left:0;right:0;padding:20px;background:linear-gradient(transparent,rgba(0,0,0,0.8));max-width:none}
.call-overlay.video-mode .call-avatar{display:none}

.call-name{font-size:28px;font-weight:700;margin-bottom:6px;text-shadow:0 2px 10px rgba(0,0,0,0.3)}
.call-status{font-size:15px;color:rgba(255,255,255,0.7);margin-bottom:24px}
.call-quality{display:flex;align-items:center;gap:6px;font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:16px}
.call-quality-bar{width:4px;height:12px;background:rgba(255,255,255,0.2);border-radius:2px}
.call-quality-bar.active{background:var(--green)}
.call-quality-bar.medium{background:var(--yellow)}
.call-quality-bar.poor{background:var(--red)}

.call-timer{font-size:32px;font-weight:300;margin-bottom:40px;font-variant-numeric:tabular-nums;letter-spacing:2px;display:none;color:#fff}
.call-timer.active{display:block;animation:fadeIn 0.3s}

/* Call action buttons - modern design */
.call-actions{display:flex;gap:16px;flex-wrap:wrap;justify-content:center}
.call-btn{width:60px;height:60px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}
.call-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity 0.3s}
.call-btn:hover::before{opacity:1}
.call-btn:hover{transform:scale(1.1)}
.call-btn:active{transform:scale(0.95)}
.call-btn svg{width:24px;height:24px;position:relative;z-index:1}
.call-btn-label{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);font-size:11px;color:rgba(255,255,255,0.6);white-space:nowrap;opacity:0;transition:opacity 0.2s}
.call-btn:hover .call-btn-label{opacity:1}

.call-btn.mute{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);color:#fff}
.call-btn.mute.active{background:var(--red);color:#fff}
.call-btn.video{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);color:#fff}
.call-btn.video.active{background:var(--accent);color:#fff}
.call-btn.video.off{background:rgba(255,255,255,0.1)}
.call-btn.video.off svg{opacity:0.5}
.call-btn.screen{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);color:#fff}
.call-btn.screen.active{background:var(--green);color:#fff}
.call-btn.speaker{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);color:#fff}
.call-btn.speaker.active{background:var(--accent);color:#fff}
.call-btn.end{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;width:70px;height:70px;box-shadow:0 4px 20px rgba(239,68,68,0.4)}
.call-btn.end:hover{box-shadow:0 6px 30px rgba(239,68,68,0.6)}
.call-btn.end svg{width:28px;height:28px}
.call-btn.accept{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;width:70px;height:70px;display:none;box-shadow:0 4px 20px rgba(34,197,94,0.4)}
.call-btn.accept.show{display:flex;animation:scaleIn 0.3s}
.call-btn.accept:hover{box-shadow:0 6px 30px rgba(34,197,94,0.6)}
.call-btn.accept svg{width:28px;height:28px}

/* Incoming call extra buttons */
.call-incoming-actions{display:none;gap:60px;margin-top:20px}
.call-overlay.incoming .call-incoming-actions{display:flex}
.call-overlay.incoming .call-actions{display:none}

/* Effects overlay */
.call-effects{position:absolute;inset:0;pointer-events:none;z-index:2}
.call-particle{position:absolute;width:4px;height:4px;background:var(--accent);border-radius:50%;animation:particle 3s linear infinite}
@keyframes particle{0%{opacity:0;transform:translateY(100vh)}50%{opacity:1}100%{opacity:0;transform:translateY(-100vh)}}

/* Image viewer */
.img-viewer{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:400;display:none;align-items:center;justify-content:center;padding:20px}
.img-viewer.active{display:flex;animation:fadeIn 0.2s}
.img-viewer img{max-width:100%;max-height:100%;object-fit:contain;border-radius:var(--radius);animation:scaleIn 0.3s}
.img-viewer-close{position:absolute;top:20px;right:20px}

/* Toast */
.toast{position:fixed;bottom:calc(100px + var(--safe-bottom));left:50%;transform:translateX(-50%) translateY(100px);padding:14px 24px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);font-size:14px;font-weight:500;display:flex;align-items:center;gap:10px;transition:all 0.4s var(--ease);z-index:500;box-shadow:var(--shadow);opacity:0;pointer-events:none}
.toast.active{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
.toast-icon{font-size:18px}
.toast.success{border-color:var(--green)}
.toast.success .toast-icon{color:var(--green)}
.toast.error{border-color:var(--red)}
.toast.error .toast-icon{color:var(--red)}

/* Context menu */
.ctx-menu{position:fixed;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:8px;min-width:180px;z-index:250;animation:scaleIn 0.15s;box-shadow:var(--shadow);display:none}
.ctx-menu.active{display:block}
.ctx-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.15s}
.ctx-item:hover{background:var(--surface2)}
.ctx-item svg{width:18px;height:18px;color:var(--text3)}
.ctx-item.danger{color:var(--red)}
.ctx-item.danger svg{color:var(--red)}

/* Confetti */
.confetti{position:fixed;top:0;left:50%;width:8px;height:8px;pointer-events:none;z-index:600;animation:confetti 3s ease-out forwards}

/* Email badge */
.email-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);border-radius:20px;font-size:12px;color:var(--green);font-weight:500;margin-top:8px}

/* Premium Features */
.premium-badge{background:linear-gradient(135deg,#f59e0b,#f97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
.premium-avatar{border:3px solid transparent;background:linear-gradient(var(--surface),var(--surface)) padding-box,linear-gradient(135deg,#f59e0b,#f97316,#ec4899) border-box;animation:premiumGlow 3s ease-in-out infinite}
@keyframes premiumGlow{0%,100%{box-shadow:0 0 20px rgba(245,158,11,0.3)}50%{box-shadow:0 0 30px rgba(245,158,11,0.5),0 0 40px rgba(236,72,153,0.3)}}
.premium-name{background:linear-gradient(90deg,#f59e0b,#f97316,#ec4899,#f59e0b);background-size:300% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmerText 3s linear infinite}
@keyframes shimmerText{0%{background-position:0% 50%}100%{background-position:100% 50%}}

/* Sticker Picker */
.sticker-picker{display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius) var(--radius) 0 0;max-height:300px;overflow-y:auto;z-index:10}
.sticker-picker.active{display:block;animation:slideUp 0.2s}
.sticker-tabs{display:flex;border-bottom:1px solid var(--border);padding:8px}
.sticker-tab{flex:1;padding:10px;background:transparent;border:none;color:var(--text3);font-size:13px;font-weight:600;cursor:pointer;border-radius:8px;transition:all 0.2s}
.sticker-tab:hover{background:var(--surface2)}
.sticker-tab.active{background:var(--accent);color:#fff}
.sticker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px}
.sticker-item{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:48px;background:var(--surface2);border-radius:12px;cursor:pointer;transition:all 0.2s;position:relative}
.sticker-item:hover{background:var(--accent);transform:scale(1.1)}
.sticker-item.premium::after{content:'⭐';position:absolute;top:4px;right:4px;font-size:12px}
.sticker-item.locked{opacity:0.5;cursor:not-allowed}
.sticker-item.locked::after{content:'🔒';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px}
.msg-sticker{font-size:80px;line-height:1;text-align:center;padding:10px}
.msg-sticker.animated{animation:stickerBounce 0.5s ease-out}
@keyframes stickerBounce{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

/* Message Effects */
.msg-effect{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:inherit}
.effect-hearts .heart{position:absolute;animation:floatHeart 2s ease-out forwards;font-size:16px}
@keyframes floatHeart{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-100px) scale(0.5)}}
.effect-confetti .confetti-piece{position:absolute;width:8px;height:8px;animation:confettiEffect 1.5s ease-out forwards}
@keyframes confettiEffect{0%{opacity:1;transform:translateY(0) rotate(0)}100%{opacity:0;transform:translateY(-80px) rotate(360deg)}}
.effect-sparkle .sparkle{position:absolute;animation:sparkleEffect 1s ease-out forwards;font-size:14px}
@keyframes sparkleEffect{0%{opacity:1;transform:scale(0)}50%{opacity:1;transform:scale(1.5)}100%{opacity:0;transform:scale(0)}}
.effect-fire .fire{position:absolute;animation:fireEffect 1s ease-out forwards;font-size:18px}
@keyframes fireEffect{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-60px)}}

/* Premium Chat Backgrounds */
.chat-bg{position:absolute;inset:0;z-index:0;opacity:0.1}
.chat-bg-gradient{background:linear-gradient(135deg,var(--accent),var(--pink),var(--cyan));background-size:400% 400%;animation:gradientBg 15s ease infinite}
@keyframes gradientBg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.chat-bg-particles{background-image:radial-gradient(circle,var(--accent) 1px,transparent 1px);background-size:30px 30px}
.chat-bg-waves{background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%236366f1' fill-opacity='0.3' d='M0,192L48,176C96,160,192,128,288,133.3C384,139,480,181,576,181.3C672,181,768,139,864,128C960,117,1056,139,1152,154.7C1248,171,1344,181,1392,186.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E") no-repeat bottom;background-size:cover}
.chat-bg-stars{background-image:radial-gradient(2px 2px at 20px 30px,var(--accent),transparent),radial-gradient(2px 2px at 40px 70px,var(--pink),transparent),radial-gradient(1px 1px at 90px 40px,var(--cyan),transparent),radial-gradient(2px 2px at 130px 80px,var(--accent),transparent);background-size:200px 100px}

/* Scheduled Messages */
.scheduled-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(99,102,241,0.2);border-radius:8px;font-size:11px;color:var(--accent);margin-left:8px}

/* Read Receipts */
.read-avatars{display:flex;margin-top:4px}
.read-avatar{width:16px;height:16px;border-radius:50%;border:2px solid var(--surface);margin-left:-6px;font-size:8px;display:flex;align-items:center;justify-content:center;background:var(--accent)}
.read-avatar:first-child{margin-left:0}

/* Voice Transcription */
.voice-transcript{margin-top:8px;padding:8px;background:rgba(0,0,0,0.1);border-radius:8px;font-size:12px;font-style:italic;color:var(--text2)}

/* Auto Reply */
.auto-reply-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(34,197,94,0.2);border-radius:8px;font-size:11px;color:var(--green)}

/* Premium Shop */
.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:16px}
.shop-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;cursor:pointer;transition:all 0.2s}
.shop-item:hover{border-color:var(--accent);transform:translateY(-2px)}
.shop-item.owned{border-color:var(--green);background:rgba(34,197,94,0.1)}
.shop-icon{font-size:40px;margin-bottom:8px}
.shop-name{font-size:14px;font-weight:600;margin-bottom:4px}
.shop-price{font-size:13px;color:var(--accent);font-weight:600}
.shop-item.owned .shop-price{color:var(--green)}

/* Statistics */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:16px}
.stat-card{background:var(--surface2);border-radius:var(--radius);padding:16px;text-align:center}
.stat-value{font-size:28px;font-weight:700;color:var(--accent)}
.stat-label{font-size:12px;color:var(--text3);margin-top:4px}

/* Invisible Mode */
.invisible-indicator{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(100,116,139,0.2);border-radius:8px;font-size:11px;color:var(--text4)}

/* Secret Chat */
.secret-chat-badge{display:flex;align-items:center;gap:6px;padding:8px 12px;background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(236,72,153,0.2));border-radius:20px;font-size:12px;color:var(--text2);margin-bottom:12px}

/* Disappearing Messages Timer */
.disappear-timer{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--text4);margin-left:6px}

/* Shop Styles */
.shop-balance{text-align:center;font-size:24px;font-weight:700;padding:16px;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(249,115,22,0.15));border-bottom:1px solid var(--border)}
.shop-tabs{display:flex;padding:8px;gap:4px;border-bottom:1px solid var(--border)}
.shop-tab{flex:1;padding:10px;background:transparent;border:none;color:var(--text3);font-size:13px;font-weight:600;cursor:pointer;border-radius:8px;transition:all 0.2s}
.shop-tab:hover{background:var(--surface2)}
.shop-tab.active{background:var(--accent);color:#fff}
.shop-section{display:none}
.shop-section.active{display:block}
.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px}
.shop-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center;cursor:pointer;transition:all 0.2s}
.shop-item:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 20px rgba(99,102,241,0.2)}
.shop-item.owned{border-color:var(--green);background:rgba(34,197,94,0.1)}
.shop-item.owned::after{content:'✓';position:absolute;top:8px;right:8px;color:var(--green);font-weight:700}
.shop-item{position:relative}
.shop-icon{font-size:36px;margin-bottom:6px}
.shop-name{font-size:13px;font-weight:600;margin-bottom:4px}
.shop-price{font-size:12px;color:var(--accent);font-weight:600}
.shop-item.owned .shop-price{color:var(--green)}

/* Stars Options */
.stars-options{display:flex;flex-direction:column;gap:10px}
.stars-option{display:flex;align-items:center;gap:12px;padding:14px;background:var(--surface2);border-radius:var(--radius);cursor:pointer;transition:all 0.2s}
.stars-option:hover{background:var(--surface3);transform:translateX(4px)}
.stars-option.premium{background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(249,115,22,0.1));border:1px solid rgba(245,158,11,0.3)}
.stars-icon{font-size:28px}
.stars-info{flex:1}
.stars-title{font-size:14px;font-weight:600;margin-bottom:2px}
.stars-desc{font-size:12px;color:var(--text3)}
.stars-badge{padding:4px 10px;background:var(--accent);color:#fff;border-radius:20px;font-size:12px;font-weight:600}
.stars-badge.free{background:var(--green)}

/* Sticker Packs */
.sticker-pack-tabs{display:flex;gap:4px;padding:8px;border-bottom:1px solid var(--border);overflow-x:auto}
.sticker-pack-tab{padding:8px 14px;background:var(--surface2);border:none;border-radius:20px;color:var(--text3);font-size:20px;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.sticker-pack-tab:hover{background:var(--surface3)}
.sticker-pack-tab.active{background:var(--accent);color:#fff}
.sticker-pack-tab.locked{opacity:0.5}
.sticker-pack-tab.locked::after{content:'🔒';font-size:10px;margin-left:4px}
.sticker-pack-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.sticker-item{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:40px;background:var(--surface2);border-radius:12px;cursor:pointer;transition:all 0.15s}
.sticker-item:hover{background:var(--accent);transform:scale(1.1)}
.sticker-item.locked{opacity:0.4;cursor:not-allowed}

/* Effects Grid */
.effects-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.effect-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;background:var(--surface2);border-radius:12px;cursor:pointer;transition:all 0.2s}
.effect-item:hover{background:var(--accent);transform:scale(1.05)}
.effect-item.active{background:var(--accent);box-shadow:0 0 20px var(--accent-glow)}
.effect-item span{font-size:28px}
.effect-item div{font-size:11px;color:var(--text3)}
.effect-item:hover div,.effect-item.active div{color:#fff}

/* Schedule */
.schedule-quick{display:flex;gap:8px;margin-top:12px}
.schedule-quick-btn{flex:1;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s}
.schedule-quick-btn:hover{border-color:var(--accent);background:rgba(99,102,241,0.1)}

/* Statistics */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:16px}
.stat-card{background:var(--surface2);border-radius:var(--radius);padding:16px;text-align:center}
.stat-value{font-size:28px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:12px;color:var(--text3);margin-top:4px}
.stat-progress{height:8px;background:var(--surface3);border-radius:4px;overflow:hidden;margin-bottom:8px}
.stat-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--pink));border-radius:4px;transition:width 0.3s}
.stats-chart{padding:16px;border-top:1px solid var(--border)}
.stats-chart-bar{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.stats-chart-label{width:60px;font-size:11px;color:var(--text3)}
.stats-chart-fill{height:20px;background:linear-gradient(90deg,var(--accent),var(--accent-light));border-radius:4px;min-width:4px}
.stats-chart-value{font-size:12px;font-weight:600;color:var(--text2)}

/* Secret Chat */
.secret-info{text-align:center;padding:20px;background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(236,72,153,0.1));border-radius:var(--radius);margin-bottom:16px}
.secret-icon{font-size:48px;margin-bottom:12px}
.secret-info p{font-size:13px;color:var(--text3);line-height:1.5}
.timer-options{display:flex;gap:6px}
.timer-opt{flex:1;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s}
.timer-opt:hover{border-color:var(--accent)}
.timer-opt.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* Inventory */
.inventory-tabs{display:flex;gap:4px;padding:8px;border-bottom:1px solid var(--border)}
.inv-tab{flex:1;padding:10px;background:transparent;border:none;color:var(--text3);font-size:13px;font-weight:600;cursor:pointer;border-radius:8px;transition:all 0.2s}
.inv-tab:hover{background:var(--surface2)}
.inv-tab.active{background:var(--accent);color:#fff}
.inv-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.inv-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px;background:var(--surface2);border-radius:12px;cursor:pointer;transition:all 0.2s}
.inv-item:hover{background:var(--surface3)}
.inv-item.active{border:2px solid var(--accent);background:rgba(99,102,241,0.1)}
.inv-item-icon{font-size:32px}
.inv-item-name{font-size:11px;color:var(--text3);text-align:center}

/* Premium enhancements */
.msg.premium-effect{position:relative;overflow:visible}
.effect-particles{position:absolute;inset:-20px;pointer-events:none;overflow:visible}
.effect-particle{position:absolute;animation:floatParticle 2s ease-out forwards}
@keyframes floatParticle{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-60px) scale(0.5)}}

/* VIP Avatar Frame */
.avatar.vip{border:3px solid transparent;background:linear-gradient(var(--surface),var(--surface)) padding-box,linear-gradient(135deg,#f59e0b,#f97316,#ec4899,#a855f7) border-box;animation:vipGlow 3s ease-in-out infinite}
@keyframes vipGlow{0%,100%{box-shadow:0 0 15px rgba(245,158,11,0.4)}50%{box-shadow:0 0 25px rgba(245,158,11,0.6),0 0 35px rgba(236,72,153,0.3)}}

/* Chat background effects */
.messages.chat-bg-gradient::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--accent),var(--pink),var(--cyan));background-size:400% 400%;animation:gradientBg 15s ease infinite;opacity:0.05;pointer-events:none;z-index:0}
.messages.chat-bg-particles::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle,var(--accent) 1px,transparent 1px);background-size:30px 30px;opacity:0.1;pointer-events:none;z-index:0}
.messages.chat-bg-stars::before{content:'';position:absolute;inset:0;background-image:radial-gradient(2px 2px at 20px 30px,var(--accent),transparent),radial-gradient(2px 2px at 40px 70px,var(--pink),transparent),radial-gradient(1px 1px at 90px 40px,var(--cyan),transparent);background-size:150px 80px;opacity:0.15;pointer-events:none;z-index:0}

/* Level badge */
.level-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:linear-gradient(135deg,var(--accent),var(--pink));border-radius:12px;font-size:10px;font-weight:700;color:#fff}

/* Scheduled message indicator */
.msg-scheduled{opacity:0.7}
.msg-scheduled::after{content:'⏰';position:absolute;bottom:-16px;right:8px;font-size:12px}

/* Composer premium buttons */
.composer-premium{display:flex;gap:4px;padding:8px 12px;border-bottom:1px solid var(--border)}
.composer-premium-btn{width:36px;height:36px;background:var(--surface2);border:none;border-radius:10px;font-size:18px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
.composer-premium-btn:hover{background:var(--accent);transform:scale(1.1)}
.composer-premium-btn:active{transform:scale(0.95)}

/* Responsive */
@media(max-width:768px){
  .app{flex-direction:column}
  .sidebar{width:100%;height:100%}
  .main-area{position:fixed;inset:0;transform:translateX(100%);transition:transform 0.35s var(--ease);z-index:50}
  .main-area.active{transform:translateX(0)}
  .chat-header-back{display:flex}
  .chat-view{position:relative;inset:auto}
  .empty-state{display:none}
  .msg{max-width:80%}
  .modal-content{max-width:100%}
  .welcome-features{grid-template-columns:1fr}
  .welcome-title{font-size:44px}
  .channel-view{flex-direction:column}
  .channel-sidebar{width:100%;height:auto;max-height:40%;border-right:none;border-bottom:1px solid var(--border)}
  .channel-sections{flex-direction:row;overflow-x:auto;padding:8px}
  .channel-section{margin-bottom:0;margin-right:16px;min-width:150px}
  .channel-members{display:none}
  .voice-overlay{left:10px;right:10px;transform:none;min-width:auto}
}
</style>
</head>
<body>

<!-- Splash Screen -->
<div class="screen active" id="splash">
  <div class="splash-bg">
    <div class="splash-orb splash-orb-1"></div>
    <div class="splash-orb splash-orb-2"></div>
  </div>
  <div class="splash-content">
    <div class="splash-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </div>
    <div class="splash-title">Mini</div>
    <div class="splash-sub">Messenger</div>
    <div class="splash-dots"><span></span><span></span><span></span></div>
  </div>
</div>

<!-- Welcome Screen -->
<div class="screen" id="welcome">
  <div class="welcome-bg">
    <div class="welcome-orb welcome-orb-1"></div>
    <div class="welcome-orb welcome-orb-2"></div>
    <div class="welcome-orb welcome-orb-3"></div>
  </div>
  <div class="welcome-content">
    <div class="welcome-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </div>
    <div class="welcome-badge"><div class="welcome-badge-dot"></div><span>Version 4.0 — Free Forever</span></div>
    <div class="welcome-title">Mini</div>
    <div class="welcome-sub">Быстрый, безопасный и минималистичный мессенджер для общения с друзьями</div>
    <div class="welcome-features">
      <div class="welcome-feature"><div class="welcome-feature-icon" style="background:rgba(99,102,241,0.15)">💬</div><span>Мгновенные сообщения</span></div>
      <div class="welcome-feature"><div class="welcome-feature-icon" style="background:rgba(34,197,94,0.15)">🔒</div><span>Приватные чаты</span></div>
      <div class="welcome-feature"><div class="welcome-feature-icon" style="background:rgba(236,72,153,0.15)">📢</div><span>Создание каналов</span></div>
      <div class="welcome-feature"><div class="welcome-feature-icon" style="background:rgba(6,182,212,0.15)">📞</div><span>Голосовые звонки</span></div>
    </div>
    <div class="welcome-buttons">
      <button class="btn btn-primary" onclick="showScreen('register')">Создать аккаунт</button>
      <button class="btn btn-secondary" onclick="showScreen('login')">Войти</button>
    </div>
  </div>
</div>

<!-- Register Screen -->
<div class="screen" id="register">
  <div class="auth-container">
    <button class="auth-back" onclick="showScreen('welcome')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </button>
    <div class="auth-header">
      <div class="auth-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
      <div class="auth-title">Создать аккаунт</div>
      <div class="auth-sub">Email опционален для верификации</div>
    </div>
    <form onsubmit="return startRegister(event)">
      <div class="form-group"><label class="form-label">Имя</label><input type="text" class="form-input" id="reg-name" placeholder="Ваше имя" required></div>
      <div class="form-group"><label class="form-label">Email <span style="color:var(--text4);font-weight:400">(опционально)</span></label><input type="email" class="form-input" id="reg-email" placeholder="email@example.com"></div>
      <div class="form-group"><label class="form-label">Username</label><div class="form-prefix-wrap"><span class="form-prefix">@</span><input type="text" id="reg-username" placeholder="username" required pattern="[a-z0-9_]{3,32}"></div></div>
      <div class="form-group"><label class="form-label">Пароль</label><input type="password" class="form-input" id="reg-password" placeholder="Минимум 6 символов" required minlength="6"></div>
      <button type="submit" class="btn btn-primary" style="width:100%" id="reg-btn">Создать аккаунт</button>
    </form>
    <div class="auth-footer">Уже есть аккаунт? <a href="#" onclick="showScreen('login');return false">Войти</a></div>
  </div>
</div>

<!-- Verify Screen -->
<div class="screen" id="verify">
  <div class="auth-container">
    <button class="auth-back" onclick="showScreen('register')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </button>
    <div class="auth-header">
      <div class="auth-icon" style="background:linear-gradient(135deg,#22c55e,#16a34a)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
      <div class="auth-title">Подтверждение</div>
      <div class="auth-sub">Код отправлен на <span id="verify-email" style="color:var(--accent);font-weight:600"></span></div>
    </div>
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" inputmode="numeric" oninput="handleCodeInput(this,0)" onkeydown="handleCodeKeydown(event,0)">
      <input type="text" class="code-input" maxlength="1" inputmode="numeric" oninput="handleCodeInput(this,1)" onkeydown="handleCodeKeydown(event,1)">
      <input type="text" class="code-input" maxlength="1" inputmode="numeric" oninput="handleCodeInput(this,2)" onkeydown="handleCodeKeydown(event,2)">
      <input type="text" class="code-input" maxlength="1" inputmode="numeric" oninput="handleCodeInput(this,3)" onkeydown="handleCodeKeydown(event,3)">
      <input type="text" class="code-input" maxlength="1" inputmode="numeric" oninput="handleCodeInput(this,4)" onkeydown="handleCodeKeydown(event,4)">
      <input type="text" class="code-input" maxlength="1" inputmode="numeric" oninput="handleCodeInput(this,5)" onkeydown="handleCodeKeydown(event,5)">
    </div>
    <div class="code-timer" id="code-timer-wrap">Код действителен ещё <span id="code-timer">10:00</span></div>
    <button class="resend-btn" id="resend-btn" onclick="resendCode()" disabled>Отправить повторно</button>
    <button class="btn btn-primary" style="width:100%;margin-top:24px" onclick="verifyCode()" id="verify-btn">Подтвердить</button>
  </div>
</div>

<!-- Login Screen -->
<div class="screen" id="login">
  <div class="auth-container">
    <button class="auth-back" onclick="showScreen('welcome')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </button>
    <div class="auth-header">
      <div class="auth-icon" style="background:linear-gradient(135deg,#22c55e,#16a34a)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
      <div class="auth-title">С возвращением</div>
      <div class="auth-sub">Войдите в свой аккаунт</div>
    </div>
    <form onsubmit="return login(event)">
      <div class="form-group"><label class="form-label">Username или Email</label><input type="text" class="form-input" id="login-username" placeholder="username или email" required></div>
      <div class="form-group"><label class="form-label">Пароль</label><input type="password" class="form-input" id="login-password" placeholder="Ваш пароль" required></div>
      <button type="submit" class="btn btn-primary" style="width:100%">Войти</button>
    </form>
    <div class="auth-footer">Нет аккаунта? <a href="#" onclick="showScreen('register');return false">Создать</a></div>
  </div>
</div>

<!-- Main App -->
<div class="screen" id="main">
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">
        <button class="sidebar-menu" onclick="openModal('settings')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <div class="sidebar-logo"><div class="sidebar-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><span class="sidebar-logo-text">Mini</span></div>
        <button class="sidebar-new" onclick="openModal('create')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
      </div>
      <div class="search-wrap"><div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg><input type="text" placeholder="Поиск..." oninput="handleSearch(this.value)"></div></div>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('chats',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Чаты</button>
        <button class="tab" onclick="switchTab('channels',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>Каналы</button>
      </div>
      <div class="chat-list" id="chats-list"></div>
    </div>
    <div class="main-area" id="main-area">
      <div class="empty-state" id="empty-state">
        <div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
        <h2>Выберите чат</h2>
        <p>Выберите диалог или создайте новый</p>
      </div>
      <div class="chat-view" id="chat-view">
        <div class="chat-header">
          <button class="chat-header-back" onclick="closeChat()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
          <div class="avatar" id="chat-avatar" onclick="openChatInfo()"></div>
          <div class="chat-header-info" onclick="openChatInfo()">
            <div class="chat-header-name" id="chat-name"></div>
            <div class="chat-header-status" id="chat-status"></div>
          </div>
          <div class="chat-search" id="chat-search" style="display:none">
            <input type="text" id="message-search-input" placeholder="Поиск сообщений..." oninput="searchMessages(this.value)" class="form-input" style="width:200px;margin:0">
            <button onclick="toggleMessageSearch()" style="margin-left:8px;width:32px;height:32px;background:var(--surface2);border:none;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text3)">×</button>
          </div>
          <div class="chat-header-actions" id="header-actions">
            <button onclick="startCall()" title="Голосовой звонок"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.96.36 1.9.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.91.34 1.85.58 2.81.7A2 2 0 0 1 22 16.92z"/></svg></button>
            <button onclick="startVideoCall()" title="Видеозвонок"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg></button>
            <button onclick="toggleMessageSearch()" title="Поиск"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></button>
            <button onclick="openChatInfo()" title="Информация"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></button>
          </div>
        </div>
        <div class="messages" id="messages"><div class="messages-inner" id="messages-inner"></div></div>
        <div class="composer" id="composer">
          <div class="composer-reply" id="composer-reply"><div class="composer-reply-content"><div class="composer-reply-name" id="reply-name"></div><div class="composer-reply-text" id="reply-text"></div></div><button class="composer-reply-close" onclick="cancelReply()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
          <div class="composer-premium" id="composer-premium">
            <button class="composer-premium-btn" onclick="openStickers()" title="Стикеры">🎨</button>
            <button class="composer-premium-btn" onclick="openEffects()" title="Эффекты">✨</button>
            <button class="composer-premium-btn" onclick="startCircleRecord()" title="Кружочек">⭕</button>
            <button class="composer-premium-btn" onclick="openShop()" title="Магазин">💎</button>
          </div>
          <div class="composer-row">
            <button class="composer-attach" onclick="document.getElementById('file-input').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button>
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
            <div class="composer-input-wrap" id="composer-input-wrap"><textarea id="msg-input" placeholder="Сообщение..." rows="1" oninput="autoGrow(this);sendTyping();updateSendBtn()" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea><button class="composer-emoji" onclick="togglePicker()">😊</button></div>
            <div class="recording-ind" id="recording-ind"><div class="recording-dot"></div><span class="recording-time" id="recording-time">0:00</span><div class="recording-waves"><div class="recording-wave" style="height:16px"></div><div class="recording-wave"></div><div class="recording-wave"></div><div class="recording-wave"></div><div class="recording-wave" style="height:16px"></div></div><button class="recording-cancel" onclick="cancelRecording()">Отмена</button></div>
            <button class="composer-send voice" id="send-btn" onclick="handleSendClick()" onmousedown="handleSendMouseDown(event)" onmouseup="handleSendMouseUp(event)" ontouchstart="handleSendMouseDown(event)" ontouchend="handleSendMouseUp(event)"><svg id="send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg></button>
          </div>
        </div>
      </div>
      <!-- Channel View (Telegram-style) -->
      <div class="channel-view" id="channel-view" style="display:none">
        <div class="channel-header" id="channel-header">
          <button class="back-btn" onclick="closeChannel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
          <div class="avatar channel" id="channel-avatar" style="width:40px;height:40px;background:var(--accent)">📢</div>
          <div style="flex:1;min-width:0">
            <div class="channel-header-name" id="channel-name-header">Канал</div>
            <div style="font-size:12px;color:var(--text3)" id="channel-subs">0 подписчиков</div>
          </div>
          <button class="channel-menu-btn" id="channel-settings-btn" style="display:none" onclick="openChannelSettings()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
          <button class="channel-menu-btn" onclick="openModal('channel-menu')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></button>
        </div>
        <div class="channel-tabs">
          <button class="channel-tab active" onclick="switchChannelTab('posts',this)">📢 Посты</button>
          <button class="channel-tab" onclick="switchChannelTab('chat',this)">💬 Чат</button>
        </div>
        <div class="messages" id="channel-messages"><div class="messages-inner" id="channel-messages-inner"></div></div>
        <div class="composer" id="channel-composer" style="display:none">
          <button class="composer-attach" onclick="document.getElementById('channel-file-input').click()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button>
          <input type="file" id="channel-file-input" accept="image/*" style="display:none" onchange="handleChannelImage(this)">
          <div class="composer-input-wrap"><textarea id="channel-msg-input" placeholder="Сообщение..." rows="1" oninput="autoGrow(this)" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChannelMessage()}"></textarea></div>
          <button class="composer-send" onclick="sendChannelMessage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Voice Channel Overlay -->
<div class="voice-overlay" id="voice-overlay">
  <div class="voice-overlay-header">
    <div class="voice-channel-name" id="voice-channel-name">🎙️ Голосовой канал</div>
    <div class="voice-status" id="voice-status">Подключение...</div>
  </div>
  <div class="voice-users" id="voice-users"></div>
  <div class="voice-controls">
    <button class="voice-control-btn" id="voice-mute-btn" onclick="toggleVoiceMute()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/></svg></button>
    <button class="voice-control-btn danger" onclick="leaveVoiceChannel()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M16 15v4a2 2 0 01-2 2H6a2 2 0 01-2-2V5a2 2 0 012-2h8a2 2 0 012 2v4M21 12H9M12 9l-3 3 3 3"/></svg></button>
  </div>
</div>

<!-- Chat Menu Modal -->
<div class="modal" id="modal-chat-menu">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>Меню чата</h3><button class="modal-close" onclick="closeModal('chat-menu')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:0">
      <div class="menu-item" onclick="searchInChat()"><div class="avatar" style="background:rgba(99,102,241,0.15)">🔍</div><div class="menu-item-info"><div class="menu-item-title">Поиск по чату</div><div class="menu-item-desc">Найти сообщения в диалоге</div></div></div>
      <div class="menu-item" onclick="muteChat()"><div class="avatar" style="background:rgba(245,158,11,0.15)">🔕</div><div class="menu-item-info"><div class="menu-item-title">Без звука</div><div class="menu-item-desc">Отключить уведомления</div></div></div>
      <div class="menu-item" onclick="clearChat()"><div class="avatar" style="background:rgba(236,72,153,0.15)">🗑️</div><div class="menu-item-info"><div class="menu-item-title">Очистить историю</div><div class="menu-item-desc">Удалить все сообщения</div></div></div>
      <div class="menu-item" onclick="deleteChat()" style="color:var(--red)"><div class="avatar" style="background:rgba(239,68,68,0.15)">❌</div><div class="menu-item-info"><div class="menu-item-title" style="color:var(--red)">Удалить чат</div><div class="menu-item-desc">Удалить диалог полностью</div></div></div>
    </div>
  </div>
</div>

<!-- Channel Menu Modal -->
<div class="modal" id="modal-channel-menu">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>Управление каналом</h3><button class="modal-close" onclick="closeModal('channel-menu')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:0">
      <div class="menu-item" onclick="copyChannelInvite()"><div class="avatar" style="background:linear-gradient(135deg,#10b981,#34d399)">🔗</div><div class="menu-item-info"><div class="menu-item-title">Пригласить</div><div class="menu-item-desc">Скопировать ссылку-приглашение</div></div></div>
      <div class="menu-item" onclick="addTextChannel()"><div class="avatar" style="background:linear-gradient(135deg,#6366f1,#818cf8)">#</div><div class="menu-item-info"><div class="menu-item-title">Добавить текстовый канал</div><div class="menu-item-desc">Создать новый чат</div></div></div>
      <div class="menu-item" onclick="addVoiceChannel()"><div class="avatar" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)">🎙️</div><div class="menu-item-info"><div class="menu-item-title">Добавить голосовой канал</div><div class="menu-item-desc">Создать комнату для разговоров</div></div></div>
      <div class="menu-item" onclick="leaveChannel()" style="color:var(--red)"><div class="avatar" style="background:rgba(239,68,68,0.15)">🚪</div><div class="menu-item-info"><div class="menu-item-title" style="color:var(--red)">Покинуть канал</div><div class="menu-item-desc">Выйти из этого канала</div></div></div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="modal-settings">
  <div class="modal-content" style="max-height:95vh">
    <div class="modal-handle"></div>
    <div class="modal-body" style="padding:0">
      <div class="settings-cover"><div class="settings-avatar" id="settings-avatar" onclick="document.getElementById('avatar-input').click()"></div></div>
      <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="handleAvatar(this)">
      <div class="settings-form">
        <div class="form-group"><label class="form-label">Имя</label><input type="text" class="form-input" id="settings-name"></div>
        <div class="form-group"><label class="form-label">О себе</label><textarea class="form-input" id="settings-bio" rows="2" placeholder="Расскажите о себе..."></textarea></div>
        <div id="email-status"></div>
        <div class="settings-section">
          <div class="settings-section-title">🎨 Тема оформления</div>
          <div class="theme-grid">
            <div class="theme-opt theme-indigo active" data-theme="" onclick="setTheme('')"></div>
            <div class="theme-opt theme-purple" data-theme="purple" onclick="setTheme('purple')"></div>
            <div class="theme-opt theme-emerald" data-theme="emerald" onclick="setTheme('emerald')"></div>
            <div class="theme-opt theme-rose" data-theme="rose" onclick="setTheme('rose')"></div>
            <div class="theme-opt theme-amber" data-theme="amber" onclick="setTheme('amber')"></div>
            <div class="theme-opt theme-cyan" data-theme="cyan" onclick="setTheme('cyan')"></div>
            <div class="theme-opt theme-pink" data-theme="pink" onclick="setTheme('pink')"></div>
            <div class="theme-opt theme-ocean" data-theme="ocean" onclick="setTheme('ocean')"></div>
            <div class="theme-opt theme-sunset" data-theme="sunset" onclick="setTheme('sunset')"></div>
            <div class="theme-opt theme-neon" data-theme="neon" onclick="setTheme('neon')"></div>
          </div>
          <div class="theme-opt theme-light-btn" data-theme="light" onclick="setTheme('light')">☀️ Светлая тема</div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">🖼 Обои чата</div>
          <div class="wallpaper-grid" id="wallpaper-grid"></div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">🔔 Звуки и уведомления</div>
          <div class="settings-item" onclick="toggleSetting('sounds')"><div class="settings-item-icon" style="background:rgba(236,72,153,0.15)"><svg viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></div><div class="settings-item-info"><div class="settings-item-title">Звуки</div><div class="settings-item-desc">Звуки уведомлений и сообщений</div></div><div class="toggle active" id="toggle-sounds"></div></div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">🔒 Приватность</div>
          <div class="settings-item" onclick="toggleSetting('showOnline')"><div class="settings-item-icon" style="background:rgba(34,197,94,0.15)"><svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div><div class="settings-item-info"><div class="settings-item-title">Показывать онлайн</div><div class="settings-item-desc">Другие видят когда вы в сети</div></div><div class="toggle active" id="toggle-showOnline"></div></div>
          <div class="settings-item" onclick="toggleSetting('showNfts')"><div class="settings-item-icon" style="background:rgba(139,92,246,0.15)"><svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div><div class="settings-item-info"><div class="settings-item-title">Показывать NFT</div><div class="settings-item-desc">Другие видят вашу NFT коллекцию</div></div><div class="toggle active" id="toggle-showNfts"></div></div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">💎 Premium & Звёзды</div>
          <div class="settings-item" onclick="openShop()"><div class="settings-item-icon" style="background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(249,115,22,0.2))"><svg viewBox="0 0 24 24" fill="#f59e0b"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div><div class="settings-item-info"><div class="settings-item-title">Магазин Premium</div><div class="settings-item-desc" id="premium-status">Получить премиум функции</div></div><div style="color:var(--accent);font-weight:600" id="user-balance">0 ⭐</div></div>
          <div class="settings-item" onclick="claimDaily()"><div class="settings-item-icon" style="background:rgba(34,197,94,0.15)"><span style="font-size:20px">📅</span></div><div class="settings-item-info"><div class="settings-item-title">Ежедневный бонус</div><div class="settings-item-desc">+10-70 ⭐ каждый день</div></div><div style="color:var(--green);font-weight:600">Получить</div></div>
          <div class="settings-item" onclick="copyReferral()"><div class="settings-item-icon" style="background:rgba(236,72,153,0.15)"><span style="font-size:20px">👥</span></div><div class="settings-item-info"><div class="settings-item-title">Пригласить друга</div><div class="settings-item-desc">+100 ⭐ за каждого друга</div></div><div style="color:var(--accent);font-weight:600">Скопировать</div></div>
          <div class="settings-item" onclick="openTelegramBot()"><div class="settings-item-icon" style="background:rgba(0,136,204,0.15)"><span style="font-size:20px">💎</span></div><div class="settings-item-info"><div class="settings-item-title">Купить звёзды</div><div class="settings-item-desc">Быстрая покупка через Telegram</div></div><div style="color:#0088cc;font-weight:600">Telegram</div></div>
          <div class="settings-item" onclick="openInventory()"><div class="settings-item-icon" style="background:rgba(236,72,153,0.15)"><span style="font-size:18px">🎒</span></div><div class="settings-item-info"><div class="settings-item-title">Мой инвентарь</div><div class="settings-item-desc">Купленные предметы</div></div></div>
          <div class="settings-item" onclick="openModal('nft');closeModal('settings')"><div class="settings-item-icon" style="background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(167,139,250,0.2))"><span style="font-size:18px">🎨</span></div><div class="settings-item-info"><div class="settings-item-title">NFT Маркет</div><div class="settings-item-desc">Купить или продать NFT username</div></div><div style="color:#a78bfa;font-weight:600">Открыть</div></div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="saveSettings()">Сохранить изменения</button>
        <button class="btn btn-ghost" style="width:100%;margin-top:12px;color:var(--red)" onclick="logout()">Выйти из аккаунта</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Modal -->
<div class="modal" id="modal-create">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>Создать</h3><button class="modal-close" onclick="closeModal('create')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:0">
      <div class="menu-item" onclick="openFavorites();closeAllModals()"><div class="avatar" style="background:#f59e0b">⭐</div><div class="menu-item-info"><div class="menu-item-title">Избранное</div><div class="menu-item-desc">Сохранённые сообщения</div></div></div>
      <div class="menu-item" onclick="openModal('newchat');closeModal('create')"><div class="avatar" style="background:var(--accent)">💬</div><div class="menu-item-info"><div class="menu-item-title">Новый чат</div><div class="menu-item-desc">Начать приватный диалог</div></div></div>
      <div class="menu-item" onclick="openModal('newgroup');closeModal('create')"><div class="avatar" style="background:#4caf50">👥</div><div class="menu-item-info"><div class="menu-item-title">Создать группу</div><div class="menu-item-desc">Групповой чат с друзьями</div></div></div>
      <div class="menu-item" onclick="openModal('newchannel');closeModal('create')"><div class="avatar" style="background:#e91e63">📢</div><div class="menu-item-info"><div class="menu-item-title">Создать канал</div><div class="menu-item-desc">Публикуйте контент для подписчиков</div></div></div>
    </div>
  </div>
</div>

<!-- New Chat Modal -->
<div class="modal" id="modal-newchat">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>Новый чат</h3><button class="modal-close" onclick="closeModal('newchat')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div style="padding:16px"><div class="form-prefix-wrap"><span class="form-prefix">@</span><input type="text" id="user-search" placeholder="Введите username" oninput="searchUsers(this.value)"></div></div>
    <div id="users-list" class="modal-body"></div>
  </div>
</div>

<!-- New Group Modal -->
<div class="modal center" id="modal-newgroup">
  <div class="modal-content" style="max-width:400px">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>Создать группу</h3><button class="modal-close" onclick="closeModal('newgroup')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div style="padding:16px">
      <form onsubmit="return createGroup(event)">
        <div class="form-group"><label class="form-label">Название группы</label><input type="text" class="form-input" id="group-name" placeholder="Друзья" required></div>
        <div class="form-group"><label class="form-label">Описание (необязательно)</label><textarea class="form-input" id="group-desc" placeholder="О чём группа..." rows="2"></textarea></div>
        <button type="submit" class="btn btn-primary" style="width:100%">Создать группу</button>
      </form>
    </div>
  </div>
</div>

<!-- New Channel Modal -->
<div class="modal" id="modal-newchannel">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>Создать канал</h3><button class="modal-close" onclick="closeModal('newchannel')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div style="padding:16px">
      <form onsubmit="return createChannel(event)">
        <div class="form-group"><label class="form-label">Название канала</label><input type="text" class="form-input" id="channel-name" placeholder="Мой канал" required></div>
        <div class="form-group"><label class="form-label">Username <span style="color:var(--text4);font-weight:400">(публичная ссылка)</span></label><div style="position:relative"><span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3)">@</span><input type="text" class="form-input" id="channel-username" placeholder="mychannel" style="padding-left:32px" oninput="checkChannelUsername(this.value)"></div><div id="channel-username-status" style="font-size:12px;margin-top:4px"></div></div>
        <div class="form-group"><label class="form-label">Описание</label><textarea class="form-input" id="channel-desc" placeholder="О чём ваш канал..." rows="2"></textarea></div>
        <button type="submit" class="btn btn-primary" style="width:100%">Создать канал</button>
      </form>
    </div>
  </div>
</div>

<!-- Channel Settings Modal -->
<div class="modal center" id="modal-channel-settings">
  <div class="modal-content" style="max-width:440px">
    <div class="modal-header"><h3>⚙️ Настройки канала</h3><button class="modal-close" onclick="closeModal('channel-settings')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:16px;max-height:70vh;overflow-y:auto">
      <!-- Avatar & Banner -->
      <div style="text-align:center;margin-bottom:20px">
        <div id="ch-settings-avatar" style="width:80px;height:80px;border-radius:20px;background:var(--accent);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;overflow:hidden" onclick="changeChannelAvatar()"></div>
        <div style="font-size:12px;color:var(--text3)">Нажмите чтобы изменить аватар</div>
      </div>
      
      <div class="form-group"><label class="form-label">Название</label><input type="text" class="form-input" id="ch-settings-name"></div>
      <div class="form-group"><label class="form-label">Username</label><div style="position:relative"><span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3)">@</span><input type="text" class="form-input" id="ch-settings-username" style="padding-left:32px" oninput="checkChannelUsernameEdit(this.value)"></div><div id="ch-settings-username-status" style="font-size:12px;margin-top:4px"></div></div>
      <div class="form-group"><label class="form-label">Описание</label><textarea class="form-input" id="ch-settings-desc" rows="3"></textarea></div>
      
      <div class="chat-info-section">
        <div class="chat-info-section-title">💰 Платные реакции</div>
        <div class="profile-items">
          <div class="profile-item" onclick="toggleChannelSetting('paidReactions')">
            <div class="profile-item-icon" style="background:rgba(255,152,0,0.15);color:var(--yellow)">⭐</div>
            <div class="profile-item-info">
              <div class="profile-item-title">Платные реакции</div>
              <div class="profile-item-desc">Подписчики платят за реакции</div>
            </div>
            <div class="toggle" id="ch-toggle-paidReactions"></div>
          </div>
          <div class="profile-item" id="ch-reaction-price-row" style="display:none">
            <div class="profile-item-icon" style="background:rgba(0,136,204,0.15);color:var(--accent)">💎</div>
            <div class="profile-item-info">
              <div class="profile-item-title">Цена реакции</div>
              <input type="number" class="form-input" id="ch-settings-reaction-price" min="1" max="100" value="1" style="width:80px;padding:8px;margin-top:4px">
            </div>
          </div>
        </div>
      </div>
      
      <div class="chat-info-section">
        <div class="chat-info-section-title">👥 Администраторы</div>
        <div class="profile-items" id="ch-admins-list"></div>
        <button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="openAddAdmin()">+ Добавить админа</button>
      </div>
      
      <div class="chat-info-section">
        <div class="chat-info-section-title">👤 Участники (<span id="ch-members-count">0</span>)</div>
        <div class="profile-items" id="ch-members-list" style="max-height:200px;overflow-y:auto"></div>
      </div>
      
      <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="saveChannelSettings()">Сохранить изменения</button>
    </div>
  </div>
</div>

<!-- Add Admin Modal -->
<div class="modal center" id="modal-add-admin">
  <div class="modal-content" style="max-width:360px">
    <div class="modal-header"><h3>Добавить админа</h3><button class="modal-close" onclick="closeModal('add-admin')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:16px">
      <p style="color:var(--text3);font-size:13px;margin-bottom:12px">Выберите участника канала:</p>
      <div id="add-admin-list" style="max-height:300px;overflow-y:auto"></div>
    </div>
  </div>
</div>

<!-- NFT Market Modal -->
<div class="modal" id="modal-nft">
  <div class="modal-content" style="max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>🎨 NFT Маркет</h3><button class="modal-close" onclick="closeModal('nft')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:16px">
      <div style="background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(167,139,250,0.15));padding:20px;border-radius:16px;margin-bottom:16px;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">🎨</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">NFT Usernames</div>
        <div style="font-size:14px;color:var(--text3)">Купите уникальный username как NFT или продайте свой</div>
      </div>
      <div class="tabs" style="margin-bottom:16px">
        <button class="tab active" onclick="switchNftTab('buy',this)">Купить</button>
        <button class="tab" onclick="switchNftTab('sell',this)">Продать</button>
        <button class="tab" onclick="switchNftTab('my',this)">Мои NFT</button>
      </div>
      <div id="nft-content">
        <div class="form-group"><label class="form-label">Поиск username</label><div class="form-prefix-wrap"><span class="form-prefix">@</span><input type="text" id="nft-search" placeholder="username" oninput="searchNft(this.value)"></div></div>
        <div id="nft-list" style="max-height:300px;overflow-y:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal center" id="modal-profile">
  <div class="modal-content" style="max-width:420px;padding:0;overflow:hidden">
    <div class="profile-banner" id="profile-banner">
      <button class="profile-close" onclick="closeModal('profile')"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <div class="profile-avatar" id="profile-avatar"></div>
    </div>
    <div class="profile-content">
      <div class="profile-header">
        <div>
          <div class="profile-name" id="profile-name"></div>
          <div class="profile-username" id="profile-username"></div>
          <div id="profile-status"></div>
        </div>
      </div>
      
      <div class="profile-bio" id="profile-bio" style="display:none"></div>
      
      <div class="profile-stats" id="profile-stats">
        <div class="profile-stat">
          <div class="profile-stat-value" id="profile-level">1</div>
          <div class="profile-stat-label">Уровень</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value" id="profile-messages">0</div>
          <div class="profile-stat-label">Сообщений</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value" id="profile-days">0</div>
          <div class="profile-stat-label">Дней</div>
        </div>
      </div>
      
      <div class="profile-actions" id="profile-actions">
        <button class="btn btn-primary" onclick="startChatFromProfile()">💬 Написать</button>
        <button class="btn btn-ghost" onclick="startCallFromProfile()">📞 Звонок</button>
        <button class="btn btn-ghost" onclick="startVideoCallFromProfile()">📹 Видео</button>
      </div>
      
      <div class="profile-section" id="profile-info-section">
        <div class="profile-section-title">Информация</div>
        <div class="profile-items">
          <div class="profile-item" id="profile-phone-item" style="display:none">
            <div class="profile-item-icon" style="background:rgba(34,197,94,0.15);color:var(--green)">📱</div>
            <div class="profile-item-info">
              <div class="profile-item-title" id="profile-phone"></div>
              <div class="profile-item-desc">Телефон</div>
            </div>
          </div>
          <div class="profile-item">
            <div class="profile-item-icon" style="background:rgba(99,102,241,0.15);color:var(--accent)">@</div>
            <div class="profile-item-info">
              <div class="profile-item-title" id="profile-username2"></div>
              <div class="profile-item-desc">Username</div>
            </div>
          </div>
          <div class="profile-item" id="profile-nft-badge" style="display:none">
            <div class="profile-item-icon" style="background:rgba(139,92,246,0.15);color:#a78bfa">🎨</div>
            <div class="profile-item-info">
              <div class="profile-item-title">NFT Username</div>
              <div class="profile-item-desc">Уникальный NFT</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="profile-section" id="profile-nfts" style="display:none">
        <div class="profile-section-title">🎨 NFT Коллекция</div>
        <div id="profile-nft-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Info Modal -->
<div class="modal" id="modal-chat-info">
  <div class="modal-content" style="max-width:420px;padding:0;overflow:hidden;max-height:90vh">
    <div class="chat-info-banner" id="chat-info-banner">
      <button class="profile-close" onclick="closeModal('chat-info')"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      <div class="chat-info-avatar" id="chat-info-avatar"></div>
    </div>
    <div class="chat-info-content">
      <div class="chat-info-name" id="chat-info-name"></div>
      <div class="chat-info-status" id="chat-info-status"></div>
      
      <div class="chat-info-actions">
        <div class="chat-info-action" onclick="startCallFromChatInfo()">
          <div class="chat-info-action-icon">📞</div>
          <div class="chat-info-action-label">Звонок</div>
        </div>
        <div class="chat-info-action" onclick="startVideoCallFromChatInfo()">
          <div class="chat-info-action-icon">📹</div>
          <div class="chat-info-action-label">Видео</div>
        </div>
        <div class="chat-info-action" onclick="toggleMuteChat()">
          <div class="chat-info-action-icon" id="chat-info-mute-icon">🔔</div>
          <div class="chat-info-action-label" id="chat-info-mute-label">Уведомл.</div>
        </div>
        <div class="chat-info-action" onclick="openProfile()">
          <div class="chat-info-action-icon">👤</div>
          <div class="chat-info-action-label">Профиль</div>
        </div>
      </div>
      
      <div class="chat-info-section">
        <div class="chat-info-section-title">Настройки чата</div>
        <div class="profile-items">
          <div class="profile-item" onclick="openWallpaperSettings()">
            <div class="profile-item-icon" style="background:rgba(236,72,153,0.15);color:var(--pink)">🎨</div>
            <div class="profile-item-info">
              <div class="profile-item-title">Обои чата</div>
              <div class="profile-item-desc">Выберите фон для этого чата</div>
            </div>
          </div>
          <div class="profile-item" onclick="exportChatHistory()">
            <div class="profile-item-icon" style="background:rgba(6,182,212,0.15);color:var(--cyan)">📤</div>
            <div class="profile-item-info">
              <div class="profile-item-title">Экспорт чата</div>
              <div class="profile-item-desc">Сохранить историю переписки</div>
            </div>
          </div>
          <div class="profile-item" onclick="clearChat()">
            <div class="profile-item-icon" style="background:rgba(245,158,11,0.15);color:var(--yellow)">🗑️</div>
            <div class="profile-item-info">
              <div class="profile-item-title">Очистить историю</div>
              <div class="profile-item-desc">Удалить все сообщения</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="chat-info-section">
        <div class="chat-info-section-title" style="color:var(--red)">Опасная зона</div>
        <div class="profile-items">
          <div class="profile-item" onclick="blockUser()">
            <div class="profile-item-icon" style="background:rgba(239,68,68,0.15);color:var(--red)">🚫</div>
            <div class="profile-item-info">
              <div class="profile-item-title" style="color:var(--red)">Заблокировать</div>
              <div class="profile-item-desc">Пользователь не сможет писать</div>
            </div>
          </div>
          <div class="profile-item" onclick="deleteChat()">
            <div class="profile-item-icon" style="background:rgba(239,68,68,0.15);color:var(--red)">❌</div>
            <div class="profile-item-info">
              <div class="profile-item-title" style="color:var(--red)">Удалить чат</div>
              <div class="profile-item-desc">Удалить чат полностью</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Emoji Modal -->
<div class="modal center" id="modal-emoji">
  <div class="modal-content" style="max-width:340px;max-height:400px">
    <div class="modal-header"><h3>Эмодзи</h3><button class="modal-close" onclick="closeModal('emoji')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:12px"><div id="emoji-grid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px"></div></div>
  </div>
</div>

<!-- Premium Shop Modal -->
<div class="modal center" id="modal-shop">
  <div class="modal-content" style="max-width:420px;max-height:90vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>💎 Premium Магазин</h3><button class="modal-close" onclick="closeModal('shop')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="shop-balance" id="shop-balance">⭐ 0 звёзд</div>
    <div class="shop-tabs">
      <button class="shop-tab active" onclick="switchShopTab('features',this)">Функции</button>
      <button class="shop-tab" onclick="switchShopTab('stickers',this)">Стикеры</button>
      <button class="shop-tab" onclick="switchShopTab('effects',this)">Эффекты</button>
      <button class="shop-tab" onclick="switchShopTab('themes',this)">Фоны</button>
    </div>
    <div class="modal-body" style="padding:0;overflow-y:auto;max-height:400px">
      <!-- Features -->
      <div class="shop-section active" id="shop-features">
        <div class="shop-grid">
          <div class="shop-item" onclick="buyPremiumItem('premium','Premium подписка',500)"><div class="shop-icon">👑</div><div class="shop-name">Premium</div><div class="shop-price">500 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('invisible','Невидимка',200)"><div class="shop-icon">👻</div><div class="shop-name">Невидимка</div><div class="shop-price">200 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('schedule','Отложка',150)"><div class="shop-icon">⏰</div><div class="shop-name">Отложенные</div><div class="shop-price">150 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('secret','Секретные</div>',250)"><div class="shop-icon">🔐</div><div class="shop-name">Секрет-чаты</div><div class="shop-price">250 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('voice_text','Голос→Текст',100)"><div class="shop-icon">🎤</div><div class="shop-name">Голос→Текст</div><div class="shop-price">100 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('stats','Статистика',80)"><div class="shop-icon">📊</div><div class="shop-name">Статистика</div><div class="shop-price">80 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('big_files','Файлы 100мб',120)"><div class="shop-icon">📁</div><div class="shop-name">Файлы 100мб</div><div class="shop-price">120 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('custom_emoji','Свои эмодзи',180)"><div class="shop-icon">😎</div><div class="shop-name">Свои эмодзи</div><div class="shop-price">180 ⭐</div></div>
        </div>
      </div>
      <!-- Stickers -->
      <div class="shop-section" id="shop-stickers">
        <div class="shop-grid">
          <div class="shop-item" onclick="buyPremiumItem('pack_cats','Котики',50)"><div class="shop-icon">😺</div><div class="shop-name">Котики</div><div class="shop-price">50 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('pack_love','Любовь',50)"><div class="shop-icon">💕</div><div class="shop-name">Любовь</div><div class="shop-price">50 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('pack_memes','Мемы',60)"><div class="shop-icon">🤣</div><div class="shop-name">Мемы</div><div class="shop-price">60 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('pack_anime','Аниме',70)"><div class="shop-icon">🌸</div><div class="shop-name">Аниме</div><div class="shop-price">70 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('pack_food','Еда',40)"><div class="shop-icon">🍕</div><div class="shop-name">Еда</div><div class="shop-price">40 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('pack_sports','Спорт',45)"><div class="shop-icon">⚽</div><div class="shop-name">Спорт</div><div class="shop-price">45 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('pack_animals','Зверята',55)"><div class="shop-icon">🐶</div><div class="shop-name">Зверята</div><div class="shop-price">55 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('pack_party','Вечеринка',50)"><div class="shop-icon">🎉</div><div class="shop-name">Вечеринка</div><div class="shop-price">50 ⭐</div></div>
        </div>
      </div>
      <!-- Effects -->
      <div class="shop-section" id="shop-effects">
        <div class="shop-grid">
          <div class="shop-item" onclick="buyPremiumItem('effect_hearts','Сердечки',30)"><div class="shop-icon">❤️</div><div class="shop-name">Сердечки</div><div class="shop-price">30 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('effect_confetti','Конфетти',30)"><div class="shop-icon">🎊</div><div class="shop-name">Конфетти</div><div class="shop-price">30 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('effect_sparkle','Искры',35)"><div class="shop-icon">✨</div><div class="shop-name">Искры</div><div class="shop-price">35 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('effect_fire','Огонь',40)"><div class="shop-icon">🔥</div><div class="shop-name">Огонь</div><div class="shop-price">40 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('effect_snow','Снежинки',35)"><div class="shop-icon">❄️</div><div class="shop-name">Снежинки</div><div class="shop-price">35 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('effect_stars','Звёзды',45)"><div class="shop-icon">⭐</div><div class="shop-name">Звёзды</div><div class="shop-price">45 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('effect_rainbow','Радуга',50)"><div class="shop-icon">🌈</div><div class="shop-name">Радуга</div><div class="shop-price">50 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('effect_ghost','Призраки',60)"><div class="shop-icon">👻</div><div class="shop-name">Призраки</div><div class="shop-price">60 ⭐</div></div>
        </div>
      </div>
      <!-- Themes -->
      <div class="shop-section" id="shop-themes">
        <div class="shop-grid">
          <div class="shop-item" onclick="buyPremiumItem('bg_gradient','Градиент',25)"><div class="shop-icon">🎨</div><div class="shop-name">Градиент</div><div class="shop-price">25 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('bg_particles','Частицы',35)"><div class="shop-icon">✦</div><div class="shop-name">Частицы</div><div class="shop-price">35 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('bg_waves','Волны',30)"><div class="shop-icon">🌊</div><div class="shop-name">Волны</div><div class="shop-price">30 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('bg_stars','Звёзды',40)"><div class="shop-icon">🌟</div><div class="shop-name">Звёзды</div><div class="shop-price">40 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('bg_matrix','Матрица',50)"><div class="shop-icon">💚</div><div class="shop-name">Матрица</div><div class="shop-price">50 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('bg_space','Космос',55)"><div class="shop-icon">🚀</div><div class="shop-name">Космос</div><div class="shop-price">55 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('bg_neon','Неон',45)"><div class="shop-icon">💜</div><div class="shop-name">Неон</div><div class="shop-price">45 ⭐</div></div>
          <div class="shop-item" onclick="buyPremiumItem('bg_sunset','Закат',40)"><div class="shop-icon">🌅</div><div class="shop-name">Закат</div><div class="shop-price">40 ⭐</div></div>
        </div>
      </div>
    </div>
    <div style="padding:12px;border-top:1px solid var(--border)">
      <button class="btn btn-primary" style="width:100%" onclick="openModal('get-stars');closeModal('shop')">💰 Получить звёзды</button>
    </div>
  </div>
</div>

<!-- Get Stars Modal -->
<div class="modal center" id="modal-get-stars">
  <div class="modal-content" style="max-width:400px">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>💰 Получить звёзды</h3><button class="modal-close" onclick="closeModal('get-stars')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body">
      <div class="stars-options">
        <div class="stars-option" onclick="earnStars('daily')"><div class="stars-icon">📅</div><div class="stars-info"><div class="stars-title">Ежедневный бонус</div><div class="stars-desc">+10-70 ⭐ (зависит от серии)</div></div><div class="stars-badge free">Бесплатно</div></div>
        <div class="stars-option" onclick="earnStars('invite')"><div class="stars-icon">👥</div><div class="stars-info"><div class="stars-title">Пригласить друга</div><div class="stars-desc">+100 ⭐ за каждого друга</div></div><div class="stars-badge free">Бесплатно</div></div>
        <div class="stars-option" onclick="earnStars('games')"><div class="stars-icon">🎮</div><div class="stars-info"><div class="stars-title">Играть с @gamebot</div><div class="stars-desc">Выигрывайте звёзды в играх</div></div><div class="stars-badge free">Бесплатно</div></div>
        <div class="stars-option" onclick="earnStars('watch')"><div class="stars-icon">📺</div><div class="stars-info"><div class="stars-title">Смотреть рекламу</div><div class="stars-desc">+15 ⭐ за просмотр</div></div><div class="stars-badge">15 ⭐</div></div>
        <div class="stars-option premium" onclick="earnStars('buy100')"><div class="stars-icon">💎</div><div class="stars-info"><div class="stars-title">100 звёзд</div><div class="stars-desc">Моментальное начисление</div></div><div class="stars-badge">$0.99</div></div>
        <div class="stars-option premium" onclick="earnStars('buy500')"><div class="stars-icon">💎</div><div class="stars-info"><div class="stars-title">500 звёзд + бонус</div><div class="stars-desc">+50 звёзд бонусом!</div></div><div class="stars-badge">$3.99</div></div>
        <div class="stars-option premium" onclick="earnStars('buy1000')"><div class="stars-icon">💎</div><div class="stars-info"><div class="stars-title">1000 звёзд + VIP</div><div class="stars-desc">+200 звёзд + VIP статус</div></div><div class="stars-badge">$6.99</div></div>
      </div>
    </div>
  </div>
</div>

<!-- Stickers Modal -->
<div class="modal center" id="modal-stickers">
  <div class="modal-content" style="max-width:380px;max-height:450px">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>🎨 Стикеры</h3><button class="modal-close" onclick="closeModal('stickers')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="sticker-pack-tabs" id="sticker-pack-tabs"></div>
    <div class="modal-body" style="padding:12px;overflow-y:auto"><div class="sticker-pack-grid" id="sticker-pack-grid"></div></div>
  </div>
</div>

<!-- Effects Picker Modal -->
<div class="modal center" id="modal-effects">
  <div class="modal-content" style="max-width:340px">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>✨ Эффект сообщения</h3><button class="modal-close" onclick="closeModal('effects')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:12px">
      <div class="effects-grid">
        <div class="effect-item" onclick="selectEffect(null)"><span>🚫</span><div>Без эффекта</div></div>
        <div class="effect-item" onclick="selectEffect('hearts')"><span>❤️</span><div>Сердечки</div></div>
        <div class="effect-item" onclick="selectEffect('confetti')"><span>🎊</span><div>Конфетти</div></div>
        <div class="effect-item" onclick="selectEffect('sparkle')"><span>✨</span><div>Искры</div></div>
        <div class="effect-item" onclick="selectEffect('fire')"><span>🔥</span><div>Огонь</div></div>
        <div class="effect-item" onclick="selectEffect('snow')"><span>❄️</span><div>Снег</div></div>
        <div class="effect-item" onclick="selectEffect('stars')"><span>⭐</span><div>Звёзды</div></div>
        <div class="effect-item" onclick="selectEffect('rainbow')"><span>🌈</span><div>Радуга</div></div>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Message Modal -->
<div class="modal center" id="modal-schedule">
  <div class="modal-content" style="max-width:360px">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>⏰ Запланировать</h3><button class="modal-close" onclick="closeModal('schedule')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Дата и время</label><input type="datetime-local" class="form-input" id="schedule-datetime"></div>
      <div class="form-group"><label class="form-label">Сообщение</label><textarea class="form-input" id="schedule-text" rows="3" placeholder="Текст сообщения..."></textarea></div>
      <div class="schedule-quick">
        <button class="schedule-quick-btn" onclick="setQuickSchedule(30)">30 мин</button>
        <button class="schedule-quick-btn" onclick="setQuickSchedule(60)">1 час</button>
        <button class="schedule-quick-btn" onclick="setQuickSchedule(180)">3 часа</button>
        <button class="schedule-quick-btn" onclick="setQuickSchedule(1440)">Завтра</button>
      </div>
      <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="scheduleMessage()">Запланировать</button>
    </div>
  </div>
</div>

<!-- Statistics Modal -->
<div class="modal center" id="modal-stats">
  <div class="modal-content" style="max-width:400px">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>📊 Статистика</h3><button class="modal-close" onclick="closeModal('stats')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" style="padding:0">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="stat-messages">0</div><div class="stat-label">Сообщений</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-chats">0</div><div class="stat-label">Чатов</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-streak">0</div><div class="stat-label">Дней подряд</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-level">1</div><div class="stat-label">Уровень</div></div>
        <div class="stat-card" style="grid-column:span 2"><div class="stat-progress"><div class="stat-progress-fill" id="stat-xp-fill"></div></div><div class="stat-label" id="stat-xp-text">0/100 XP</div></div>
      </div>
      <div class="stats-chart" id="stats-chart"></div>
    </div>
  </div>
</div>

<!-- Secret Chat Modal -->
<div class="modal center" id="modal-secret">
  <div class="modal-content" style="max-width:360px">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>🔐 Секретный чат</h3><button class="modal-close" onclick="closeModal('secret')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body">
      <div class="secret-info"><div class="secret-icon">🔒</div><p>Секретные чаты используют сквозное шифрование. Сообщения автоматически удаляются через выбранное время.</p></div>
      <div class="form-group"><label class="form-label">Username собеседника</label><div class="form-prefix-wrap"><span class="form-prefix">@</span><input type="text" id="secret-username" placeholder="username"></div></div>
      <div class="form-group"><label class="form-label">Таймер удаления</label>
        <div class="timer-options">
          <button class="timer-opt" onclick="setSecretTimer(30)">30с</button>
          <button class="timer-opt active" onclick="setSecretTimer(60)">1м</button>
          <button class="timer-opt" onclick="setSecretTimer(300)">5м</button>
          <button class="timer-opt" onclick="setSecretTimer(3600)">1ч</button>
          <button class="timer-opt" onclick="setSecretTimer(86400)">24ч</button>
        </div>
      </div>
      <button class="btn btn-primary" style="width:100%;margin-top:16px" onclick="startSecretChat()">🔐 Начать секретный чат</button>
    </div>
  </div>
</div>

<!-- Inventory Modal -->
<div class="modal center" id="modal-inventory">
  <div class="modal-content" style="max-width:400px;max-height:80vh">
    <div class="modal-handle"></div>
    <div class="modal-header"><h3>🎒 Мой инвентарь</h3><button class="modal-close" onclick="closeModal('inventory')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="inventory-tabs">
      <button class="inv-tab active" onclick="switchInvTab('items',this)">Предметы</button>
      <button class="inv-tab" onclick="switchInvTab('active',this)">Активные</button>
    </div>
    <div class="modal-body" style="padding:12px;overflow-y:auto" id="inventory-content"></div>
  </div>
</div>

<!-- Call Overlay -->
<div class="call-overlay" id="call-overlay">
  <div class="call-bg">
    <div class="call-orb call-orb-1"></div>
    <div class="call-orb call-orb-2"></div>
    <div class="call-orb call-orb-3"></div>
  </div>
  <div class="call-effects" id="call-effects"></div>
  
  <!-- Video containers -->
  <div class="call-videos">
    <video class="call-video-remote" id="remote-video" autoplay playsinline></video>
    <div class="call-video-local" id="local-video-container">
      <video id="local-video" autoplay playsinline muted></video>
    </div>
  </div>
  
  <!-- Screen share indicator -->
  <div class="call-screen-share" id="screen-share-indicator">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
    <span>Демонстрация экрана</span>
  </div>
  
  <div class="call-content">
    <div class="call-avatar" id="call-avatar"></div>
    <div class="call-name" id="call-name"></div>
    <div class="call-status" id="call-status">Вызов...</div>
    <div class="call-quality" id="call-quality" style="display:none">
      <div class="call-quality-bar active"></div>
      <div class="call-quality-bar active"></div>
      <div class="call-quality-bar active"></div>
      <div class="call-quality-bar"></div>
      <span>Отличное соединение</span>
    </div>
    <div class="call-timer" id="call-timer">00:00</div>
    
    <!-- Main call actions (during call) -->
    <div class="call-actions" id="call-main-actions">
      <button class="call-btn mute" id="btn-mute" onclick="toggleMute()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        <span class="call-btn-label">Микрофон</span>
      </button>
      <button class="call-btn video" id="btn-video" onclick="toggleVideo()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
        <span class="call-btn-label">Камера</span>
      </button>
      <button class="call-btn screen" id="btn-screen" onclick="toggleScreenShare()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
        <span class="call-btn-label">Экран</span>
      </button>
      <button class="call-btn speaker" id="btn-speaker" onclick="toggleSpeaker()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/></svg>
        <span class="call-btn-label">Динамик</span>
      </button>
      <button class="call-btn end" onclick="endCall()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.71 16.67C20.66 13.78 16.54 12 12 12 7.46 12 3.34 13.78.29 16.67c-.18.18-.29.43-.29.71 0 .28.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73 1.6 0 3.15.25 4.6.72v3.1c0 .39.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71 0-.28-.12-.52-.3-.7z"/></svg>
        <span class="call-btn-label">Завершить</span>
      </button>
    </div>
    
    <!-- Incoming call actions -->
    <div class="call-incoming-actions" id="call-incoming-actions">
      <button class="call-btn end" onclick="declineCall()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.71 16.67C20.66 13.78 16.54 12 12 12 7.46 12 3.34 13.78.29 16.67c-.18.18-.29.43-.29.71 0 .28.11.53.29.71l2.48 2.48c.18.18.43.29.71.29.27 0 .52-.11.7-.28.79-.74 1.69-1.36 2.66-1.85.33-.16.56-.5.56-.9v-3.1c1.45-.48 3-.73 4.6-.73 1.6 0 3.15.25 4.6.72v3.1c0 .39.23.74.56.9.98.49 1.87 1.12 2.67 1.85.18.18.43.28.7.28.28 0 .53-.11.71-.29l2.48-2.48c.18-.18.29-.43.29-.71 0-.28-.12-.52-.3-.7z"/></svg>
      </button>
      <button class="call-btn accept" id="btn-accept" onclick="acceptCall()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.12.96.36 1.9.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.91.34 1.85.58 2.81.7A2 2 0 0122 16.92z"/></svg>
      </button>
      <button class="call-btn video accept" id="btn-accept-video" onclick="acceptVideoCall()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- Hidden audio elements -->
<audio id="remote-audio" autoplay playsinline></audio>
<audio id="ringtone" loop preload="auto"></audio>

<!-- Image Viewer -->
<div class="img-viewer" id="img-viewer" onclick="closeImgViewer()">
  <button class="modal-close img-viewer-close"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  <img id="viewer-img" src="">
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="replyToMessage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 00-4-4H4"/></svg>Ответить</div>
  <div class="ctx-item" onclick="copyMessage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>Копировать</div>
  <div class="ctx-item danger" onclick="deleteMessage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>Удалить</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"><span class="toast-icon"></span><span class="toast-text"></span></div>

<script>
// ========================================
// 📧 EMAILJS CONFIGURATION
// ========================================
// Чтобы настроить отправку email:
// 1. Зарегистрируйтесь на https://www.emailjs.com/
// 2. Добавьте Email Service (Gmail, Outlook и т.д.)
// 3. Создайте Email Template с переменными:
//    - {{to_email}} - email получателя
//    - {{to_name}} - имя получателя  
//    - {{verification_code}} - код подтверждения
//    - {{app_name}} - название приложения
// 4. Замените значения ниже на свои:
const EMAILJS_PUBLIC_KEY = 'nW40FYh525q5zR17Z';     // Account > API Keys > Public Key
const EMAILJS_SERVICE_ID = 'service_k2dqkam';       // Email Services > Service ID
const EMAILJS_TEMPLATE_ID = 'template_gu6r3vj';     // Email Templates > Template ID
// ========================================

emailjs.init(EMAILJS_PUBLIC_KEY);
const API='',WS_URL=`ws://${location.hostname}:${location.port||3000}/ws`;
let user=null,token=null,ws=null,chats=[],currentChat=null,currentOther=null,profileUser=null;
let currentCall=null,localStream=null,peerConnection=null,callTimer=null,callSec=0;
let typingTimeout=null,lastTyping=0,replyTo=null,contextMsg=null;
let isRecording=false,mediaRecorder=null,audioChunks=[],recordingTimer=null,recordingSec=0;
let pendingReg={name:'',email:'',username:'',password:'',code:'',codeExpiry:0};
let codeTimerInterval=null;
const EMOJIS=['😀','😃','😄','😁','😆','😅','🤣','😂','🙂','😊','😇','🥰','😍','🤩','😘','😋','😛','😜','🤪','😎','🤓','🥳','😏','😌','😔','😢','😭','😤','😠','🥺','😱','🤔','🙄','😬','😴','🤮','🥴','😈','👻','💀','👽','🤖','💩','❤️','🧡','💛','💚','💙','💜','🖤','🤍','💔','💕','💖','💝','👍','👎','👊','✊','🤛','🤜','👏','🙌','👐','🤝','🙏','✌️','🤞','🤟','🤘','🤙','👋','✋','👌','💪','🔥','⭐','✨','💎','🎉','🎊','🎁','🏆','🚀','💡','💯'];
const rtcConfig={
  iceServers:[
    {urls:'stun:stun.l.google.com:19302'},
    {urls:'stun:stun1.l.google.com:19302'},
    {urls:'stun:stun2.l.google.com:19302'},
    {urls:'stun:stun3.l.google.com:19302'},
    {urls:'stun:stun4.l.google.com:19302'}
  ],
  iceCandidatePoolSize: 10
};

window.onload=async()=>{applyTheme();token=localStorage.getItem('mini_token');if(token){try{const r=await api('/api/me');if(r.user){user=r.user;setTimeout(()=>{showScreen('main');initApp()},1200);return}}catch(e){console.log('Session invalid:',e);localStorage.removeItem('mini_token');token=null}}setTimeout(()=>showScreen('welcome'),1200)};
function initApp(){connectWS();loadChats();renderSettings()}

async function api(url,opt={}){const h={'Content-Type':'application/json'};if(token)h['Authorization']='Bearer '+token;const r=await fetch(API+url,{...opt,headers:h});const d=await r.json();if(!r.ok)throw new Error(d.error||'Error');return d}

function connectWS(){if(!token)return;ws=new WebSocket(WS_URL);ws.onopen=()=>ws.send(JSON.stringify({type:'auth',token}));ws.onmessage=e=>handleWS(JSON.parse(e.data));ws.onclose=()=>setTimeout(connectWS,3000)}
function handleWS(m){
  if(m.type==='error'){toast(m.error,'error');if(m.error==='Banned'){localStorage.removeItem('mini_token');showScreen('welcome')}return}
  if(m.type==='new_message'){if(currentChat?.id===m.chatId){appendMessage(m.message);markRead(m.chatId)}else{playSound('notification')}loadChats()}
  else if(m.type==='typing'&&currentChat?.id===m.chatId)showTyping();
  else if(m.type==='messages_read'&&currentChat?.id===m.chatId)document.querySelectorAll('.msg.out .msg-status').forEach(el=>{el.classList.add('read');el.textContent='✓✓'});
  else if(m.type==='user_online'||m.type==='user_offline'){loadChats();if(currentOther?.id===m.userId)updateHeader()}
  else if(m.type==='reaction_added'&&currentChat?.id===m.chatId)loadMessages(currentChat.id);
  else if(m.type==='incoming_call'){playCallSound();showIncoming(m)}
  else if(m.type==='call_accepted'){stopCallSound();onCallAccepted(m)}
  else if(m.type==='call_ended'){stopCallSound();onCallEnded()}
  else if(m.type==='call_started'&&currentCall)currentCall.callId=m.callId;
  else if(m.type==='call_error'){toast(m.error,'error');cleanupCall();}
  else if(m.type==='rtc_offer')onOffer(m);
  else if(m.type==='rtc_answer')onAnswer(m);
  else if(m.type==='rtc_ice')onIce(m);
  else if(m.type==='message_deleted'&&currentChat?.id===m.chatId)loadMessages(currentChat.id);
  else if(m.type==='stars_earned'){user.balance=m.balance;toast(`+${m.amount} ⭐ ${m.reason}`,'success');document.querySelectorAll('[id*="balance"]').forEach(el=>el.textContent=(m.balance||0)+' ⭐')}
  else if(m.type==='level_up'){toast(`🎉 Уровень ${m.level}! +${m.bonus} ⭐`,'success');showConfetti()}
  // Channel events (Telegram-style)
  else if(m.type==='channel_post'&&currentChannel?.id===m.channelId&&channelTab==='posts'){
    loadChannelPosts();
    if(m.post.author?.id!==user?.id)playSound('notification');
  }
  else if(m.type==='channel_chat'&&currentChannel?.id===m.channelId&&channelTab==='chat'){
    const c=document.getElementById('channel-messages-inner');
    c.querySelector('[style*="text-align:center"]')?.remove();
    c.innerHTML+=`<div class="msg in" style="margin-left:0;margin-right:auto;max-width:80%"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="avatar" style="width:32px;height:32px;font-size:12px;border-radius:10px">${m.message.author?.avatar?`<img src="${m.message.author.avatar}">`:initials(m.message.author?.name)}</div><span style="font-weight:600;font-size:14px">${esc(m.message.author?.name||'')}</span><span style="color:var(--text4);font-size:12px">${formatTime(m.message.createdAt)}</span></div>${m.message.image?`<img class="msg-image" src="${m.message.image}">`:''}${m.message.text?`<div class="msg-text">${formatText(m.message.text)}</div>`:''}</div>`;
    scrollChannelBottom();
    if(m.message.author?.id!==user?.id)playSound('message');
  }
  else if(m.type==='member_joined'&&currentChannel?.id===m.channelId){toast(`${m.user.name} присоединился к каналу`,'success')}
}

// Voice WebRTC handlers
async function handleVoiceUserJoined(m){
  if(!voiceStream)return;
  const peer=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  voicePeers[m.userId]=peer;
  voiceStream.getTracks().forEach(t=>peer.addTrack(t,voiceStream));
  peer.onicecandidate=e=>{if(e.candidate)ws?.send(JSON.stringify({type:'voice_ice',to:m.userId,candidate:e.candidate}))};
  peer.ontrack=e=>{const audio=new Audio();audio.srcObject=e.streams[0];audio.play()};
  const offer=await peer.createOffer();
  await peer.setLocalDescription(offer);
  ws?.send(JSON.stringify({type:'voice_offer',to:m.userId,offer}));
}
function handleVoiceUserLeft(m){if(voicePeers[m.userId]){voicePeers[m.userId].close();delete voicePeers[m.userId]}}
async function handleVoiceOffer(m){
  if(!voiceStream)return;
  const peer=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  voicePeers[m.from]=peer;
  voiceStream.getTracks().forEach(t=>peer.addTrack(t,voiceStream));
  peer.onicecandidate=e=>{if(e.candidate)ws?.send(JSON.stringify({type:'voice_ice',to:m.from,candidate:e.candidate}))};
  peer.ontrack=e=>{const audio=new Audio();audio.srcObject=e.streams[0];audio.play()};
  await peer.setRemoteDescription(m.offer);
  const answer=await peer.createAnswer();
  await peer.setLocalDescription(answer);
  ws?.send(JSON.stringify({type:'voice_answer',to:m.from,answer}));
}
async function handleVoiceAnswer(m){if(voicePeers[m.from])await voicePeers[m.from].setRemoteDescription(m.answer)}
async function handleVoiceIce(m){if(voicePeers[m.from]&&m.candidate)await voicePeers[m.from].addIceCandidate(m.candidate)}

function generateCode(){return Math.floor(100000+Math.random()*900000).toString()}
async function startRegister(e){e.preventDefault();const name=document.getElementById('reg-name').value.trim();const email=document.getElementById('reg-email').value.trim();const username=document.getElementById('reg-username').value.trim().toLowerCase();const password=document.getElementById('reg-password').value;if(!name||!username||!password){toast('Заполните все поля','error');return false}if(password.length<6){toast('Пароль минимум 6 символов','error');return false}const btn=document.getElementById('reg-btn');btn.disabled=true;btn.textContent='Регистрация...';try{const check=await api('/api/auth/check',{method:'POST',body:JSON.stringify({username,email:email||undefined})});if(check.exists){toast(check.error||'Username или email уже заняты','error');btn.disabled=false;btn.textContent='Создать аккаунт';return false}
// If no email provided, register directly without verification
const ref = new URLSearchParams(location.search).get('ref');
if(!email){const r=await api('/api/auth/register',{method:'POST',body:JSON.stringify({name,username,password,referrer:ref,emailVerified:false})});token=r.token;user=r.user;localStorage.setItem('mini_token',token);toast('Добро пожаловать в Mini! 🎉','success');showConfetti();showScreen('main');initApp();btn.disabled=false;btn.textContent='Создать аккаунт';return false}
// If email provided, try to send verification code
const code=generateCode();pendingReg={name,email,username,password,code,codeExpiry:Date.now()+600000};try{await emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,{to_email:email,to_name:name,verification_code:code,app_name:'Mini Messenger'});document.getElementById('verify-email').textContent=email;showScreen('verify');startCodeTimer();document.querySelectorAll('.code-input')[0].focus();toast('Код отправлен на '+email,'success')}catch(emailErr){console.error('EmailJS error:',emailErr);
// If email fails, offer to register without verification
if(confirm('Не удалось отправить код на email.\n\nЗарегистрироваться без подтверждения email?')){const r=await api('/api/auth/register',{method:'POST',body:JSON.stringify({name,email,username,password,emailVerified:false})});token=r.token;user=r.user;localStorage.setItem('mini_token',token);toast('Добро пожаловать в Mini! 🎉','success');showConfetti();showScreen('main');initApp()}}}catch(err){toast('Ошибка: '+(err.message||err.text||'Неизвестная ошибка'),'error')}btn.disabled=false;btn.textContent='Создать аккаунт';return false}
function startCodeTimer(){clearInterval(codeTimerInterval);const timerEl=document.getElementById('code-timer');const wrapEl=document.getElementById('code-timer-wrap');const resendBtn=document.getElementById('resend-btn');const updateTimer=()=>{const remaining=Math.max(0,pendingReg.codeExpiry-Date.now());const mins=Math.floor(remaining/60000);const secs=Math.floor((remaining%60000)/1000);timerEl.textContent=`${mins}:${secs.toString().padStart(2,'0')}`;if(remaining<=0){clearInterval(codeTimerInterval);timerEl.textContent='Истёк';wrapEl.classList.add('expired');resendBtn.disabled=false}else{resendBtn.disabled=true;wrapEl.classList.remove('expired')}};updateTimer();codeTimerInterval=setInterval(updateTimer,1000)}
function handleCodeInput(input,idx){const val=input.value.replace(/\D/g,'');input.value=val;if(val){input.classList.add('filled');input.classList.remove('error');if(idx<5)document.querySelectorAll('.code-input')[idx+1].focus();if(idx===5)verifyCode()}else{input.classList.remove('filled')}}
function handleCodeKeydown(e,idx){if(e.key==='Backspace'&&!e.target.value&&idx>0)document.querySelectorAll('.code-input')[idx-1].focus()}
async function verifyCode(){const inputs=document.querySelectorAll('.code-input');const code=Array.from(inputs).map(i=>i.value).join('');if(code.length!==6)return;if(Date.now()>pendingReg.codeExpiry){toast('Код истёк, запросите новый','error');inputs.forEach(i=>{i.classList.add('error');setTimeout(()=>i.classList.remove('error'),500)});return}if(code!==pendingReg.code){toast('Неверный код','error');inputs.forEach(i=>{i.classList.add('error');i.value='';i.classList.remove('filled')});inputs[0].focus();return}const btn=document.getElementById('verify-btn');btn.disabled=true;btn.textContent='Регистрация...';try{const r=await api('/api/auth/register',{method:'POST',body:JSON.stringify({name:pendingReg.name,email:pendingReg.email,username:pendingReg.username,password:pendingReg.password,emailVerified:true})});token=r.token;user=r.user;localStorage.setItem('mini_token',token);toast('Добро пожаловать в Mini! 🎉','success');showConfetti();showScreen('main');initApp()}catch(err){toast(err.message,'error')}btn.disabled=false;btn.textContent='Подтвердить'}
async function resendCode(){const code=generateCode();pendingReg.code=code;pendingReg.codeExpiry=Date.now()+600000;document.getElementById('resend-btn').disabled=true;try{await emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,{to_email:pendingReg.email,to_name:pendingReg.name,verification_code:code,app_name:'Mini Messenger'});startCodeTimer();document.querySelectorAll('.code-input').forEach(i=>{i.value='';i.classList.remove('filled','error')});document.querySelectorAll('.code-input')[0].focus();toast('Новый код отправлен','success')}catch(err){toast('Ошибка отправки','error');document.getElementById('resend-btn').disabled=false}}

async function login(e){e.preventDefault();try{const r=await api('/api/auth/login',{method:'POST',body:JSON.stringify({username:document.getElementById('login-username').value.trim(),password:document.getElementById('login-password').value})});token=r.token;user=r.user;localStorage.setItem('mini_token',token);toast('С возвращением! 👋','success');showScreen('main');initApp()}catch(err){toast(err.message,'error')}return false}
function logout(){if(confirm('Выйти из аккаунта?')){localStorage.removeItem('mini_token');ws?.close();showScreen('welcome')}}

async function loadChats(){try{const r=await api('/api/chats');chats=r.chats||[];renderChats()}catch(e){}}
function renderChats(){
  const list = document.getElementById('chats-list');
  const tab = document.querySelector('.tab.active')?.textContent.includes('Каналы');
  const items = chats.filter(c => tab ? c.isChannel : !c.isChannel);
  
  if(!items.length) {
    list.innerHTML = `<div style="padding:40px 20px;text-align:center;color:var(--text3)"><p style="font-size:16px;font-weight:500">${tab?'Нет каналов':'Нет чатов'}</p><p style="font-size:13px;margin-top:8px">Создайте новый!</p></div>`;
    return;
  }
  
  list.innerHTML = items.map((c, i) => {
    const o = c.other;
    if(!o) return '';
    const isGroup = c.isGroup || c.type === 'group';
    const online = !c.isChannel && !isGroup && o.online && o.privacy?.showOnline !== false;
    
    let avatarContent = '';
    if(o.avatar) {
      avatarContent = `<img src="${o.avatar}">`;
    } else if(isGroup) {
      avatarContent = '👥';
    } else if(c.isChannel) {
      avatarContent = '📢';
    } else if(o.isBot) {
      avatarContent = '🤖';
    } else {
      avatarContent = initials(o.name);
    }
    
    let subtitle = '';
    if(c.lastMessage) {
      if(c.lastMessage.image) subtitle = '🖼 Фото';
      else if(c.lastMessage.voice) subtitle = '🎤 Голосовое';
      else subtitle = esc(c.lastMessage.text || '').substring(0, 35);
      
      // For groups, show sender name
      if(isGroup && c.lastMessage.fromUser) {
        subtitle = esc(c.lastMessage.fromUser.name?.split(' ')[0] || '') + ': ' + subtitle;
      }
    } else {
      subtitle = isGroup ? `${o.memberCount || 0} участников` : 'Нет сообщений';
    }
    
    return `<div class="chat-item ${currentChat?.id===c.id?'active':''} ${c.unread>0?'unread':''}" onclick="openChat('${c.id}')">
      <div class="avatar ${c.isChannel?'channel':''} ${online?'online':''} ${o.premium?'premium':''}">${avatarContent}</div>
      <div class="chat-info">
        <div class="chat-top">
          <span class="chat-name">${esc(o.name)}${o.verified?'<span class="chat-verified">✓</span>':''}${o.premium?'<span class="chat-premium">⭐</span>':''}</span>
          <span class="chat-time">${c.lastMessage?formatTime(c.lastMessage.createdAt):''}</span>
        </div>
        <div class="chat-bottom">
          <span class="chat-preview">${subtitle}</span>
          ${c.unread>0?`<span class="chat-badge">${c.unread}</span>`:''}
        </div>
      </div>
    </div>`;
  }).join('');
}
async function openChat(chatId){
  const chat = chats.find(c => c.id === chatId);
  if (!chat) return;
  
  // If it's a group chat
  if (chat.isGroup || chat.type === 'group') {
    await openGroupChat(chatId);
    return;
  }
  
  currentChat = chat;
  currentOther = chat.other;
  updateHeader();
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('chat-view').classList.add('active');
  document.getElementById('main-area').classList.add('active');
  await loadMessages(chatId);
  markRead(chatId);
  renderChats();
  updateSendBtn();
  document.getElementById('msg-input').focus();
}
async function loadMessages(chatId){
  try {
    // Try chat first, then group
    const endpoint = currentChat?.isGroup ? `/api/groups/${chatId}/messages` : `/api/chats/${chatId}/messages`;
    const r = await api(endpoint);
    renderMessages(r.messages || []);
  } catch(e) {
    console.error('loadMessages error:', e);
  }
}
function updateHeader(){
  const av = document.getElementById('chat-avatar');
  const isChannel = currentChat?.isChannel;
  const isGroup = currentChat?.isGroup || currentChat?.type === 'group';
  
  // Avatar
  if(currentOther.avatar) {
    av.innerHTML = `<img src="${currentOther.avatar}">`;
  } else if(isGroup) {
    av.innerHTML = '👥';
  } else if(isChannel) {
    av.innerHTML = '📢';
  } else if(currentOther.isBot) {
    av.innerHTML = '🤖';
  } else {
    av.innerHTML = initials(currentOther.name);
  }
  
  av.className = 'avatar' + (isChannel ? ' channel' : '') + ((currentOther.online && currentOther.privacy?.showOnline !== false) ? ' online' : '') + (currentOther.premium ? ' premium' : '');
  
  // Name
  let nameHtml = esc(currentOther.name);
  if(currentOther.verified) nameHtml += ' <span style="color:var(--accent)">✓</span>';
  if(currentOther.premium) nameHtml += ' ⭐';
  if(currentOther.username) nameHtml += '<br><small>@' + currentOther.username + '</small>';
  document.getElementById('chat-name').innerHTML = nameHtml;
  
  // Status
  const st = document.getElementById('chat-status');
  if(isChannel) {
    st.textContent = `${currentOther.subscribers || 0} подписчиков`;
    st.className = 'chat-header-status offline';
  } else if(isGroup) {
    st.textContent = `${currentOther.memberCount || 0} участников`;
    st.className = 'chat-header-status offline';
  } else {
    const online = currentOther.online && currentOther.privacy?.showOnline !== false;
    st.textContent = currentOther.isBot ? 'бот' : (online ? 'в сети' : 'был(а) недавно');
    st.className = 'chat-header-status' + (online || currentOther.isBot ? '' : ' offline');
  }
  
  // Actions
  document.getElementById('header-actions').style.display = isChannel ? 'none' : 'flex';
  document.getElementById('composer').style.display = (isChannel && !currentChat.isOwner) ? 'none' : 'block';
}
function closeChat(){currentChat=null;currentOther=null;document.getElementById('main-area').classList.remove('active');renderChats()}

// Chat menu functions
function searchInChat(){closeModal('chat-info');closeModal('chat-menu');toggleMessageSearch()}
function toggleMessageSearch(){const s=document.getElementById('chat-search');s.style.display=s.style.display==='none'?'flex':'none';if(s.style.display==='flex'){document.getElementById('message-search-input').focus();}else{searchMessages('');}}
function searchMessages(q){const msgs=document.querySelectorAll('.msg');msgs.forEach(m=>{const text=m.querySelector('.msg-text')?.textContent||m.querySelector('.msg-circle')?'[Кружок]':m.querySelector('.msg-voice')?'[Голосовое]':m.querySelector('.msg-image')?'[Фото]':'';m.style.opacity=text.toLowerCase().includes(q.toLowerCase())||q.trim()===''?'1':'0.3';});}
function muteChat(){closeModal('chat-info');closeModal('chat-menu');toggleMuteChat()}
async function clearChat(){closeModal('chat-info');closeModal('chat-menu');if(!currentChat)return;if(!confirm('Удалить все сообщения?'))return;try{await api(`/api/chats/${currentChat.id}/clear`,{method:'DELETE'});document.getElementById('messages-inner').innerHTML='';toast('История очищена','success')}catch(e){toast('Ошибка','error')}}
async function deleteChat(){closeModal('chat-info');closeModal('chat-menu');if(!currentChat)return;if(!confirm('Удалить чат полностью?'))return;try{await api(`/api/chats/${currentChat.id}`,{method:'DELETE'});closeChat();await loadChats();toast('Чат удалён','success')}catch(e){toast('Ошибка','error')}}

// Favorites (Saved Messages)
async function openFavorites(){try{const r=await api('/api/chats',{method:'POST',body:JSON.stringify({participantId:'saved'})});if(r.chat)await openChat(r.chat.id)}catch(e){toast('Ошибка','error')}}
async function saveToFavorites(msgId){if(!currentChat)return;try{await api('/api/favorites',{method:'POST',body:JSON.stringify({chatId:currentChat.id,messageId:msgId})});toast('Сохранено в Избранное ⭐','success')}catch(e){toast('Ошибка','error')}}
function renderMessages(msgs){
const c=document.getElementById('messages-inner');
const isGroup=currentChat?.isGroup||currentChat?.type==='group';
if(!msgs.length){let emptyIcon=currentOther?.avatar?`<img src="${currentOther.avatar}">`:(isGroup?'👥':(currentOther?.isBot?'🤖':'👤')); c.innerHTML=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center"><div class="avatar" style="width:80px;height:80px;font-size:32px;margin-bottom:16px">${emptyIcon}</div><h3 style="font-size:18px;font-weight:600;margin-bottom:6px">${esc(currentOther?.name||'')}</h3><p style="color:var(--text3);font-size:14px">${isGroup?'Напишите первое сообщение!':(currentOther?.isBot?currentOther.description:'Начните общение! 👋')}</p></div>`;return}let html='',lastDate='',lastFrom='';msgs.forEach((m,i)=>{const d=new Date(m.createdAt).toDateString();if(d!==lastDate){lastDate=d;lastFrom='';html+=`<div class="date-sep"><span>${formatDate(m.createdAt)}</span></div>`}const out=m.from===user.id;const t=new Date(m.createdAt).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});let senderHtml='';if(isGroup&&!out&&m.from!==lastFrom){const senderName=m.fromUser?.name||'Участник';senderHtml=`<div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:4px">${esc(senderName)}</div>`}lastFrom=m.from;const reactions=Object.entries(m.reactions||{}).map(([e,u])=>`<div class="reaction ${u.includes(user.id)?'active':''}" onclick="toggleReaction('${m.id}','${e}')"><span>${e}</span>${u.length}</div>`).join('');const replyHtml=m.replyTo?`<div class="msg-reply" onclick="scrollToMsg('${m.replyTo.id}')"><div class="msg-reply-name">${esc(m.replyTo.fromName||'')}</div><div class="msg-reply-text">${esc(m.replyTo.text||'Медиа')}</div></div>`:'';let content='';if(m.image)content=`<img class="msg-image" src="${m.image}" onclick="viewImage('${m.image}')">`;else if(m.circle)content=`<div class="msg-circle" onclick="playCircle(this)"><video src="${m.circle}" loop playsinline></video></div>`;else if(m.voice)content=`<div class="msg-voice"><button class="voice-play" onclick="playVoice(this,'${m.voice}')"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21"/></svg></button><div class="voice-waves">${Array(20).fill(0).map(()=>`<div class="voice-wave" style="height:${Math.random()*18+8}px"></div>`).join('')}</div><span class="voice-dur">${m.voiceDuration||'0:00'}</span></div>`;else content=`<div class="msg-text">${formatText(m.text)}</div>`;html+=`<div class="msg ${out?'out':'in'}" data-id="${m.id}" oncontextmenu="showContext(event,'${m.id}')">${senderHtml}${replyHtml}${content}<div class="msg-meta"><span class="msg-time">${t}</span>${out?`<span class="msg-status ${m.read?'read':''}">✓${m.read?'✓':''}</span>`:''}</div>${reactions?`<div class="msg-reactions">${reactions}</div>`:''}<div class="msg-actions"><button class="msg-action" onclick="setReply('${m.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 00-4-4H4"/></svg></button></div></div>`});c.innerHTML=html;scrollBottom()}
function appendMessage(m){const c=document.getElementById('messages-inner');c.querySelector('[style*="flex: 1"]')?.remove();const out=m.from===user.id;const t=new Date(m.createdAt).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});const replyHtml=m.replyTo?`<div class="msg-reply"><div class="msg-reply-name">${esc(m.replyTo.fromName||'')}</div><div class="msg-reply-text">${esc(m.replyTo.text||'Медиа')}</div></div>`:'';let content='';if(m.image)content=`<img class="msg-image" src="${m.image}" onclick="viewImage('${m.image}')">`;else if(m.circle)content=`<div class="msg-circle" onclick="playCircle(this)"><video src="${m.circle}" loop playsinline></video></div>`;else if(m.voice)content=`<div class="msg-voice"><button class="voice-play" onclick="playVoice(this,'${m.voice}')"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21"/></svg></button><div class="voice-waves">${Array(20).fill(0).map(()=>`<div class="voice-wave" style="height:${Math.random()*18+8}px"></div>`).join('')}</div><span class="voice-dur">${m.voiceDuration||'0:00'}</span></div>`;else content=`<div class="msg-text">${formatText(m.text)}</div>`;const div=document.createElement('div');div.className=`msg ${out?'out':'in'}`;div.dataset.id=m.id;div.innerHTML=`${replyHtml}${content}<div class="msg-meta"><span class="msg-time">${t}</span>${out?'<span class="msg-status">✓</span>':''}</div><div class="msg-actions"><button class="msg-action" onclick="setReply('${m.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 00-4-4H4"/></svg></button></div>`;div.setAttribute('oncontextmenu',`showContext(event,'${m.id}')`);c.appendChild(div);scrollBottom();if(!out)playSound('message')}
function showContext(e,msgId){e.preventDefault();contextMsg=msgId;const menu=document.getElementById('ctx-menu');menu.style.left=Math.min(e.clientX,window.innerWidth-200)+'px';menu.style.top=Math.min(e.clientY,window.innerHeight-180)+'px';menu.classList.add('active');setTimeout(()=>document.addEventListener('click',()=>menu.classList.remove('active'),{once:true}),10)}
function replyToMessage(){if(contextMsg)setReply(contextMsg)}
function copyMessage(){const msg=document.querySelector(`[data-id="${contextMsg}"] .msg-text`);if(msg){navigator.clipboard.writeText(msg.textContent);toast('Скопировано','success')}}
async function deleteMessage(){if(!contextMsg||!currentChat)return;try{await api(`/api/chats/${currentChat.id}/messages/${contextMsg}`,{method:'DELETE'});loadMessages(currentChat.id);toast('Удалено','success')}catch(e){toast(e.message,'error')}}
function setReply(msgId){const msg=document.querySelector(`[data-id="${msgId}"]`);if(!msg)return;const text=msg.querySelector('.msg-text')?.textContent||'Медиа';const isOut=msg.classList.contains('out');replyTo={id:msgId,text,fromName:isOut?user.name:currentOther.name};document.getElementById('reply-name').textContent=replyTo.fromName;document.getElementById('reply-text').textContent=text;document.getElementById('composer-reply').classList.add('active');document.getElementById('msg-input').focus()}
function cancelReply(){replyTo=null;document.getElementById('composer-reply').classList.remove('active')}
function toggleReaction(msgId,emoji){if(!currentChat||!ws)return;ws.send(JSON.stringify({type:'toggle_reaction',chatId:currentChat.id,messageId:msgId,emoji}))}
function updateSendBtn(){const inp=document.getElementById('msg-input');const btn=document.getElementById('send-btn');const icon=document.getElementById('send-icon');const hasText=inp&&inp.value.trim().length>0;if(hasText){btn.classList.remove('voice');icon.innerHTML='<line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>';}else{btn.classList.add('voice');icon.innerHTML='<path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/>';}}
let voiceHoldTimer=null;
function handleSendClick(){const inp=document.getElementById('msg-input');if(inp&&inp.value.trim())sendMessage()}
function handleSendMouseDown(e){const inp=document.getElementById('msg-input');if(inp&&inp.value.trim())return;e.preventDefault();voiceHoldTimer=setTimeout(()=>{startRecording()},200)}
function handleSendMouseUp(e){if(voiceHoldTimer){clearTimeout(voiceHoldTimer);voiceHoldTimer=null}if(isRecording)stopRecording()}
function sendMessage(){const inp=document.getElementById('msg-input');const text=inp.value.trim();if(!text||!currentChat||!ws)return;const msg={type:'send_message',chatId:currentChat.id,text};if(replyTo)msg.replyTo=replyTo;ws.send(JSON.stringify(msg));inp.value='';inp.style.height='auto';cancelReply();updateSendBtn()}
function sendTyping(){if(!currentChat||!ws||currentChat.isChannel)return;const now=Date.now();if(now-lastTyping>2000){lastTyping=now;ws.send(JSON.stringify({type:'typing',chatId:currentChat.id}))}}
function showTyping(){let el=document.getElementById('typing-ind');if(!el){el=document.createElement('div');el.id='typing-ind';el.className='typing-ind';el.innerHTML='<div class="typing-dots"><span></span><span></span><span></span></div>';document.getElementById('messages-inner').appendChild(el)}clearTimeout(typingTimeout);typingTimeout=setTimeout(()=>el?.remove(),3000);scrollBottom()}
function markRead(chatId){ws?.send(JSON.stringify({type:'read',chatId}))}
function updateSendBtn(){const inp=document.getElementById('msg-input');const btn=document.getElementById('send-btn');const hasText=inp.value.trim().length>0;btn.classList.toggle('voice',!hasText);btn.innerHTML=hasText?'<svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>';if(hasText){btn.onclick=sendMessage;btn.onmousedown=null;btn.onmouseup=null}else{btn.onclick=null;btn.onmousedown=startRecording;btn.onmouseup=stopRecording}}
document.getElementById('msg-input')?.addEventListener('input',updateSendBtn);
async function startRecording(){if(isRecording)return;try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(stream);audioChunks=[];mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);mediaRecorder.onstop=()=>{stream.getTracks().forEach(t=>t.stop());if(audioChunks.length&&recordingSec>=1){const blob=new Blob(audioChunks,{type:'audio/webm'});const reader=new FileReader();reader.onload=()=>sendVoice(reader.result,recordingSec);reader.readAsDataURL(blob)}};mediaRecorder.start();isRecording=true;recordingSec=0;document.getElementById('send-btn').classList.add('recording');document.getElementById('composer-input-wrap').style.display='none';document.getElementById('recording-ind').classList.add('active');recordingTimer=setInterval(()=>{recordingSec++;document.getElementById('recording-time').textContent=`${Math.floor(recordingSec/60)}:${String(recordingSec%60).padStart(2,'0')}`},1000)}catch(e){toast('Нет доступа к микрофону','error')}}
function stopRecording(){if(!isRecording)return;isRecording=false;mediaRecorder?.stop();clearInterval(recordingTimer);document.getElementById('send-btn').classList.remove('recording');document.getElementById('composer-input-wrap').style.display='flex';document.getElementById('recording-ind').classList.remove('active');updateSendBtn()}
function cancelRecording(){if(mediaRecorder)mediaRecorder.stop();audioChunks=[];stopRecording()}
function sendVoice(data,duration){if(!currentChat||!ws)return;const dur=`${Math.floor(duration/60)}:${String(duration%60).padStart(2,'0')}`;ws.send(JSON.stringify({type:'send_message',chatId:currentChat.id,voice:data,voiceDuration:dur}))}
let currentAudio=null;function playVoice(btn,src){if(currentAudio){currentAudio.pause();document.querySelectorAll('.voice-play').forEach(b=>b.innerHTML='<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21"/></svg>')}currentAudio=new Audio(src);currentAudio.play();btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';currentAudio.onended=()=>{btn.innerHTML='<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21"/></svg>';currentAudio=null}}
async function handleImageUpload(inp){const file=inp.files[0];if(!file||!currentChat)return;const reader=new FileReader();reader.onload=e=>{ws.send(JSON.stringify({type:'send_message',chatId:currentChat.id,image:e.target.result}))};reader.readAsDataURL(file);inp.value=''}
function viewImage(src){document.getElementById('viewer-img').src=src;document.getElementById('img-viewer').classList.add('active')}
function closeImgViewer(){document.getElementById('img-viewer').classList.remove('active')}
function togglePicker(){openModal('emoji');renderEmojis()}
function renderEmojis(){document.getElementById('emoji-grid').innerHTML=EMOJIS.map(e=>`<button style="width:38px;height:38px;background:transparent;border:none;font-size:22px;cursor:pointer;border-radius:8px;transition:all 0.15s" onmouseover="this.style.background='var(--surface2)';this.style.transform='scale(1.15)'" onmouseout="this.style.background='transparent';this.style.transform=''" onclick="insertEmoji('${e}')">${e}</button>`).join('')}
function insertEmoji(e){document.getElementById('msg-input').value+=e;closeModal('emoji');document.getElementById('msg-input').focus();updateSendBtn()}
async function handleSearch(q){if(!q.trim()){renderChats();return}try{const r=await api('/api/search?q='+encodeURIComponent(q));const results=[...(r.users||[]),...(r.bots||[]),...(r.channels||[])];const list=document.getElementById('chats-list');list.innerHTML=results.length?results.map(u=>`<div class="chat-item" onclick="${u.isChannel?`joinChannel('${u.id}')`:`startChat('${u.id}')`}"><div class="avatar ${u.isChannel?'channel':''}">${u.avatar?`<img src="${u.avatar}">`:(u.isChannel?'📢':(u.isBot?'🤖':initials(u.name)))}</div><div class="chat-info"><div class="chat-name">${esc(u.name)}</div><div class="chat-preview">@${u.username}</div></div></div>`).join(''):'<div style="padding:40px;text-align:center;color:var(--text3)">Не найдено</div>'}catch(e){}}
async function searchUsers(q){const list=document.getElementById('users-list');if(!q.trim()){list.innerHTML='';return}try{const r=await api('/api/search?q='+encodeURIComponent(q.replace('@','')));const results=[...(r.users||[]),...(r.bots||[])];list.innerHTML=results.length?results.map(u=>`<div class="menu-item" onclick="startChat('${u.id}')"><div class="avatar">${u.avatar?`<img src="${u.avatar}">`:(u.isBot?'🤖':initials(u.name))}</div><div class="menu-item-info"><div class="menu-item-title">${esc(u.name)}</div><div class="menu-item-desc">@${u.username}</div></div></div>`).join(''):'<div style="padding:40px;text-align:center;color:var(--text3)">Не найдено</div>'}catch(e){}}
async function startChat(userId){try{const r=await api('/api/chats',{method:'POST',body:JSON.stringify({participantId:userId})});closeAllModals();await loadChats();openChat(r.chat.id)}catch(err){toast(err.message,'error')}}
async function joinChannel(channelId){try{await api('/api/channels/'+channelId+'/join',{method:'POST'});closeAllModals();await loadChats();const chat=chats.find(c=>c.other?.id===channelId);if(chat)openChat(chat.id);toast('Вы подписались! 🎉','success')}catch(err){toast(err.message,'error')}}
function switchTab(tab,btn){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');if(tab==='channels')loadChannels();else renderChats()}
async function loadChannels(){try{const r=await api('/api/channels');const list=document.getElementById('chats-list');if(!r.channels||!r.channels.length){list.innerHTML='<div style="padding:40px;text-align:center;color:var(--text3)"><div style="font-size:40px;margin-bottom:12px">📢</div><div style="font-weight:500;margin-bottom:6px">Нет каналов</div><div style="font-size:13px">Создайте канал или присоединитесь</div></div>';return}list.innerHTML=r.channels.map(c=>`<div class="chat-item" onclick="openChannel('${c.id}')"><div class="avatar channel" style="background:#e91e63">${c.avatar?`<img src="${c.avatar}">`:((c.name||'#')[0].toUpperCase())}</div><div class="chat-info"><div class="chat-top"><span class="chat-name">${esc(c.name)}</span></div><div class="chat-bottom"><span class="chat-preview">👥 ${c.memberCount||0} участников</span></div></div></div>`).join('')}catch(e){console.error(e)}}

// Channel state
let currentChannel = null;
let currentTextChannel = null;
let currentVoiceChannel = null;
let voiceStream = null;
let voicePeers = {};

async function openChannel(channelId) {
  try {
    const r = await api('/api/channels/' + channelId);
    currentChannel = r.channel;
    document.getElementById('channel-name-header').textContent = currentChannel.name + (currentChannel.username ? ` @${currentChannel.username}` : '');
    document.getElementById('channel-subs').textContent = (currentChannel.memberCount || currentChannel.members?.length || 0) + ' подписчиков';
    
    // Update avatar
    const avatarEl = document.getElementById('channel-avatar');
    avatarEl.innerHTML = currentChannel.avatar ? `<img src="${currentChannel.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:16px">` : '📢';
    avatarEl.style.background = currentChannel.avatar ? 'transparent' : 'var(--accent)';
    
    // Show settings button for owner/admin
    const isAdmin = currentChannel.isAdmin || currentChannel.isOwner;
    document.getElementById('channel-settings-btn').style.display = isAdmin ? 'flex' : 'none';
    
    // Show channel view
    document.getElementById('channel-view').style.display = 'flex';
    document.getElementById('channel-view').classList.add('active');
    document.getElementById('chat-view').classList.remove('active');
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('main-area').classList.add('active');
    
    // Load posts by default
    switchChannelTab('posts', document.querySelector('.channel-tab'));
  } catch (e) { console.error(e); toast(e.message || 'Ошибка загрузки канала', 'error'); }
}

function closeChannel() {
  document.getElementById('channel-view').style.display = 'none';
  document.getElementById('channel-view').classList.remove('active');
  document.getElementById('empty-state').style.display = 'flex';
  document.getElementById('main-area').classList.remove('active');
  currentChannel = null;
}

let channelTab = 'posts';
function switchChannelTab(tab, btn) {
  channelTab = tab;
  document.querySelectorAll('.channel-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  
  const composer = document.getElementById('channel-composer');
  if (tab === 'posts') {
    // Only owner can post
    composer.style.display = (currentChannel?.ownerId === user?.id) ? 'flex' : 'none';
    loadChannelPosts();
  } else {
    // Chat - everyone can write
    composer.style.display = 'flex';
    loadChannelChat();
  }
}

async function loadChannelPosts() {
  if (!currentChannel) return;
  try {
    const r = await api(`/api/channels/${currentChannel.id}/posts`);
    const c = document.getElementById('channel-messages-inner');
    if (!r.posts?.length) {
      c.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text3)"><div style="font-size:48px;margin-bottom:16px">📢</div><div>Пока нет постов</div></div>';
      return;
    }
    const hasPaidReactions = currentChannel.settings?.paidReactions;
    const reactionPrice = currentChannel.settings?.reactionPrice || 1;
    c.innerHTML = r.posts.map(p => {
      const paidReactionsHtml = p.paidReactions ? Object.entries(p.paidReactions).map(([emoji, reactions]) => 
        `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,152,0,0.15);padding:4px 8px;border-radius:12px;margin-right:6px;font-size:13px">${emoji} <span style="color:var(--yellow);font-weight:600">${reactions.length * reactionPrice}⭐</span></span>`
      ).join('') : '';
      return `
      <div class="channel-post">
        <div class="channel-post-header">
          <div class="channel-post-avatar">${currentChannel.avatar ? `<img src="${currentChannel.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:12px">` : '📢'}</div>
          <div class="channel-post-info">
            <div class="channel-post-name">${esc(currentChannel.name)}${currentChannel.username ? ` <span style="color:var(--text3);font-weight:400">@${currentChannel.username}</span>` : ''}</div>
            <div class="channel-post-time">${formatTime(p.createdAt)}</div>
          </div>
        </div>
        ${p.image ? `<img class="channel-post-image" src="${p.image}" onclick="viewImage('${p.image}')">` : ''}
        ${p.text ? `<div class="channel-post-text">${formatText(p.text)}</div>` : ''}
        ${paidReactionsHtml ? `<div style="margin-top:12px">${paidReactionsHtml}</div>` : ''}
        <div class="channel-post-actions">
          <div class="channel-post-action" onclick="likePost('${p.id}')">❤️ ${p.likes?.length || 0}</div>
          ${hasPaidReactions ? `<div class="channel-post-action" onclick="sendPaidReaction('${p.id}','⭐')" style="color:var(--yellow)">⭐ ${reactionPrice}</div>` : ''}
          ${hasPaidReactions ? `<div class="channel-post-action" onclick="sendPaidReaction('${p.id}','🔥')" style="color:var(--yellow)">🔥 ${reactionPrice}</div>` : ''}
          <div class="channel-post-action" onclick="sharePost('${p.id}')">↗️ Поделиться</div>
        </div>
      </div>
    `}).join('');
    scrollChannelBottom();
  } catch (e) { console.error(e); }
}

async function loadChannelChat() {
  if (!currentChannel) return;
  try {
    const r = await api(`/api/channels/${currentChannel.id}/chat`);
    const c = document.getElementById('channel-messages-inner');
    if (!r.messages?.length) {
      c.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text3)">Пока нет сообщений. Напишите первым! 👋</div>';
      return;
    }
    c.innerHTML = r.messages.map(m => `
      <div class="msg in" style="margin-left:0;margin-right:auto;max-width:80%">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <div class="avatar" style="width:32px;height:32px;font-size:12px;border-radius:10px">${m.author?.avatar ? `<img src="${m.author.avatar}">` : initials(m.author?.name)}</div>
          <span style="font-weight:600;font-size:14px">${esc(m.author?.name || 'Пользователь')}</span>
          <span style="color:var(--text4);font-size:12px">${formatTime(m.createdAt)}</span>
        </div>
        ${m.image ? `<img class="msg-image" src="${m.image}">` : ''}
        ${m.text ? `<div class="msg-text">${formatText(m.text)}</div>` : ''}
      </div>
    `).join('');
    scrollChannelBottom();
  } catch (e) { console.error(e); }
}

function scrollChannelBottom() {
  const msgs = document.getElementById('channel-messages');
  if (msgs) setTimeout(() => msgs.scrollTop = msgs.scrollHeight, 10);
}

async function sendChannelMessage() {
  const input = document.getElementById('channel-msg-input');
  const text = input.value.trim();
  if (!text || !currentChannel) return;
  input.value = '';
  
  const endpoint = channelTab === 'posts' ? 'post' : 'chat';
  ws?.send(JSON.stringify({ type: 'channel_message', channelId: currentChannel.id, endpoint, text }));
}

function handleChannelImage(inp) {
  const file = inp.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const endpoint = channelTab === 'posts' ? 'post' : 'chat';
    ws?.send(JSON.stringify({ type: 'channel_message', channelId: currentChannel.id, endpoint, image: e.target.result }));
  };
  reader.readAsDataURL(file);
}

async function likePost(postId) {
  if (!currentChannel) return;
  try {
    await api(`/api/channels/${currentChannel.id}/posts/${postId}/like`, { method: 'POST' });
    loadChannelPosts();
  } catch (e) { console.error(e); }
}

function sharePost(postId) {
  navigator.clipboard?.writeText(location.origin + '?channel=' + currentChannel.id + '&post=' + postId);
  toast('Ссылка скопирована!', 'success');
}

async function joinVoiceChannel(voiceChannelId, name) {
  if (currentVoiceChannel === voiceChannelId) {
    // Already in this channel - leave
    leaveVoiceChannel();
    return;
  }
  
  try {
    voiceStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    currentVoiceChannel = voiceChannelId;
    
    ws?.send(JSON.stringify({ type: 'voice_join', channelId: currentChannel.id, voiceChannelId }));
    
    document.getElementById('voice-channel-name').textContent = '🎙️ ' + name;
    document.getElementById('voice-status').textContent = 'Подключено';
    document.getElementById('voice-overlay').classList.add('active');
    
    renderVoiceChannels();
    toast('Вы присоединились к голосовому каналу', 'success');
  } catch (e) {
    toast('Нет доступа к микрофону', 'error');
  }
}

function leaveVoiceChannel() {
  if (voiceStream) {
    voiceStream.getTracks().forEach(t => t.stop());
    voiceStream = null;
  }
  
  Object.values(voicePeers).forEach(peer => peer.close());
  voicePeers = {};
  
  if (currentChannel && currentVoiceChannel) {
    ws?.send(JSON.stringify({ type: 'voice_leave', channelId: currentChannel.id, voiceChannelId: currentVoiceChannel }));
  }
  
  currentVoiceChannel = null;
  document.getElementById('voice-overlay').classList.remove('active');
  renderVoiceChannels();
  toast('Вы покинули голосовой канал', 'success');
}

function toggleVoiceMute() {
  if (!voiceStream) return;
  const track = voiceStream.getAudioTracks()[0];
  track.enabled = !track.enabled;
  document.getElementById('voice-mute-btn').classList.toggle('active', !track.enabled);
}

async function copyChannelInvite() {
  if (!currentChannel) return;
  try {
    const r = await api(`/api/channels/${currentChannel.id}/invite`);
    navigator.clipboard?.writeText(location.origin + '?invite=' + r.inviteCode);
    toast('Ссылка-приглашение скопирована!', 'success');
    closeModal('channel-menu');
  } catch (e) { toast(e.message, 'error'); }
}

async function addTextChannel() {
  const name = prompt('Название текстового канала:');
  if (!name || !currentChannel) return;
  try {
    await api(`/api/channels/${currentChannel.id}/text`, { method: 'POST', body: JSON.stringify({ name }) });
    await openChannel(currentChannel.id);
    closeModal('channel-menu');
    toast('Текстовый канал создан!', 'success');
  } catch (e) { toast(e.message, 'error'); }
}

async function addVoiceChannel() {
  const name = prompt('Название голосового канала:');
  if (!name || !currentChannel) return;
  try {
    await api(`/api/channels/${currentChannel.id}/voice`, { method: 'POST', body: JSON.stringify({ name }) });
    await openChannel(currentChannel.id);
    closeModal('channel-menu');
    toast('Голосовой канал создан!', 'success');
  } catch (e) { toast(e.message, 'error'); }
}

async function leaveChannel() {
  if (!currentChannel) return;
  if (!confirm('Вы уверены, что хотите покинуть канал?')) return;
  try {
    await api(`/api/channels/${currentChannel.id}/leave`, { method: 'POST' });
    closeChannel();
    closeModal('channel-menu');
    loadChannels();
    toast('Вы покинули канал', 'success');
  } catch (e) { toast(e.message, 'error'); }
}

// NFT Functions
let nftTab='buy';
function switchNftTab(tab,btn){nftTab=tab;document.querySelectorAll('#modal-nft .tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderNftContent()}
async function renderNftContent(){const content=document.getElementById('nft-content');if(nftTab==='buy'){content.innerHTML=`<div class="form-group"><label class="form-label">Поиск username</label><div class="form-prefix-wrap"><span class="form-prefix">@</span><input type="text" id="nft-search" placeholder="username" oninput="searchNft(this.value)"></div></div><div id="nft-list" style="max-height:300px;overflow-y:auto"></div>`;loadNftMarket()}else if(nftTab==='sell'){content.innerHTML=`<div style="text-align:center;padding:20px"><p style="margin-bottom:16px">Продайте свой username как NFT</p><div class="form-group"><label class="form-label">Цена (⭐)</label><input type="number" class="form-input" id="nft-price" placeholder="100" min="10"></div><button class="btn btn-primary" onclick="listNft()">Выставить на продажу</button></div>`}else{content.innerHTML='<div id="my-nft-list"></div>';loadMyNfts()}}
async function loadNftMarket(){try{const r=await api('/api/nft/market');const list=document.getElementById('nft-list');if(!r.nfts?.length){list.innerHTML='<div style="text-align:center;padding:20px;color:var(--text3)">Нет доступных NFT</div>';return}list.innerHTML=r.nfts.map(n=>`<div class="menu-item" onclick="buyNft('${n.id}')"><div class="avatar" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa)">@</div><div class="menu-item-info"><div class="menu-item-title">@${n.username}</div><div class="menu-item-desc">${n.price} ⭐</div></div><div style="color:var(--green);font-weight:600">Купить</div></div>`).join('')}catch(e){console.error(e)}}
async function searchNft(q){if(!q.trim()){loadNftMarket();return}try{const r=await api('/api/nft/search?q='+encodeURIComponent(q));const list=document.getElementById('nft-list');list.innerHTML=r.available?`<div class="menu-item" onclick="buyNftUsername('${q}')"><div class="avatar" style="background:linear-gradient(135deg,#22c55e,#4ade80)">✓</div><div class="menu-item-info"><div class="menu-item-title">@${q}</div><div class="menu-item-desc">Доступен для покупки</div></div><div style="color:var(--green);font-weight:600">50 ⭐</div></div>`:`<div style="text-align:center;padding:20px;color:var(--text3)">Username занят или недоступен</div>`}catch(e){console.error(e)}}
async function buyNft(id){try{const r=await api('/api/nft/buy',{method:'POST',body:JSON.stringify({nftId:id})});toast('NFT куплен! 🎉','success');user.balance=r.balance;loadNftMarket()}catch(e){toast(e.message,'error')}}
async function buyNftUsername(username){if(!confirm(`Купить @${username} за 50 ⭐?`))return;try{const r=await api('/api/nft/buy-username',{method:'POST',body:JSON.stringify({username})});toast('Username куплен! 🎉','success');user.balance=r.balance;user.username=username;showConfetti()}catch(e){toast(e.message,'error')}}
async function listNft(){const price=parseInt(document.getElementById('nft-price').value);if(!price||price<10){toast('Минимальная цена 10 ⭐','error');return}try{await api('/api/nft/list',{method:'POST',body:JSON.stringify({price})});toast('Выставлено на продажу!','success');switchNftTab('my',document.querySelectorAll('#modal-nft .tab')[2])}catch(e){toast(e.message,'error')}}
async function loadMyNfts(){try{const r=await api('/api/nft/my');const list=document.getElementById('my-nft-list');if(!r.nfts?.length){list.innerHTML='<div style="text-align:center;padding:20px;color:var(--text3)">У вас нет NFT</div>';return}list.innerHTML=r.nfts.map(n=>`<div class="menu-item"><div class="avatar" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa)">@</div><div class="menu-item-info"><div class="menu-item-title">@${n.username}</div><div class="menu-item-desc">${n.forSale?`Продаётся за ${n.price} ⭐`:'Ваш username'}</div></div>${n.forSale?`<button class="btn btn-sm" onclick="cancelNftListing('${n.id}')">Отмена</button>`:''}</div>`).join('')}catch(e){console.error(e)}}
async function cancelNftListing(id){try{await api('/api/nft/cancel',{method:'POST',body:JSON.stringify({nftId:id})});toast('Снято с продажи','success');loadMyNfts()}catch(e){toast(e.message,'error')}}

async function createChannel(e){e.preventDefault();try{const username=document.getElementById('channel-username').value.trim();const r=await api('/api/channels',{method:'POST',body:JSON.stringify({name:document.getElementById('channel-name').value.trim(),username:username||null,description:document.getElementById('channel-desc').value.trim()})});closeAllModals();document.querySelectorAll('.tab')[1]?.click();toast('Канал создан! 🎉','success');showConfetti()}catch(err){toast(err.message,'error')}return false}

let channelUsernameTimeout=null;
async function checkChannelUsername(value){
  const status=document.getElementById('channel-username-status');
  if(!value){status.innerHTML='';return}
  const username=value.toLowerCase().replace(/[^a-z0-9_]/g,'');
  if(username.length<3){status.innerHTML='<span style="color:var(--yellow)">Минимум 3 символа</span>';return}
  clearTimeout(channelUsernameTimeout);
  channelUsernameTimeout=setTimeout(async()=>{
    try{
      const r=await api('/api/channels/check-username',{method:'POST',body:JSON.stringify({username})});
      status.innerHTML=r.available?'<span style="color:var(--green)">✓ Свободен</span>':'<span style="color:var(--red)">✗ Занят</span>';
    }catch(e){status.innerHTML=''}
  },300);
}

async function checkChannelUsernameEdit(value){
  const status=document.getElementById('ch-settings-username-status');
  if(!value){status.innerHTML='<span style="color:var(--text3)">Без публичной ссылки</span>';return}
  const username=value.toLowerCase().replace(/[^a-z0-9_]/g,'');
  if(username.length<3){status.innerHTML='<span style="color:var(--yellow)">Минимум 3 символа</span>';return}
  if(username===currentChannel?.username){status.innerHTML='<span style="color:var(--green)">✓ Текущий</span>';return}
  clearTimeout(channelUsernameTimeout);
  channelUsernameTimeout=setTimeout(async()=>{
    try{
      const r=await api('/api/channels/check-username',{method:'POST',body:JSON.stringify({username})});
      status.innerHTML=r.available?'<span style="color:var(--green)">✓ Свободен</span>':'<span style="color:var(--red)">✗ Занят</span>';
    }catch(e){status.innerHTML=''}
  },300);
}

async function openChannelSettings(){
  if(!currentChannel)return;
  try{
    const r=await api('/api/channels/'+currentChannel.id);
    currentChannel=r.channel;
    
    document.getElementById('ch-settings-name').value=currentChannel.name||'';
    document.getElementById('ch-settings-username').value=currentChannel.username||'';
    document.getElementById('ch-settings-desc').value=currentChannel.description||'';
    
    const avatarEl=document.getElementById('ch-settings-avatar');
    avatarEl.innerHTML=currentChannel.avatar?`<img src="${currentChannel.avatar}" style="width:100%;height:100%;object-fit:cover">`:(currentChannel.name||'#')[0].toUpperCase();
    
    // Settings toggles
    const settings=currentChannel.settings||{};
    document.getElementById('ch-toggle-paidReactions').classList.toggle('active',settings.paidReactions);
    document.getElementById('ch-reaction-price-row').style.display=settings.paidReactions?'flex':'none';
    document.getElementById('ch-settings-reaction-price').value=settings.reactionPrice||1;
    
    // Admins list
    const adminsHtml=(currentChannel.admins||[]).map(aId=>{
      const admin=currentChannel.members?.find(m=>m.id===aId);
      if(!admin)return'';
      const isOwner=aId===currentChannel.ownerId;
      return`<div class="profile-item"><div class="avatar" style="width:40px;height:40px;font-size:14px">${admin.avatar?`<img src="${admin.avatar}">`:(admin.name||'?')[0]}</div><div class="profile-item-info"><div class="profile-item-title">${esc(admin.name)} ${isOwner?'<span style="color:var(--yellow)">👑</span>':''}</div><div class="profile-item-desc">@${admin.username}</div></div>${!isOwner?`<button class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="removeAdmin('${aId}')">Убрать</button>`:''}</div>`;
    }).join('');
    document.getElementById('ch-admins-list').innerHTML=adminsHtml||'<div style="padding:12px;color:var(--text3);text-align:center">Нет админов</div>';
    
    // Members list  
    document.getElementById('ch-members-count').textContent=currentChannel.members?.length||0;
    const membersHtml=(currentChannel.members||[]).slice(0,50).map(m=>{
      const role=currentChannel.roles?.[m.id]||'member';
      const roleIcon=role==='owner'?'👑':(role==='admin'?'⭐':'');
      return`<div class="profile-item" style="padding:10px 12px"><div class="avatar" style="width:36px;height:36px;font-size:13px">${m.avatar?`<img src="${m.avatar}">`:(m.name||'?')[0]}</div><div class="profile-item-info"><div class="profile-item-title" style="font-size:14px">${esc(m.name)} ${roleIcon}</div><div class="profile-item-desc" style="font-size:11px">@${m.username}</div></div>${role==='member'&&currentChannel.isOwner?`<button class="btn" style="padding:4px 8px;font-size:10px;background:var(--red);color:#fff" onclick="kickMember('${m.id}')">Кик</button>`:''}</div>`;
    }).join('');
    document.getElementById('ch-members-list').innerHTML=membersHtml||'<div style="padding:12px;color:var(--text3);text-align:center">Нет участников</div>';
    
    openModal('channel-settings');
  }catch(e){toast(e.message||'Ошибка','error')}
}

function toggleChannelSetting(key){
  const toggle=document.getElementById('ch-toggle-'+key);
  toggle.classList.toggle('active');
  if(key==='paidReactions'){
    document.getElementById('ch-reaction-price-row').style.display=toggle.classList.contains('active')?'flex':'none';
  }
}

async function saveChannelSettings(){
  if(!currentChannel)return;
  try{
    const settings={
      paidReactions:document.getElementById('ch-toggle-paidReactions').classList.contains('active'),
      reactionPrice:parseInt(document.getElementById('ch-settings-reaction-price').value)||1
    };
    await api('/api/channels/'+currentChannel.id+'/settings',{method:'PUT',body:JSON.stringify({
      name:document.getElementById('ch-settings-name').value.trim(),
      username:document.getElementById('ch-settings-username').value.trim()||null,
      description:document.getElementById('ch-settings-desc').value.trim(),
      settings
    })});
    toast('Сохранено!','success');
    closeModal('channel-settings');
    openChannel(currentChannel.id);
  }catch(e){toast(e.message||'Ошибка','error')}
}

async function changeChannelAvatar(){
  const url=prompt('URL аватара канала:');
  if(!url)return;
  try{
    await api('/api/channels/'+currentChannel.id+'/settings',{method:'PUT',body:JSON.stringify({avatar:url})});
    document.getElementById('ch-settings-avatar').innerHTML=`<img src="${url}" style="width:100%;height:100%;object-fit:cover">`;
    toast('Аватар обновлён','success');
  }catch(e){toast(e.message||'Ошибка','error')}
}

function openAddAdmin(){
  const members=(currentChannel?.members||[]).filter(m=>
    m.id!==currentChannel.ownerId&&!currentChannel.admins?.includes(m.id)
  );
  document.getElementById('add-admin-list').innerHTML=members.length?members.map(m=>
    `<div class="profile-item" onclick="addAdmin('${m.id}')" style="cursor:pointer"><div class="avatar" style="width:40px;height:40px;font-size:14px">${m.avatar?`<img src="${m.avatar}">`:(m.name||'?')[0]}</div><div class="profile-item-info"><div class="profile-item-title">${esc(m.name)}</div><div class="profile-item-desc">@${m.username}</div></div></div>`
  ).join(''):'<div style="padding:20px;text-align:center;color:var(--text3)">Нет доступных участников</div>';
  openModal('add-admin');
}

async function addAdmin(userId){
  try{
    await api('/api/channels/'+currentChannel.id+'/admins',{method:'POST',body:JSON.stringify({userId,action:'add'})});
    toast('Админ добавлен','success');
    closeModal('add-admin');
    openChannelSettings();
  }catch(e){toast(e.message||'Ошибка','error')}
}

async function removeAdmin(userId){
  if(!confirm('Убрать права админа?'))return;
  try{
    await api('/api/channels/'+currentChannel.id+'/admins',{method:'POST',body:JSON.stringify({userId,action:'remove'})});
    toast('Права убраны','success');
    openChannelSettings();
  }catch(e){toast(e.message||'Ошибка','error')}
}

async function kickMember(userId){
  if(!confirm('Кикнуть участника?'))return;
  try{
    await api('/api/channels/'+currentChannel.id+'/kick',{method:'POST',body:JSON.stringify({userId})});
    toast('Участник кикнут','success');
    openChannelSettings();
  }catch(e){toast(e.message||'Ошибка','error')}
}

async function sendPaidReaction(postId,emoji='⭐'){
  if(!currentChannel)return;
  const price=currentChannel.settings?.reactionPrice||1;
  if(!confirm(`Отправить платную реакцию за ${price}⭐?`))return;
  try{
    const r=await api('/api/channels/'+currentChannel.id+'/posts/'+postId+'/paid-reaction',{method:'POST',body:JSON.stringify({emoji})});
    user.balance=r.balance;
    updateBalanceDisplay();
    toast(`Реакция отправлена! -${price}⭐`,'success');
    loadChannelPosts();
  }catch(e){toast(e.message||'Ошибка','error')}
}

// ========== GROUPS ==========
async function createGroup(e){
  e.preventDefault();
  try {
    const r = await api('/api/groups', {
      method: 'POST',
      body: JSON.stringify({
        name: document.getElementById('group-name').value.trim(),
        description: document.getElementById('group-desc').value.trim()
      })
    });
    closeAllModals();
    await loadChats();
    await openGroupChat(r.group.id);
    toast('Группа создана!', 'success');
  } catch(err) {
    toast(err.message, 'error');
  }
  return false;
}

async function openGroupChat(groupId) {
  try {
    const r = await api(`/api/groups/${groupId}`);
    const group = r.group;
    
    currentChat = { id: group.id, isGroup: true, type: 'group' };
    currentOther = { 
      id: group.id, 
      name: group.name, 
      avatar: group.avatar,
      memberCount: group.memberCount,
      isGroup: true
    };
    
    updateHeader();
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('chat-view').classList.add('active');
    document.getElementById('main-area').classList.add('active');
    
    const msgs = await api(`/api/groups/${groupId}/messages`);
    renderMessages(msgs.messages || []);
    
    renderChats();
    updateSendBtn();
    document.getElementById('msg-input').focus();
  } catch(e) {
    toast('Ошибка загрузки группы', 'error');
  }
}

async function addMemberToGroup(userId) {
  if (!currentChat?.isGroup) return;
  try {
    await api(`/api/groups/${currentChat.id}/members`, {
      method: 'POST',
      body: JSON.stringify({ userId })
    });
    toast('Участник добавлен', 'success');
  } catch(e) {
    toast(e.message, 'error');
  }
}

async function leaveGroup() {
  if (!currentChat?.isGroup) return;
  if (!confirm('Покинуть группу?')) return;
  try {
    await api(`/api/groups/${currentChat.id}/leave`, { method: 'POST' });
    closeChat();
    await loadChats();
    toast('Вы покинули группу', 'success');
  } catch(e) {
    toast(e.message, 'error');
  }
}

async function startGroupCall() {
  if (!currentChat?.isGroup) return;
  ws?.send(JSON.stringify({ type: 'start_group_call', groupId: currentChat.id }));
}

function openProfile(){
  if(!currentOther)return;
  profileUser=currentOther;
  
  // Avatar
  const av=document.getElementById('profile-avatar');
  av.innerHTML=profileUser.avatar?`<img src="${profileUser.avatar}">`:(profileUser.isBot?'🤖':initials(profileUser.name));
  
  // Banner
  const banner = document.getElementById('profile-banner');
  if(profileUser.banner) {
    banner.style.background = `url(${profileUser.banner}) center/cover`;
  } else {
    banner.style.background = '';
  }
  
  // Name with badges
  let nameHtml = esc(profileUser.name);
  if(profileUser.verified) nameHtml += ' <span style="color:#3b82f6">✓</span>';
  if(profileUser.premium) nameHtml += ' ⭐';
  document.getElementById('profile-name').innerHTML = nameHtml;
  
  // Username
  document.getElementById('profile-username').textContent = '@' + profileUser.username;
  document.getElementById('profile-username2').textContent = '@' + profileUser.username;
  
  // Status
  const statusEl = document.getElementById('profile-status');
  if(profileUser.online) {
    statusEl.className = 'profile-online';
    statusEl.textContent = 'онлайн';
  } else {
    statusEl.className = 'profile-offline';
    statusEl.textContent = 'был(а) недавно';
  }
  
  // Bio
  const bioEl = document.getElementById('profile-bio');
  if(profileUser.bio) {
    bioEl.textContent = profileUser.bio;
    bioEl.style.display = 'block';
  } else {
    bioEl.style.display = 'none';
  }
  
  // Stats
  document.getElementById('profile-level').textContent = profileUser.level || 1;
  document.getElementById('profile-messages').textContent = '—';
  document.getElementById('profile-days').textContent = profileUser.createdAt ? 
    Math.floor((Date.now() - profileUser.createdAt) / 86400000) : '—';
  
  // NFT Usernames collection
  const nftSection = document.getElementById('profile-nfts');
  const nftGrid = document.getElementById('profile-nft-grid');
  const nftBadge = document.getElementById('profile-nft-badge');
  const nftUsernames = profileUser.nftUsernames || [];
  
  if(nftUsernames.length > 0) {
    nftSection.style.display = 'block';
    nftGrid.innerHTML = nftUsernames.map(nft => `
      <div style="background:var(--surface2);border-radius:8px;padding:10px;text-align:center">
        <div style="font-size:24px;margin-bottom:4px">@</div>
        <div style="font-size:12px;font-weight:600;color:var(--accent)">@${esc(nft.username || nft)}</div>
        ${nft.rarity ? `<div style="font-size:10px;color:var(--text4);margin-top:2px">${nft.rarity}</div>` : ''}
      </div>
    `).join('');
    nftBadge.style.display = 'flex';
  } else {
    nftSection.style.display = 'none';
    nftBadge.style.display = 'none';
  }
  
  // Actions - hide for self/bots
  document.getElementById('profile-actions').style.display = 
    (profileUser.id === user?.id || profileUser.isBot) ? 'none' : 'flex';
  document.getElementById('profile-stats').style.display = profileUser.isBot ? 'none' : 'grid';
  
  openModal('profile');
}
function startChatFromProfile(){if(profileUser){startChat(profileUser.id);closeModal('profile')}}
function startCallFromProfile(){if(profileUser&&!profileUser.isBot){closeModal('profile');setTimeout(startCall,100)}}
function startVideoCallFromProfile(){if(profileUser&&!profileUser.isBot){closeModal('profile');setTimeout(startVideoCall,100)}}

// Chat Info Modal
let mutedChats = JSON.parse(localStorage.getItem('mini_muted') || '[]');

function openChatInfo(){
  if(!currentOther)return;
  
  // Banner
  const banner = document.getElementById('chat-info-banner');
  if(currentOther.banner) {
    banner.style.background = `url(${currentOther.banner}) center/cover`;
    banner.classList.add('custom');
  } else {
    banner.style.background = '';
    banner.classList.remove('custom');
  }
  
  const av = document.getElementById('chat-info-avatar');
  av.innerHTML = currentOther.avatar ? `<img src="${currentOther.avatar}">` :
    (currentOther.isBot ? '🤖' : initials(currentOther.name));
  
  document.getElementById('chat-info-name').textContent = currentOther.name;
  
  const statusEl = document.getElementById('chat-info-status');
  if(currentOther.isBot) {
    statusEl.textContent = 'бот';
  } else if(currentOther.online) {
    statusEl.innerHTML = '<span style="color:var(--green)">● онлайн</span>';
  } else {
    statusEl.textContent = 'был(а) недавно';
  }
  
  const isMuted = mutedChats.includes(currentChat?.id);
  document.getElementById('chat-info-mute-icon').textContent = isMuted ? '🔕' : '🔔';
  document.getElementById('chat-info-mute-label').textContent = isMuted ? 'Вкл. звук' : 'Уведомл.';
  
  openModal('chat-info');
}

function startCallFromChatInfo(){closeModal('chat-info');startCall()}
function startVideoCallFromChatInfo(){closeModal('chat-info');startVideoCall()}

function toggleMuteChat(){
  if(!currentChat)return;
  const idx = mutedChats.indexOf(currentChat.id);
  if(idx === -1) {
    mutedChats.push(currentChat.id);
    document.getElementById('chat-info-mute-icon').textContent = '🔕';
    document.getElementById('chat-info-mute-label').textContent = 'Вкл. звук';
    toast('Уведомления отключены', 'success');
  } else {
    mutedChats.splice(idx, 1);
    document.getElementById('chat-info-mute-icon').textContent = '🔔';
    document.getElementById('chat-info-mute-label').textContent = 'Уведомл.';
    toast('Уведомления включены', 'success');
  }
  localStorage.setItem('mini_muted', JSON.stringify(mutedChats));
}

function openWallpaperSettings(){
  closeModal('chat-info');
  openModal('settings');
  setTimeout(() => document.getElementById('wallpaper-grid')?.scrollIntoView({behavior:'smooth'}), 300);
}

function exportChatHistory(){
  if(!currentChat)return;
  let text = `Чат с ${currentOther?.name}\nЭкспорт: ${new Date().toLocaleString('ru')}\n\n`;
  document.querySelectorAll('.msg').forEach(el => {
    const name = el.classList.contains('out') ? user.name : currentOther?.name;
    const time = el.querySelector('.msg-time')?.textContent || '';
    const content = el.querySelector('.msg-text')?.textContent || '[медиа]';
    text += `[${time}] ${name}: ${content}\n`;
  });
  const blob = new Blob([text], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `chat_${currentOther?.username}_${Date.now()}.txt`;
  a.click();
  toast('Чат экспортирован!', 'success');
  closeModal('chat-info');
}

function blockUser(){
  if(!currentOther||!confirm(`Заблокировать ${currentOther.name}?`))return;
  toast('Пользователь заблокирован', 'success');
  closeModal('chat-info');
  showScreen('chats');
}
function renderSettings(){document.getElementById('settings-name').value=user.name||'';document.getElementById('settings-bio').value=user.bio||'';const av=document.getElementById('settings-avatar');av.innerHTML=user.avatar?`<img src="${user.avatar}">`:initials(user.name);document.getElementById('toggle-showOnline').classList.toggle('active',user.privacy?.showOnline!==false);document.getElementById('toggle-sounds').classList.toggle('active',user.sounds!==false);document.getElementById('premium-status').textContent=user.premium?'Premium активен ✓':'Получить премиум функции';document.getElementById('user-balance').textContent=(user.balance||0)+' ⭐';const emailStatus=document.getElementById('email-status');if(user.emailVerified)emailStatus.innerHTML=`<div class="email-badge">📧 Email подтверждён</div>`;else emailStatus.innerHTML='';const theme=localStorage.getItem('mini_theme')||'';document.querySelectorAll('.theme-opt').forEach(o=>o.classList.toggle('active',o.dataset.theme===theme));renderWallpapers();applyActiveItems()}
async function saveSettings(){try{const r=await api('/api/user/settings',{method:'PUT',body:JSON.stringify({name:document.getElementById('settings-name').value.trim(),bio:document.getElementById('settings-bio').value.trim()})});user=r.user;toast('Сохранено! ✓','success');closeModal('settings');loadChats()}catch(err){toast(err.message,'error')}}
function toggleSetting(key){const toggle=document.getElementById('toggle-'+key);toggle.classList.toggle('active');const val=toggle.classList.contains('active');if(key==='sounds'){user.sounds=val;api('/api/user/settings',{method:'PUT',body:JSON.stringify({sounds:val})})}else{user.privacy=user.privacy||{};user.privacy[key]=val;api('/api/user/settings',{method:'PUT',body:JSON.stringify({privacy:user.privacy})})}}
async function handleAvatar(inp){const file=inp.files[0];if(!file)return;const reader=new FileReader();reader.onload=async e=>{try{const r=await api('/api/user/avatar',{method:'PUT',body:JSON.stringify({avatar:e.target.result})});user.avatar=r.avatar;renderSettings();toast('Фото обновлено!','success')}catch(err){toast(err.message,'error')}};reader.readAsDataURL(file)}
function setTheme(theme){localStorage.setItem('mini_theme',theme);applyTheme();document.querySelectorAll('.theme-opt').forEach(o=>o.classList.toggle('active',o.dataset.theme===theme));toast('Тема применена!','success')}
function applyTheme(){const theme=localStorage.getItem('mini_theme')||'';const root=document.documentElement;
// Reset all variables to dark theme defaults
root.classList.remove('light');
root.style.setProperty('--bg','#020617');
root.style.setProperty('--surface','#0f172a');
root.style.setProperty('--surface2','#1e293b');
root.style.setProperty('--surface3','#334155');
root.style.setProperty('--text','#f8fafc');
root.style.setProperty('--text2','#e2e8f0');
root.style.setProperty('--text3','#94a3b8');
root.style.setProperty('--text4','#64748b');
root.style.setProperty('--border','rgba(255,255,255,0.06)');
root.style.setProperty('--border2','rgba(255,255,255,0.1)');
root.style.setProperty('--glass','rgba(15,23,42,0.8)');
root.style.setProperty('--glass2','rgba(15,23,42,0.95)');
root.style.setProperty('--accent','#6366f1');
root.style.setProperty('--accent-light','#818cf8');
root.style.setProperty('--accent-glow','rgba(99,102,241,0.4)');
root.style.setProperty('--accent-rgb','99,102,241');
const themes={purple:{accent:'#a855f7',light:'#c084fc',rgb:'168,85,247'},emerald:{accent:'#10b981',light:'#34d399',rgb:'16,185,129'},rose:{accent:'#f43f5e',light:'#fb7185',rgb:'244,63,94'},amber:{accent:'#f59e0b',light:'#fbbf24',rgb:'245,158,11'},cyan:{accent:'#06b6d4',light:'#22d3ee',rgb:'6,182,212'},pink:{accent:'#ec4899',light:'#f472b6',rgb:'236,72,153'},ocean:{accent:'#0ea5e9',light:'#38bdf8',rgb:'14,165,233'},sunset:{accent:'#f97316',light:'#fb923c',rgb:'249,115,22'},neon:{accent:'#22d3ee',light:'#a78bfa',rgb:'34,211,238'},light:{accent:'#6366f1',light:'#818cf8',rgb:'99,102,241',isLight:true}};if(themes[theme]){root.style.setProperty('--accent',themes[theme].accent);root.style.setProperty('--accent-light',themes[theme].light);root.style.setProperty('--accent-glow',`rgba(${themes[theme].rgb},0.4)`);root.style.setProperty('--accent-rgb',themes[theme].rgb);if(themes[theme].isLight){root.classList.add('light');root.style.setProperty('--bg','#f1f5f9');root.style.setProperty('--surface','#ffffff');root.style.setProperty('--surface2','#f8fafc');root.style.setProperty('--surface3','#e2e8f0');root.style.setProperty('--text','#0f172a');root.style.setProperty('--text2','#1e293b');root.style.setProperty('--text3','#64748b');root.style.setProperty('--text4','#94a3b8');root.style.setProperty('--border','rgba(0,0,0,0.08)');root.style.setProperty('--border2','rgba(0,0,0,0.12)');root.style.setProperty('--glass','rgba(255,255,255,0.9)');root.style.setProperty('--glass2','rgba(255,255,255,0.95)')}}}
function startCall(withVideo=false){
  if(!currentOther||currentOther.isBot||currentCall)return;
  currentCall={to:currentOther.id,name:currentOther.name,avatar:currentOther.avatar,outgoing:true,video:withVideo};
  showCallUI(false,withVideo);
  playCallSound();
  ws.send(JSON.stringify({type:'start_call',to:currentOther.id,video:withVideo}));
}
function startVideoCall(){startCall(true)}
function showIncoming(m){
  currentCall={from:m.from,callId:m.callId,name:m.name,avatar:m.avatar,incoming:true,video:m.video};
  showCallUI(true,m.video);
  playCallSound();
}
function showCallUI(incoming=false,video=false){
  const overlay=document.getElementById('call-overlay');
  const av=document.getElementById('call-avatar');
  av.innerHTML=currentCall.avatar?`<img src="${currentCall.avatar}">`:initials(currentCall.name);
  av.classList.toggle('ringing',true);
  document.getElementById('call-name').textContent=currentCall.name;
  document.getElementById('call-status').textContent=incoming?'Входящий звонок...':'Вызов...';
  document.getElementById('call-timer').classList.remove('active');
  document.getElementById('call-quality').style.display='none';
  
  // Reset buttons
  document.getElementById('btn-mute').classList.remove('active');
  document.getElementById('btn-video').classList.remove('active','off');
  document.getElementById('btn-screen').classList.remove('active');
  document.getElementById('btn-speaker').classList.remove('active');
  
  // Show/hide appropriate buttons for incoming
  if(incoming){
    overlay.classList.add('incoming');
    document.getElementById('btn-accept').classList.add('show');
    document.getElementById('btn-accept-video').style.display=video?'flex':'none';
  }else{
    overlay.classList.remove('incoming');
    document.getElementById('btn-accept').classList.remove('show');
  }
  
  overlay.classList.toggle('video-mode',false);
  overlay.classList.add('active');
  createCallParticles();
}
async function acceptCall(){
  if(!currentCall)return;
  stopCallSound();
  document.getElementById('call-overlay').classList.remove('incoming');
  document.getElementById('btn-accept').classList.remove('show');
  document.getElementById('call-status').textContent='Подключение...';
  ws.send(JSON.stringify({type:'accept_call',callId:currentCall.callId,to:currentCall.from}));
  await setupPeerConnection(false,false);
}
async function acceptVideoCall(){
  if(!currentCall)return;
  stopCallSound();
  currentCall.video=true;
  document.getElementById('call-overlay').classList.remove('incoming');
  document.getElementById('btn-accept').classList.remove('show');
  document.getElementById('call-status').textContent='Подключение...';
  ws.send(JSON.stringify({type:'accept_call',callId:currentCall.callId,to:currentCall.from,video:true}));
  await setupPeerConnection(false,true);
}
function declineCall(){
  if(currentCall){
    ws.send(JSON.stringify({type:'end_call',callId:currentCall.callId,to:currentCall.from}));
  }
  cleanupCall();
}
async function onCallAccepted(m){
  stopCallSound();
  currentCall.callId=m.callId;
  document.getElementById('call-status').textContent='Подключение...';
  await setupPeerConnection(true,currentCall.video);
}
async function setupPeerConnection(createOffer=false,withVideo=false){
  peerConnection=new RTCPeerConnection(rtcConfig);
  
  try{
    const constraints={audio:true,video:withVideo?{width:{ideal:1280},height:{ideal:720},facingMode:'user'}:false};
    localStream=await navigator.mediaDevices.getUserMedia(constraints);
    localStream.getTracks().forEach(t=>peerConnection.addTrack(t,localStream));
    
    if(withVideo){
      document.getElementById('local-video').srcObject=localStream;
      document.getElementById('call-overlay').classList.add('video-mode');
      document.getElementById('btn-video').classList.add('active');
    }
  }catch(e){
    console.error('Media error:',e);
    toast('Нет доступа к '+(withVideo?'камере/микрофону':'микрофону'),'error');
    endCall();
    return;
  }
  
  peerConnection.ontrack=e=>{
    console.log('📥 Got remote track:',e.track.kind);
    if(e.track.kind==='video'){
      document.getElementById('remote-video').srcObject=e.streams[0];
      document.getElementById('call-overlay').classList.add('video-mode');
    }else{
      document.getElementById('remote-audio').srcObject=e.streams[0];
    }
  };
  
  peerConnection.onicecandidate=e=>{
    if(e.candidate){
      ws.send(JSON.stringify({type:'rtc_ice',callId:currentCall.callId,to:currentCall.to||currentCall.from,candidate:e.candidate}));
    }
  };
  
  peerConnection.onconnectionstatechange=()=>{
    console.log('📶 Connection:',peerConnection.connectionState);
    if(peerConnection.connectionState==='connected'){
      startCallTimer();
      document.getElementById('call-quality').style.display='flex';
    }else if(peerConnection.connectionState==='failed'||peerConnection.connectionState==='disconnected'){
      toast('Соединение потеряно','error');
    }
  };
  
  if(createOffer){
    const offer=await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    ws.send(JSON.stringify({type:'rtc_offer',callId:currentCall.callId,to:currentCall.to,offer}));
  }
}
async function onOffer(m){
  if(!peerConnection)await setupPeerConnection(false,m.video);
  await peerConnection.setRemoteDescription(new RTCSessionDescription(m.offer));
  const answer=await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  ws.send(JSON.stringify({type:'rtc_answer',callId:currentCall.callId,to:currentCall.from||m.from,answer}));
}
async function onAnswer(m){
  if(peerConnection)await peerConnection.setRemoteDescription(new RTCSessionDescription(m.answer));
}
function onIce(m){
  if(peerConnection&&m.candidate)peerConnection.addIceCandidate(new RTCIceCandidate(m.candidate)).catch(console.error);
}
function startCallTimer(){
  document.getElementById('call-avatar').classList.remove('ringing');
  document.getElementById('call-status').style.display='none';
  document.getElementById('call-timer').classList.add('active');
  callSec=0;
  if(callTimer)clearInterval(callTimer);
  callTimer=setInterval(()=>{
    callSec++;
    const m=Math.floor(callSec/60);
    const s=callSec%60;
    document.getElementById('call-timer').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  },1000);
}

// Call controls
function toggleMute(){
  const btn=document.getElementById('btn-mute');
  btn.classList.toggle('active');
  if(localStream)localStream.getAudioTracks().forEach(t=>t.enabled=!btn.classList.contains('active'));
}

async function toggleVideo(){
  const btn=document.getElementById('btn-video');
  const overlay=document.getElementById('call-overlay');
  
  if(btn.classList.contains('active')){
    // Turn off video
    if(localStream){
      localStream.getVideoTracks().forEach(t=>{t.stop();localStream.removeTrack(t)});
    }
    btn.classList.remove('active');
    btn.classList.add('off');
    document.getElementById('local-video-container').classList.add('hidden');
    if(!document.getElementById('remote-video').srcObject?.getVideoTracks()?.length){
      overlay.classList.remove('video-mode');
    }
  }else{
    // Turn on video
    try{
      const videoStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:'user'}});
      const videoTrack=videoStream.getVideoTracks()[0];
      localStream.addTrack(videoTrack);
      if(peerConnection){
        const sender=peerConnection.getSenders().find(s=>s.track?.kind==='video');
        if(sender)await sender.replaceTrack(videoTrack);
        else peerConnection.addTrack(videoTrack,localStream);
      }
      document.getElementById('local-video').srcObject=localStream;
      document.getElementById('local-video-container').classList.remove('hidden');
      btn.classList.add('active');
      btn.classList.remove('off');
      overlay.classList.add('video-mode');
    }catch(e){
      toast('Нет доступа к камере','error');
    }
  }
}

let screenStream=null;
async function toggleScreenShare(){
  const btn=document.getElementById('btn-screen');
  const indicator=document.getElementById('screen-share-indicator');
  
  if(btn.classList.contains('active')){
    // Stop screen share
    if(screenStream){
      screenStream.getTracks().forEach(t=>t.stop());
      screenStream=null;
    }
    btn.classList.remove('active');
    indicator.classList.remove('active');
    // Restore camera or nothing
    if(localStream){
      const videoTrack=localStream.getVideoTracks()[0];
      if(videoTrack&&peerConnection){
        const sender=peerConnection.getSenders().find(s=>s.track?.kind==='video');
        if(sender)await sender.replaceTrack(videoTrack);
      }
    }
  }else{
    // Start screen share
    try{
      screenStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
      const screenTrack=screenStream.getVideoTracks()[0];
      
      screenTrack.onended=()=>{
        btn.classList.remove('active');
        indicator.classList.remove('active');
        screenStream=null;
      };
      
      if(peerConnection){
        const sender=peerConnection.getSenders().find(s=>s.track?.kind==='video');
        if(sender)await sender.replaceTrack(screenTrack);
        else peerConnection.addTrack(screenTrack,screenStream);
      }
      
      btn.classList.add('active');
      indicator.classList.add('active');
      toast('Демонстрация экрана включена','success');
    }catch(e){
      console.error('Screen share error:',e);
      if(e.name!=='NotAllowedError')toast('Не удалось поделиться экраном','error');
    }
  }
}

function toggleSpeaker(){
  const btn=document.getElementById('btn-speaker');
  btn.classList.toggle('active');
  // In web, speaker output is handled by browser
  toast(btn.classList.contains('active')?'Громкая связь':'Динамик','success');
}

function endCall(){
  if(currentCall)ws.send(JSON.stringify({type:'end_call',callId:currentCall.callId,to:currentCall.to||currentCall.from}));
  cleanupCall();
}
function onCallEnded(){cleanupCall();toast('Звонок завершён','success')}
function cleanupCall(){
  stopCallSound();
  if(callTimer){clearInterval(callTimer);callTimer=null;}
  if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}
  if(screenStream){screenStream.getTracks().forEach(t=>t.stop());screenStream=null;}
  if(peerConnection){peerConnection.close();peerConnection=null;}
  currentCall=null;
  callSec=0;
  const overlay=document.getElementById('call-overlay');
  if(overlay){
    overlay.classList.remove('active','video-mode','incoming');
  }
  document.getElementById('screen-share-indicator')?.classList.remove('active');
  document.getElementById('call-effects').innerHTML='';
  document.getElementById('local-video').srcObject=null;
  document.getElementById('remote-video').srcObject=null;
  document.getElementById('remote-audio').srcObject=null;
  const status=document.getElementById('call-status');
  if(status)status.style.display='';
  const timer=document.getElementById('call-timer');
  if(timer)timer.classList.remove('active');
}

// Call particles effect
function createCallParticles(){
  const container=document.getElementById('call-effects');
  container.innerHTML='';
  for(let i=0;i<15;i++){
    const p=document.createElement('div');
    p.className='call-particle';
    p.style.left=Math.random()*100+'%';
    p.style.animationDelay=Math.random()*3+'s';
    p.style.animationDuration=(2+Math.random()*2)+'s';
    container.appendChild(p);
  }
}
function openModal(name){document.getElementById('modal-'+name)?.classList.add('active')}
function closeModal(name){document.getElementById('modal-'+name)?.classList.remove('active')}
function closeAllModals(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'))}
document.querySelectorAll('.modal').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active')})});
function showScreen(name){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(name)?.classList.add('active')}
function initials(name){return(name||'?').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase()}
function esc(str){const div=document.createElement('div');div.textContent=str||'';return div.innerHTML}
function formatText(text){if(!text)return'';return esc(text).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" style="color:inherit;text-decoration:underline">$1</a>')}
function formatTime(date){const d=new Date(date);const now=new Date();if(d.toDateString()===now.toDateString())return d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});return d.toLocaleDateString('ru',{day:'numeric',month:'short'})}
function formatDate(date){const d=new Date(date);const now=new Date();if(d.toDateString()===now.toDateString())return'Сегодня';const yesterday=new Date(now);yesterday.setDate(yesterday.getDate()-1);if(d.toDateString()===yesterday.toDateString())return'Вчера';return d.toLocaleDateString('ru',{day:'numeric',month:'long'})}
function scrollBottom(){const msgs=document.getElementById('messages');setTimeout(()=>msgs.scrollTop=msgs.scrollHeight,10)}
function scrollToMsg(id){const el=document.querySelector(`[data-id="${id}"]`);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.background='rgba(99,102,241,0.2)';setTimeout(()=>el.style.background='',1000)}}
function autoGrow(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px'}
function toast(msg,type='success'){
  const t=document.getElementById('toast');
  t.querySelector('.toast-icon').textContent=type==='success'?'✓':'✕';
  t.querySelector('.toast-text').textContent=msg;
  t.className='toast '+type+' active';
  clearTimeout(window.toastTimer);
  window.toastTimer=setTimeout(()=>{t.classList.remove('active')},2500);
}
function showConfetti(){const colors=['#6366f1','#ec4899','#10b981','#f59e0b','#06b6d4','#a855f7'];for(let i=0;i<50;i++){const el=document.createElement('div');el.className='confetti';el.style.left=Math.random()*100+'%';el.style.background=colors[Math.floor(Math.random()*colors.length)];el.style.animationDelay=Math.random()*0.5+'s';el.style.animationDuration=2+Math.random()+'s';document.body.appendChild(el);setTimeout(()=>el.remove(),3000)}}
document.addEventListener('click',e=>{const btn=e.target.closest('.btn-primary');if(btn){const ripple=document.createElement('span');ripple.className='ripple';const rect=btn.getBoundingClientRect();ripple.style.left=e.clientX-rect.left+'px';ripple.style.top=e.clientY-rect.top+'px';btn.appendChild(ripple);setTimeout(()=>ripple.remove(),600)}});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeAllModals()});

// Premium System
let selectedEffect = null;
let secretTimer = 60;
let userInventory = JSON.parse(localStorage.getItem('mini_inventory') || '{"items":[],"active":{}}');

const STICKER_PACKS = {
  free: { name: 'Базовые', icon: '😀', stickers: ['😀','😂','🥰','😎','🤔','👍','❤️','🔥','✨','🎉','💯','🙏'] },
  pack_cats: { name: 'Котики', icon: '😺', stickers: ['😺','😸','😹','😻','😼','😽','🙀','😿','😾','🐱','🐈','🐈‍⬛'], price: 50 },
  pack_love: { name: 'Любовь', icon: '💕', stickers: ['💕','💖','💗','💓','💝','💘','💞','💟','❣️','💑','💏','🥰'], price: 50 },
  pack_memes: { name: 'Мемы', icon: '🤣', stickers: ['🤣','💀','🗿','🤡','👀','🥶','🥵','😈','👽','🤖','💩','🐸'], price: 60 },
  pack_anime: { name: 'Аниме', icon: '🌸', stickers: ['🌸','⭐','🌙','🎀','🎭','🗡️','🔮','🎐','🏮','🍡','🍙','🎌'], price: 70 },
  pack_food: { name: 'Еда', icon: '🍕', stickers: ['🍕','🍔','🍟','🌭','🍿','🧁','🍩','🍪','🍫','🍰','🎂','🍦'], price: 40 },
  pack_sports: { name: 'Спорт', icon: '⚽', stickers: ['⚽','🏀','🏈','⚾','🎾','🏐','🏓','🏸','🥊','🏆','🥇','🎯'], price: 45 },
  pack_animals: { name: 'Зверята', icon: '🐶', stickers: ['🐶','🐱','🐭','🐹','🐰','🦊','🐻','🐼','🐨','🐯','🦁','🐮'], price: 55 },
  pack_party: { name: 'Вечеринка', icon: '🎉', stickers: ['🎉','🎊','🎈','🎁','🎀','🪅','🎆','🎇','🧨','🎤','🎧','🎵'], price: 50 }
};

const EFFECTS = {
  hearts: { particles: ['❤️','💕','💖','💗','💓'], count: 8 },
  confetti: { particles: ['🎊','🎉','✨','⭐','🌟'], count: 12 },
  sparkle: { particles: ['✨','⭐','💫','🌟','✦'], count: 10 },
  fire: { particles: ['🔥','🔥','💥','⚡','✨'], count: 8 },
  snow: { particles: ['❄️','❄️','🌨️','☃️','⛄'], count: 10 },
  stars: { particles: ['⭐','🌟','✨','💫','⭐'], count: 10 },
  rainbow: { particles: ['🌈','✨','💜','💙','💚','💛','🧡','❤️'], count: 12 },
  ghost: { particles: ['👻','👻','💀','🦇','🕸️'], count: 8 }
};

const PREMIUM_ITEMS = {
  premium: { name: 'Premium подписка', icon: '👑', price: 500, type: 'subscription' },
  invisible: { name: 'Режим невидимки', icon: '👻', price: 200, type: 'feature' },
  schedule: { name: 'Отложенные сообщения', icon: '⏰', price: 150, type: 'feature' },
  secret: { name: 'Секретные чаты', icon: '🔐', price: 250, type: 'feature' },
  voice_text: { name: 'Голос в текст', icon: '🎤', price: 100, type: 'feature' },
  stats: { name: 'Статистика', icon: '📊', price: 80, type: 'feature' },
  big_files: { name: 'Файлы 100мб', icon: '📁', price: 120, type: 'feature' },
  custom_emoji: { name: 'Свои эмодзи', icon: '😎', price: 180, type: 'feature' },
  effect_hearts: { name: 'Эффект сердечки', icon: '❤️', price: 30, type: 'effect' },
  effect_confetti: { name: 'Эффект конфетти', icon: '🎊', price: 30, type: 'effect' },
  effect_sparkle: { name: 'Эффект искры', icon: '✨', price: 35, type: 'effect' },
  effect_fire: { name: 'Эффект огонь', icon: '🔥', price: 40, type: 'effect' },
  effect_snow: { name: 'Эффект снежинки', icon: '❄️', price: 35, type: 'effect' },
  effect_stars: { name: 'Эффект звёзды', icon: '⭐', price: 45, type: 'effect' },
  effect_rainbow: { name: 'Эффект радуга', icon: '🌈', price: 50, type: 'effect' },
  effect_ghost: { name: 'Эффект призраки', icon: '👻', price: 60, type: 'effect' },
  bg_gradient: { name: 'Фон градиент', icon: '🎨', price: 25, type: 'background' },
  bg_particles: { name: 'Фон частицы', icon: '✦', price: 35, type: 'background' },
  bg_stars: { name: 'Фон звёзды', icon: '🌟', price: 40, type: 'background' }
};

function switchShopTab(tab, btn) {
  document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.shop-section').forEach(s => s.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('shop-' + tab).classList.add('active');
  updateShopItems();
}

function updateShopItems() {
  document.querySelectorAll('.shop-item').forEach(item => {
    const id = item.onclick?.toString().match(/'([^']+)'/)?.[1];
    if (id && userInventory.items.includes(id)) {
      item.classList.add('owned');
    }
  });
}

function openShop() {
  document.getElementById('shop-balance').textContent = `⭐ ${user?.balance || 0} звёзд`;
  updateShopItems();
  openModal('shop');
}

async function buyPremiumItem(id, name, price) {
  if (userInventory.items.includes(id)) {
    // Если уже куплено и это обои - применить
    if (id.startsWith('bg_')) {
      applyPurchasedWallpaper(id);
      toast('Обои применены! ✓', 'success');
    } else {
      toast('Уже куплено!', 'success');
    }
    return;
  }
  if ((user?.balance || 0) < price) {
    toast('Недостаточно звёзд!', 'error');
    openModal('get-stars');
    closeModal('shop');
    return;
  }
  try {
    const r = await api('/api/user/buy', { method: 'POST', body: JSON.stringify({ itemId: id, price }) });
    user.balance = r.balance;
    userInventory.items.push(id);
    localStorage.setItem('mini_inventory', JSON.stringify(userInventory));
    document.getElementById('shop-balance').textContent = `⭐ ${user.balance} звёзд`;
    updateShopItems();
    toast(`${name} куплено! ✓`, 'success');
    showConfetti();
    // Автоматически применяем обои при покупке
    if (id.startsWith('bg_')) {
      applyPurchasedWallpaper(id);
    }
  } catch (e) {
    toast(e.message, 'error');
  }
}

async function earnStars(type) {
  switch(type) {
    case 'daily':
      try {
        const r = await api('/api/user/daily', { method: 'POST' });
        user.balance = r.balance;
        toast(`+${r.earned} ⭐ ежедневный бонус!`, 'success');
        showConfetti();
      } catch (e) {
        toast(e.message || 'Бонус уже получен сегодня', 'error');
      }
      break;
    case 'invite':
      const link = `${location.origin}?ref=${user.username}`;
      navigator.clipboard?.writeText(link);
      toast('Ссылка скопирована! Поделитесь с друзьями', 'success');
      break;
    case 'games':
      startChat('gamebot');
      closeAllModals();
      break;
    case 'watch':
      toast('Реклама временно недоступна', 'error');
      break;
    case 'buy100':
    case 'buy500':
    case 'buy1000':
      toast('Покупки временно недоступны', 'error');
      break;
  }
  closeModal('get-stars');
}

function openStickers() {
  const tabsEl = document.getElementById('sticker-pack-tabs');
  const gridEl = document.getElementById('sticker-pack-grid');
  
  tabsEl.innerHTML = Object.entries(STICKER_PACKS).map(([id, pack]) => {
    const owned = id === 'free' || userInventory.items.includes(id);
    return `<button class="sticker-pack-tab ${id === 'free' ? 'active' : ''} ${owned ? '' : 'locked'}" onclick="selectStickerPack('${id}',this)">${pack.icon}</button>`;
  }).join('');
  
  selectStickerPack('free', tabsEl.querySelector('.sticker-pack-tab'));
  openModal('stickers');
}

function selectStickerPack(packId, btn) {
  const pack = STICKER_PACKS[packId];
  const owned = packId === 'free' || userInventory.items.includes(packId);
  
  document.querySelectorAll('.sticker-pack-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  
  const gridEl = document.getElementById('sticker-pack-grid');
  gridEl.innerHTML = pack.stickers.map(s => 
    `<div class="sticker-item ${owned ? '' : 'locked'}" onclick="${owned ? `sendSticker('${s}')` : `toast('Купите пак в магазине','error')`}">${s}</div>`
  ).join('');
}

function sendSticker(sticker) {
  if (!currentChat) return;
  ws.send(JSON.stringify({ type: 'send_message', chatId: currentChat, text: sticker, isSticker: true, effect: selectedEffect }));
  closeModal('stickers');
}

function openEffects() {
  document.querySelectorAll('.effect-item').forEach(item => {
    item.classList.toggle('active', item.onclick?.toString().includes(`'${selectedEffect}'`));
  });
  openModal('effects');
}

function selectEffect(effect) {
  if (effect && !userInventory.items.includes('effect_' + effect) && !user?.premium) {
    toast('Купите эффект в магазине или Premium', 'error');
    return;
  }
  selectedEffect = effect;
  document.querySelectorAll('.effect-item').forEach(item => {
    const itemEffect = item.onclick?.toString().match(/'([^']+)'/)?.[1];
    item.classList.toggle('active', itemEffect === effect || (effect === null && item.onclick?.toString().includes('null')));
  });
  toast(effect ? `Эффект "${effect}" выбран` : 'Эффект отключён', 'success');
  closeModal('effects');
}

function renderMessageEffect(msgEl, effect) {
  if (!effect || !EFFECTS[effect]) return;
  const particles = document.createElement('div');
  particles.className = 'effect-particles';
  const config = EFFECTS[effect];
  
  for (let i = 0; i < config.count; i++) {
    const p = document.createElement('span');
    p.className = 'effect-particle';
    p.textContent = config.particles[Math.floor(Math.random() * config.particles.length)];
    p.style.left = Math.random() * 100 + '%';
    p.style.top = Math.random() * 100 + '%';
    p.style.animationDelay = Math.random() * 0.5 + 's';
    particles.appendChild(p);
  }
  
  msgEl.appendChild(particles);
  setTimeout(() => particles.remove(), 2500);
}

function openSchedule() {
  if (!userInventory.items.includes('schedule') && !user?.premium) {
    toast('Купите функцию в магазине или Premium', 'error');
    openShop();
    return;
  }
  const now = new Date();
  now.setMinutes(now.getMinutes() + 30);
  document.getElementById('schedule-datetime').value = now.toISOString().slice(0, 16);
  document.getElementById('schedule-text').value = '';
  openModal('schedule');
}

function setQuickSchedule(minutes) {
  const date = new Date();
  date.setMinutes(date.getMinutes() + minutes);
  document.getElementById('schedule-datetime').value = date.toISOString().slice(0, 16);
}

async function scheduleMessage() {
  const datetime = document.getElementById('schedule-datetime').value;
  const text = document.getElementById('schedule-text').value.trim();
  
  if (!datetime || !text) {
    toast('Заполните все поля', 'error');
    return;
  }
  
  const scheduleTime = new Date(datetime).getTime();
  if (scheduleTime <= Date.now()) {
    toast('Выберите время в будущем', 'error');
    return;
  }
  
  ws.send(JSON.stringify({ type: 'schedule_message', chatId: currentChat, text, scheduleTime }));
  toast('Сообщение запланировано! ⏰', 'success');
  closeModal('schedule');
}

function openStats() {
  if (!userInventory.items.includes('stats') && !user?.premium) {
    toast('Купите функцию в магазине или Premium', 'error');
    openShop();
    return;
  }
  
  document.getElementById('stat-messages').textContent = user?.stats?.messages || 0;
  document.getElementById('stat-chats').textContent = chats.length;
  document.getElementById('stat-streak').textContent = user?.dailyStreak || 0;
  document.getElementById('stat-level').textContent = user?.level || 1;
  
  const xp = user?.xp || 0;
  const nextLevel = (user?.level || 1) * 100;
  document.getElementById('stat-xp-fill').style.width = (xp / nextLevel * 100) + '%';
  document.getElementById('stat-xp-text').textContent = `${xp}/${nextLevel} XP`;
  
  // Weekly chart
  const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
  const chartData = user?.weeklyMessages || [5, 12, 8, 15, 20, 10, 7];
  const maxVal = Math.max(...chartData, 1);
  
  document.getElementById('stats-chart').innerHTML = '<div style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--text2)">Сообщений за неделю</div>' +
    chartData.map((val, i) => `
      <div class="stats-chart-bar">
        <div class="stats-chart-label">${days[i]}</div>
        <div class="stats-chart-fill" style="width:${val/maxVal*100}%"></div>
        <div class="stats-chart-value">${val}</div>
      </div>
    `).join('');
  
  openModal('stats');
}

function openSecretChat() {
  if (!userInventory.items.includes('secret') && !user?.premium) {
    toast('Купите функцию в магазине или Premium', 'error');
    openShop();
    return;
  }
  document.getElementById('secret-username').value = '';
  openModal('secret');
}

function setSecretTimer(seconds) {
  secretTimer = seconds;
  document.querySelectorAll('.timer-opt').forEach(btn => {
    btn.classList.toggle('active', btn.onclick?.toString().includes(seconds.toString()));
  });
}

async function startSecretChat() {
  const username = document.getElementById('secret-username').value.trim();
  if (!username) {
    toast('Введите username', 'error');
    return;
  }
  
  ws.send(JSON.stringify({ type: 'start_secret_chat', username, timer: secretTimer }));
  toast('Секретный чат создан! 🔐', 'success');
  closeModal('secret');
}

function openInventory() {
  renderInventory('items');
  openModal('inventory');
}

function switchInvTab(tab, btn) {
  document.querySelectorAll('.inv-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderInventory(tab);
}

function renderInventory(tab) {
  const content = document.getElementById('inventory-content');
  
  if (tab === 'items') {
    const items = userInventory.items.map(id => PREMIUM_ITEMS[id] || STICKER_PACKS[id]).filter(Boolean);
    if (items.length === 0) {
      content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">Пока пусто 😢<br><br><button class="btn btn-primary" onclick="openShop();closeModal(\'inventory\')">В магазин</button></div>';
      return;
    }
    content.innerHTML = '<div class="inv-grid">' + userInventory.items.map(id => {
      const item = PREMIUM_ITEMS[id] || STICKER_PACKS[id];
      if (!item) return '';
      const isActive = userInventory.active[item.type] === id;
      return `<div class="inv-item ${isActive ? 'active' : ''}" onclick="activateItem('${id}')"><div class="inv-item-icon">${item.icon}</div><div class="inv-item-name">${item.name}</div></div>`;
    }).join('') + '</div>';
  } else {
    const activeItems = Object.entries(userInventory.active).map(([type, id]) => {
      const item = PREMIUM_ITEMS[id];
      return item ? `<div class="inv-item active"><div class="inv-item-icon">${item.icon}</div><div class="inv-item-name">${item.name}</div></div>` : '';
    }).filter(Boolean);
    
    if (activeItems.length === 0) {
      content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">Нет активных предметов</div>';
      return;
    }
    content.innerHTML = '<div class="inv-grid">' + activeItems.join('') + '</div>';
  }
}

function activateItem(id) {
  const item = PREMIUM_ITEMS[id];
  if (!item) return;
  
  if (userInventory.active[item.type] === id) {
    delete userInventory.active[item.type];
    toast(`${item.name} деактивирован`, 'success');
  } else {
    userInventory.active[item.type] = id;
    toast(`${item.name} активирован! ✓`, 'success');
  }
  
  localStorage.setItem('mini_inventory', JSON.stringify(userInventory));
  renderInventory('items');
  applyActiveItems();
}

function applyActiveItems() {
  const messages = document.getElementById('messages');
  messages.classList.remove('chat-bg-gradient', 'chat-bg-particles', 'chat-bg-stars');
  
  if (userInventory.active.background) {
    const bgClass = userInventory.active.background.replace('bg_', 'chat-bg-');
    messages.classList.add(bgClass);
  }
}

// Enhanced settings menu
function openPremiumMenu() {
  openModal('premium-menu');
}

// ========== SOUNDS ==========
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
  if (user?.sounds === false) return;
  const sounds = {
    message: [523.25, 659.25, 783.99], // C5, E5, G5
    notification: [783.99, 880, 987.77], // G5, A5, B5
    call: [440, 523.25, 440, 523.25] // A4, C5 repeating
  };
  const freqs = sounds[type] || sounds.notification;
  freqs.forEach((freq, i) => {
    setTimeout(() => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.2);
    }, i * 100);
  });
}

let callSoundInterval = null;
// Ringtone using Web Audio API
let ringtoneContext=null;
let ringtoneOscillator=null;
let ringtoneGain=null;
let ringtoneInterval=null;

function playCallSound() {
  stopCallSound();
  
  try {
    ringtoneContext = new (window.AudioContext || window.webkitAudioContext)();
    ringtoneGain = ringtoneContext.createGain();
    ringtoneGain.connect(ringtoneContext.destination);
    ringtoneGain.gain.value = 0.3;
    
    // Create ringtone pattern
    const playTone = () => {
      if (!ringtoneContext) return;
      
      // Two-tone ring like phone
      const osc1 = ringtoneContext.createOscillator();
      const osc2 = ringtoneContext.createOscillator();
      const gainNode = ringtoneContext.createGain();
      
      osc1.type = 'sine';
      osc2.type = 'sine';
      osc1.frequency.value = 440; // A4
      osc2.frequency.value = 480; // Slightly higher
      
      osc1.connect(gainNode);
      osc2.connect(gainNode);
      gainNode.connect(ringtoneGain);
      
      // Envelope
      gainNode.gain.setValueAtTime(0, ringtoneContext.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.5, ringtoneContext.currentTime + 0.1);
      gainNode.gain.linearRampToValueAtTime(0.3, ringtoneContext.currentTime + 0.3);
      gainNode.gain.linearRampToValueAtTime(0, ringtoneContext.currentTime + 0.8);
      
      osc1.start(ringtoneContext.currentTime);
      osc2.start(ringtoneContext.currentTime);
      osc1.stop(ringtoneContext.currentTime + 0.8);
      osc2.stop(ringtoneContext.currentTime + 0.8);
      
      // Second ring
      setTimeout(() => {
        if (!ringtoneContext) return;
        const osc3 = ringtoneContext.createOscillator();
        const osc4 = ringtoneContext.createOscillator();
        const gainNode2 = ringtoneContext.createGain();
        
        osc3.type = 'sine';
        osc4.type = 'sine';
        osc3.frequency.value = 440;
        osc4.frequency.value = 480;
        
        osc3.connect(gainNode2);
        osc4.connect(gainNode2);
        gainNode2.connect(ringtoneGain);
        
        gainNode2.gain.setValueAtTime(0, ringtoneContext.currentTime);
        gainNode2.gain.linearRampToValueAtTime(0.5, ringtoneContext.currentTime + 0.1);
        gainNode2.gain.linearRampToValueAtTime(0.3, ringtoneContext.currentTime + 0.3);
        gainNode2.gain.linearRampToValueAtTime(0, ringtoneContext.currentTime + 0.8);
        
        osc3.start(ringtoneContext.currentTime);
        osc4.start(ringtoneContext.currentTime);
        osc3.stop(ringtoneContext.currentTime + 0.8);
        osc4.stop(ringtoneContext.currentTime + 0.8);
      }, 200);
    };
    
    playTone();
    ringtoneInterval = setInterval(playTone, 3000);
    
  } catch(e) {
    console.error('Ringtone error:', e);
    // Fallback to simple sound
    ringtoneInterval = setInterval(() => playSound('call'), 2000);
    playSound('call');
  }
}

function stopCallSound() {
  if (ringtoneInterval) {
    clearInterval(ringtoneInterval);
    ringtoneInterval = null;
  }
  if (ringtoneContext) {
    try {
      ringtoneContext.close();
    } catch(e) {}
    ringtoneContext = null;
    ringtoneGain = null;
  }
  if (callSoundInterval) {
    clearInterval(callSoundInterval);
    callSoundInterval = null;
  }
}

// ========== WALLPAPERS ==========
const WALLPAPERS = [
  { id: 'none', name: 'Без обоев', preview: '#1e293b' },
  { id: 'gradient1', name: 'Фиолет', preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
  { id: 'gradient2', name: 'Розовый', preview: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
  { id: 'gradient3', name: 'Голубой', preview: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
  { id: 'gradient4', name: 'Зелёный', preview: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' },
  { id: 'gradient5', name: 'Закат', preview: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
  { id: 'live1', name: 'Живой 1', preview: 'linear-gradient(270deg, #ee7752, #e73c7e, #23a6d5, #23d5ab)', live: true },
  { id: 'live2', name: 'Живой 2', preview: 'linear-gradient(270deg, #12c2e9, #c471ed, #f64f59)', live: true },
  { id: 'live3', name: 'Живой 3', preview: 'linear-gradient(270deg, #667eea, #764ba2, #f093fb)', live: true },
];

function renderWallpapers() {
  const container = document.getElementById('wallpaper-grid');
  if (!container) return;
  const current = localStorage.getItem('mini_wallpaper') || 'none';
  container.innerHTML = WALLPAPERS.map(w => `
    <div class="wallpaper-item ${w.id === current ? 'active' : ''} ${w.live ? 'live' : ''}" 
         style="background: ${w.preview}" 
         onclick="setWallpaper('${w.id}')" 
         title="${w.name}">
    </div>
  `).join('') + `
    <div class="wallpaper-item wallpaper-upload" onclick="document.getElementById('wallpaper-input').click()">
      📷<span style="font-size:10px">Своё</span>
    </div>
  `;
}

function setWallpaper(id) {
  localStorage.setItem('mini_wallpaper', id);
  applyWallpaper();
  renderWallpapers();
  toast('Обои применены!', 'success');
}

function applyWallpaper() {
  const id = localStorage.getItem('mini_wallpaper') || 'none';
  const msgs = document.getElementById('messages');
  if (!msgs) return;
  
  msgs.style.animation = '';
  msgs.classList.remove('has-wallpaper');
  
  // Магазинные обои
  const shopWallpapers = {
    'bg_gradient': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    'bg_particles': 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)',
    'bg_waves': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    'bg_stars': 'linear-gradient(to bottom, #0f0c29 0%, #302b63 50%, #24243e 100%)',
    'bg_matrix': 'linear-gradient(180deg, #001a00 0%, #003300 50%, #001a00 100%)',
    'bg_space': 'linear-gradient(to bottom, #000428 0%, #004e92 100%)',
    'bg_neon': 'linear-gradient(135deg, #ff00ff 0%, #00ffff 50%, #ff00ff 100%)',
    'bg_sunset': 'linear-gradient(to bottom, #ff512f 0%, #f09819 50%, #dd2476 100%)'
  };
  
  if (shopWallpapers[id]) {
    msgs.style.background = shopWallpapers[id];
    msgs.classList.add('has-wallpaper');
    if (id === 'bg_neon' || id === 'bg_particles') {
      msgs.style.backgroundSize = '400% 400%';
      msgs.style.animation = 'liveBg 15s ease infinite';
    }
    return;
  }
  
  const wp = WALLPAPERS.find(w => w.id === id);
  
  if (!wp || id === 'none') {
    msgs.style.background = 'var(--bg)';
  } else if (wp.live) {
    msgs.style.background = wp.preview;
    msgs.style.backgroundSize = '400% 400%';
    msgs.style.animation = 'liveBg 15s ease infinite';
    msgs.classList.add('has-wallpaper');
  } else {
    msgs.style.background = wp.preview;
    msgs.classList.add('has-wallpaper');
  }
  
  // Custom wallpaper
  const custom = localStorage.getItem('mini_wallpaper_custom');
  if (id === 'custom' && custom) {
    msgs.style.background = `url(${custom}) center/cover`;
    msgs.classList.add('has-wallpaper');
  }
}

function handleCustomWallpaper(inp) {
  const file = inp.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    localStorage.setItem('mini_wallpaper', 'custom');
    localStorage.setItem('mini_wallpaper_custom', e.target.result);
    applyWallpaper();
    toast('Свои обои установлены!', 'success');
  };
  reader.readAsDataURL(file);
}

// Применить купленные обои из магазина
function applyPurchasedWallpaper(itemId) {
  const shopWallpapers = {
    'bg_gradient': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    'bg_particles': 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%)',
    'bg_waves': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    'bg_stars': 'linear-gradient(to bottom, #0f0c29 0%, #302b63 50%, #24243e 100%)',
    'bg_matrix': 'linear-gradient(180deg, #001a00 0%, #003300 50%, #001a00 100%)',
    'bg_space': 'linear-gradient(to bottom, #000428 0%, #004e92 100%)',
    'bg_neon': 'linear-gradient(135deg, #ff00ff 0%, #00ffff 50%, #ff00ff 100%)',
    'bg_sunset': 'linear-gradient(to bottom, #ff512f 0%, #f09819 50%, #dd2476 100%)'
  };
  
  const bg = shopWallpapers[itemId];
  if (!bg) return;
  
  const msgs = document.getElementById('messages');
  if (!msgs) return;
  
  msgs.style.animation = '';
  msgs.classList.add('has-wallpaper');
  
  if (itemId === 'bg_neon' || itemId === 'bg_particles') {
    msgs.style.background = bg;
    msgs.style.backgroundSize = '400% 400%';
    msgs.style.animation = 'liveBg 15s ease infinite';
  } else {
    msgs.style.background = bg;
  }
  
  localStorage.setItem('mini_wallpaper', itemId);
  localStorage.setItem('mini_wallpaper_shop', itemId);
}

// ========== CIRCLE VIDEO MESSAGES ==========
let circleStream = null;
let circleRecorder = null;
let circleTimer = null;
let circleSec = 0;

async function startCircleRecord() {
  try {
    circleStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 480, height: 480 }, audio: true });
    const preview = document.getElementById('circle-preview-video');
    if (preview) preview.srcObject = circleStream;
    document.getElementById('circle-overlay')?.classList.add('active');
    circleSec = 0;
    document.getElementById('circle-timer').textContent = '0:00';
    circleTimer = setInterval(() => {
      circleSec++;
      document.getElementById('circle-timer').textContent = `${Math.floor(circleSec / 60)}:${(circleSec % 60).toString().padStart(2, '0')}`;
      if (circleSec >= 60) stopCircle();
    }, 1000);
    circleRecorder = new MediaRecorder(circleStream, { mimeType: 'video/webm' });
    const chunks = [];
    circleRecorder.ondataavailable = e => chunks.push(e.data);
    circleRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const reader = new FileReader();
      reader.onload = () => {
        if (currentChat && ws) {
          ws.send(JSON.stringify({ type: 'send_message', chatId: currentChat.id, circle: reader.result, circleDuration: circleSec }));
        }
      };
      reader.readAsDataURL(blob);
    };
    circleRecorder.start();
  } catch (e) { toast('Нет доступа к камере', 'error'); }
}

function stopCircle() {
  clearInterval(circleTimer);
  if (circleRecorder && circleRecorder.state === 'recording') circleRecorder.stop();
  if (circleStream) circleStream.getTracks().forEach(t => t.stop());
  document.getElementById('circle-overlay')?.classList.remove('active');
}

function cancelCircle() {
  clearInterval(circleTimer);
  circleRecorder = null;
  if (circleStream) circleStream.getTracks().forEach(t => t.stop());
  document.getElementById('circle-overlay')?.classList.remove('active');
}

function playCircle(el) {
  const video = el.querySelector('video');
  if (!video) return;
  if (video.paused) { video.play(); el.classList.add('playing'); }
  else { video.pause(); el.classList.remove('playing'); }
}

// ========== REFERRAL ==========
function copyReferral() {
  const link = `${location.origin}?ref=${user?.username || 'user'}`;
  navigator.clipboard?.writeText(link);
  toast('Ссылка скопирована! Поделитесь с друзьями для получения +100 ⭐', 'success');
}

// ========== TELEGRAM BOT ==========
function openTelegramBot() {
  window.open('https://t.me/MiniMessengerBot?start=buy_' + (user?.id || ''), '_blank');
  toast('Откройте Telegram бота для покупки звёзд', 'success');
}

// ========== DAILY BONUS ==========
async function claimDaily() {
  try {
    const r = await api('/api/user/daily', { method: 'POST' });
    user.balance = r.balance;
    user.dailyStreak = r.streak;
    document.querySelectorAll('[id*="balance"]').forEach(el => {
      if (el.tagName === 'SPAN' || el.tagName === 'DIV') el.textContent = r.balance + ' ⭐';
    });
    toast(`+${r.earned} ⭐ ежедневный бонус! (серия: ${r.streak} дней)`, 'success');
    showConfetti();
  } catch (e) { toast(e.message || 'Бонус уже получен сегодня', 'error'); }
}

// Init wallpapers on load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(applyWallpaper, 100);
});
</script>

<!-- Hidden inputs -->
<input type="file" id="wallpaper-input" accept="image/*" style="display:none" onchange="handleCustomWallpaper(this)">

<!-- Circle Recording Overlay -->
<div class="circle-record-overlay" id="circle-overlay">
  <div class="circle-preview"><video id="circle-preview-video" autoplay playsinline muted></video></div>
  <div class="circle-timer" id="circle-timer">0:00</div>
  <div class="circle-controls">
    <button class="circle-btn cancel" onclick="cancelCircle()">✕</button>
    <button class="circle-btn stop" onclick="stopCircle()">✓</button>
  </div>
</div>

<style>
/* Circle Recording Styles */
.circle-record-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:1000;align-items:center;justify-content:center;flex-direction:column}
.circle-record-overlay.active{display:flex}
.circle-preview{width:280px;height:280px;border-radius:50%;overflow:hidden;border:4px solid var(--red);animation:circleRecord 1.5s infinite}
.circle-preview video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
.circle-timer{font-size:24px;font-weight:700;color:#fff;margin-top:20px}
.circle-controls{display:flex;gap:20px;margin-top:30px}
.circle-btn{width:60px;height:60px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;color:#fff;transition:all 0.2s}
.circle-btn.stop{background:var(--green)}
.circle-btn.cancel{background:var(--red)}
.circle-btn:hover{transform:scale(1.1)}
@keyframes circleRecord{0%{box-shadow:0 0 0 0 rgba(239,68,68,0.7)}70%{box-shadow:0 0 0 15px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}

/* Wallpaper Grid */
.wallpaper-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
.wallpaper-item{aspect-ratio:9/16;border-radius:12px;cursor:pointer;position:relative;border:3px solid transparent;transition:all 0.2s}
.wallpaper-item:hover{transform:scale(1.02)}
.wallpaper-item.active{border-color:var(--accent)}
.wallpaper-item.active::after{content:'✓';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.wallpaper-item.live::before{content:'LIVE';position:absolute;top:6px;right:6px;padding:2px 6px;background:var(--red);border-radius:4px;font-size:9px;font-weight:700;color:#fff}
.wallpaper-upload{display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--surface2);border:2px dashed var(--border);color:var(--text3);font-size:20px;gap:4px}
.wallpaper-upload:hover{border-color:var(--accent);color:var(--accent)}
@keyframes liveBg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

/* Message Circle (Video) */
.msg-circle{width:200px;height:200px;border-radius:50%;overflow:hidden;cursor:pointer;position:relative;border:3px solid var(--accent)}
.msg-circle video{width:100%;height:100%;object-fit:cover}
.msg-circle::after{content:'▶';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:32px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,0.5);opacity:0.9}
.msg-circle.playing::after{display:none}
</style>
</body>
</html>
